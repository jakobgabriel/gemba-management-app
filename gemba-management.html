<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>Gemba Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* Mobile Safari fixes */
    html {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    body { 
      font-family: 'Balsamiq Sans', cursive; 
      background: #ffffff; 
      color: #1a1a1a;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Login Screen */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f5f5f5;
    }
    .login-card {
      background: white;
      border: 4px solid #000;
      padding: 3rem;
      max-width: 500px;
      width: 90%;
    }
    .login-title {
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 0.5rem;
      letter-spacing: 2px;
    }
    .login-subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 3rem;
    }
    .login-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .login-btn {
      padding: 1.5rem;
      border: 3px solid #000;
      background: white;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    .login-btn:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    .login-btn-primary {
      background: #000;
      color: white;
    }
    .login-btn-primary:hover {
      background: #333;
    }
    
    /* App Container */
    .app-container { display: flex; min-height: 100vh; }
    
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 3px solid #000;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
    }
    .sidebar-header {
      padding: 2rem 1.5rem;
      border-bottom: 3px solid #000;
    }
    .logo {
      font-size: 1.75rem;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .subtitle {
      font-size: 0.85rem;
      margin-top: 0.25rem;
      color: #666;
    }
    .user-info {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 2px dashed #ccc;
      font-size: 0.85rem;
    }
    .sidebar-nav {
      flex: 1;
      padding: 1rem 0;
      overflow-y: auto;
    }
    .nav-section {
      margin-bottom: 2rem;
    }
    .nav-section-title {
      padding: 0.5rem 1.5rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #666;
      font-weight: bold;
    }
    .nav-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 1rem;
      width: 100%;
      text-align: left;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    .nav-item:hover {
      background: #f5f5f5;
      border-left: 3px solid #666;
    }
    .nav-item.active {
      background: #f0f0f0;
      border-left: 3px solid #000;
      font-weight: bold;
    }
    .nav-item.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .sidebar-footer {
      padding: 1rem 1.5rem;
      border-top: 2px dashed #ccc;
    }
    .logout-btn {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #000;
      background: white;
      font-family: 'Balsamiq Sans', cursive;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
    }
    .logout-btn:hover {
      background: #f0f0f0;
    }
    
    /* Main Content */
    .main-container {
      margin-left: 280px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .content-header {
      padding: 1.5rem 2rem;
      border-bottom: 3px solid #000;
      background: #fafafa;
    }
    .content-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }
    .breadcrumb {
      font-size: 0.9rem;
      color: #666;
    }
    .main-content {
      padding: 2rem;
      flex: 1;
    }
    
    /* Cards */
    .card {
      background: white;
      border: 3px solid #000;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px dashed #ccc;
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: 3px solid #000;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    .btn:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    .btn-primary {
      background: #000;
      color: white;
    }
    .btn-primary:hover {
      background: #333;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 3px solid #000;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 1rem;
      background: white;
    }
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin: 2rem 0;
      padding: 1rem;
      border: 2px solid #000;
      background: #fafafa;
    }
    .progress-step {
      flex: 1;
      text-align: center;
      padding: 1rem;
      border: 2px solid #ccc;
      background: white;
      font-weight: bold;
      position: relative;
    }
    .progress-step.active {
      border-color: #000;
      background: #f0f0f0;
    }
    .progress-step.completed {
      background: #e0e0e0;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      border: 4px solid #000;
      padding: 2rem;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      margin-left: 140px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid #000;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .close-btn {
      border: none;
      background: transparent;
      font-size: 2rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-weight: bold;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .data-table th, .data-table td {
      border: 2px solid #000;
      padding: 0.75rem;
      text-align: left;
    }
    .data-table th {
      background: #f0f0f0;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
    }
    .data-table tbody tr:nth-child(even) {
      background: #fafafa;
    }
    
    /* Issue Items */
    .issue-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .issue-item {
      padding: 1rem;
      border: 3px solid #000;
      background: #fafafa;
    }
    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .issue-title {
      font-weight: bold;
      font-size: 1rem;
    }
    .issue-badge {
      padding: 0.25rem 0.75rem;
      border: 2px solid #000;
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .issue-meta {
      font-size: 0.85rem;
      color: #666;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .issue-description {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px dashed #ccc;
      font-size: 0.9rem;
    }
    
    /* Info Box */
    .info-box {
      padding: 1rem;
      border: 2px dashed #000;
      background: #fafafa;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
    .info-box-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
    }
    
    /* Checklist */
    .checklist-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border: 2px solid #000;
      background: white;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #000;
      cursor: pointer;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #999;
      border: 2px dashed #ccc;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .sidebar {
        width: 250px;
      }
      
      .main-container {
        margin-left: 250px;
      }
    }

    @media (max-width: 768px) {
      /* Sidebar becomes top navigation on mobile */
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 3px solid #000;
      }
      
      .sidebar-nav {
        max-height: none;
      }
      
      .main-container {
        margin-left: 0;
      }
      
      .modal {
        margin-left: 0;
        width: 95%;
        padding: 1rem;
      }
      
      .modal-title {
        font-size: 1.2rem;
      }
      
      .content-header h1 {
        font-size: 1.3rem;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .card-title {
        font-size: 0.95rem;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .login-card {
        padding: 2rem 1.5rem;
      }
      
      .login-title {
        font-size: 1.5rem;
      }
      
      .data-table {
        font-size: 0.85rem;
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .data-table th,
      .data-table td {
        padding: 0.5rem;
        white-space: nowrap;
      }
      
      .info-box {
        font-size: 0.85rem;
      }
      
      .info-box > div[style*="grid"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .issue-item {
        padding: 0.75rem;
      }
      
      .issue-title {
        font-size: 0.9rem;
      }
      
      .issue-meta {
        font-size: 0.75rem;
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
      
      .progress-steps {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .progress-step {
        padding: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .content-header {
        padding: 1rem;
      }
      
      .content-header h1 {
        font-size: 1.1rem;
      }
      
      .breadcrumb {
        font-size: 0.75rem;
      }
      
      .main-content {
        padding: 0.75rem;
      }
      
      .card {
        padding: 0.75rem;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
      
      .card-header .btn {
        width: 100%;
      }
      
      .btn {
        width: 100%;
      }
      
      .login-btn {
        padding: 1rem;
        font-size: 0.9rem;
      }
      
      .sidebar-header {
        padding: 1.5rem 1rem;
      }
      
      .logo {
        font-size: 1.5rem;
      }
      
      .nav-item {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      
      .info-box > div[style*="grid"] {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .issue-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }
      
      .issue-badge {
        align-self: flex-start;
      }
      
      .modal {
        width: 98%;
        padding: 1rem;
        max-height: 95vh;
      }
      
      .modal-header {
        margin-bottom: 1rem;
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      .form-label {
        font-size: 0.8rem;
      }
      
      .form-input,
      .form-select,
      .form-textarea {
        padding: 0.6rem;
        font-size: 0.9rem;
      }
      
      .login-options {
        gap: 0.75rem;
      }
    }
    
    /* Hidden */
    .hidden {
      display: none !important;
    }
    
    /* Voice Button */
    .voice-btn {
      transition: all 0.3s ease;
    }
    .voice-btn:hover {
      transform: scale(1.05);
    }
    .voice-btn.recording {
      animation: pulse 1.5s ease-in-out infinite;
    }
    #quick-voice-btn {
      transition: all 0.3s ease;
    }
    #quick-voice-btn.recording {
      animation: pulse-fast 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @keyframes pulse-fast {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: 'Balsamiq Sans', sans-serif;">
      <div style="text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">GEMBA</div>
        <div style="font-size: 1rem; color: #666;">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    // Mobile compatibility polyfills
    if (!Array.prototype.find) {
      Array.prototype.find = function(predicate) {
        for (var i = 0; i < this.length; i++) {
          if (predicate(this[i], i, this)) return this[i];
        }
        return undefined;
      };
    }
    
    if (!Array.prototype.filter) {
      Array.prototype.filter = function(predicate) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          if (predicate(this[i], i, this)) result.push(this[i]);
        }
        return result;
      };
    }
    
    const app = {
      currentUser: null,
      currentView: 'level1',
      currentMachine: null,
      showModal: null,
      modalData: null,
      gembaWalkStep: 1,
      config: {
        machines: [
          { id: 'M-401', name: 'Assembly Line 2 - Station 3', area: 'Production Area A', operator: 'Team Member A', part: 'P-123-A', team: 'Team A' },
          { id: 'M-402', name: 'Assembly Line 2 - Station 1', area: 'Production Area A', operator: 'Team Member B', part: 'P-123-B', team: 'Team A' },
          { id: 'M-403', name: 'Assembly Line 2 - Station 2', area: 'Production Area A', operator: 'Team Member C', part: 'P-123-C', team: 'Team A' },
          { id: 'M-301', name: 'Assembly Line 1 - Station 1', area: 'Production Area A', operator: 'John Smith', part: 'P-123-A', team: 'Team B' },
          { id: 'M-302', name: 'Assembly Line 1 - Station 2', area: 'Production Area A', operator: 'Lisa Chen', part: 'P-123-A', team: 'Team B' },
          { id: 'M-303', name: 'Assembly Line 1 - Station 3', area: 'Production Area A', operator: 'Mike Brown', part: 'P-123-A', team: 'Team B' }
        ],
        categories: ['Mechanical', 'Electrical', 'Quality', 'Material', 'Safety', 'Other'],
        priorities: ['LOW', 'MEDIUM', 'HIGH'],
        areas: ['Production Area A', 'Production Area B', 'Packaging', 'Warehouse', 'Maintenance', 'Shopfloor'],
        teams: ['Team A', 'Team B', 'Team C'],
        shifts: [
          { name: 'Early', start: '06:00', end: '14:00' },
          { name: 'Late', start: '14:00', end: '22:00' },
          { name: 'Night', start: '22:00', end: '06:00' }
        ]
      },
      machines: [],
      getMachinesFromConfig() {
        return this.adminConfig.workstations.map(ws => ({
          id: ws.id,
          name: ws.name,
          area: ws.area,
          team: ws.team,
          operator: ws.operator || 'Unassigned',
          part: ws.part || 'N/A'
        }));
      },
      productionData: {
        'M-401': [
          { hour: 6, target: 100, actual: 85, notes: 'Startup delay' },
          { hour: 7, target: 100, actual: 98, notes: '' },
          { hour: 8, target: 100, actual: 60, notes: 'Machine issue - see Issue 1' }
        ],
        'M-301': [
          { hour: 6, target: 100, actual: 95, notes: '' },
          { hour: 7, target: 100, actual: 102, notes: '' },
          { hour: 8, target: 100, actual: 98, notes: '' }
        ]
      },
      gembaWalkData: {
        targetAreas: '',
        focus: '',
        participants: '',
        findings: [],
        teamFeedback: '',
        issues: [],
        completed: [
          { id: 1, date: '2025-01-15', leader: 'Plant Manager', area: 'Production Area A', duration: 45, issuesFound: 2 },
          { id: 2, date: '2025-01-22', leader: 'Area Leader', area: 'Production Area B', duration: 30, issuesFound: 1 },
          { id: 3, date: '2025-01-28', leader: 'Plant Manager', area: 'Packaging', duration: 40, issuesFound: 3 },
          { id: 4, date: '2025-02-01', leader: 'Area Leader', area: 'Production Area A', duration: 35, issuesFound: 1 },
          { id: 5, date: '2025-02-02', leader: 'Plant Manager', area: 'Production Area B', duration: 38, issuesFound: 2 },
          { id: 6, date: '2025-02-03', leader: 'Area Leader', area: 'Warehouse', duration: 25, issuesFound: 1 },
          { id: 7, date: '2025-02-04', leader: 'Plant Manager', area: 'Quality Control', duration: 42, issuesFound: 0 },
          { id: 8, date: '2025-02-05', leader: 'Area Leader', area: 'Production Area A', duration: 33, issuesFound: 2 },
          { id: 9, date: '2025-02-06', leader: 'Plant Manager', area: 'Packaging', duration: 37, issuesFound: 1 },
          { id: 10, date: '2025-02-07', leader: 'Area Leader', area: 'Production Area B', duration: 40, issuesFound: 2 }
        ]
      },
      safetyCross: {
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear(),
        entries: [
          { date: '2025-02-01', shift: 'Early', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-01', shift: 'Late', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-01', shift: 'Night', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-02', shift: 'Early', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-02', shift: 'Late', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-02', shift: 'Night', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-03', shift: 'Early', status: 'near-miss', team: 'Team A', area: 'Assembly Line 1', notes: 'Slippery floor - cleaned immediately' },
          { date: '2025-02-03', shift: 'Late', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' },
          { date: '2025-02-03', shift: 'Night', status: 'safe', team: 'Team A', area: 'Assembly Line 1', notes: '' }
        ],
        daysWithoutAccident: 147
      },
      issues: [
        {
          id: 1,
          level: 1,
          title: 'Machine M-401 breakdown',
          area: 'Assembly Line 2 - Team B',
          time: '08:45',
          shift: 'Day',
          priority: 'HIGH',
          category: 'Mechanical',
          subcategory: 'Belt System',
          description: 'Machine stopped unexpectedly. Maintenance called. Estimated downtime 45 minutes.',
          contact: 'Maria Garcia',
          status: 'OPEN',
          source: 'production',
          dateCreated: '2025-02-07',
          aiSuggestion: {
            suggestedLevel: 2,
            reason: 'Production impact >30min, affects line throughput',
            confidence: 85
          }
        },
        {
          id: 2,
          level: 2,
          title: 'Recurring quality defects on Part P-456',
          area: 'Assembly Line 1 - Team A',
          time: '07:30',
          shift: 'Day',
          priority: 'HIGH',
          category: 'Quality',
          subcategory: 'Dimensional',
          description: 'Third occurrence this week of warping defects. Affecting 5 percent of production.',
          contact: 'John Smith',
          status: 'RESOLVED',
          source: 'gemba',
          dateCreated: '2025-02-05',
          resolvedDate: '2025-02-06',
          resolvedTime: '14:30',
          impact: {
            downtimePrevented: 120,
            defectsReduced: 450,
            costSavings: 3200
          }
        },
        {
          id: 3,
          level: 2,
          title: 'Safety guardrail loose on conveyor belt',
          area: 'Packaging Area',
          time: '09:15',
          shift: 'Day',
          priority: 'HIGH',
          category: 'Safety',
          subcategory: 'Equipment',
          description: 'Guardrail wobbling - potential hazard identified during Gemba walk',
          contact: 'Area Leader',
          status: 'RESOLVED',
          source: 'gemba',
          dateCreated: '2025-02-03',
          resolvedDate: '2025-02-03',
          resolvedTime: '11:00',
          impact: {
            downtimePrevented: 0,
            defectsReduced: 0,
            costSavings: 15000
          }
        },
        {
          id: 4,
          level: 1,
          title: '5S non-compliance in work area',
          area: 'Assembly Line 1 - Team A',
          time: '10:30',
          shift: 'Day',
          priority: 'MEDIUM',
          category: 'Other',
          subcategory: '5S',
          description: 'Tools not returned to shadow board, excess inventory on floor',
          contact: 'Plant Manager',
          status: 'RESOLVED',
          source: 'gemba',
          dateCreated: '2025-02-01',
          resolvedDate: '2025-02-01',
          resolvedTime: '15:00',
          impact: {
            downtimePrevented: 30,
            defectsReduced: 0,
            costSavings: 0
          }
        },
        {
          id: 5,
          level: 2,
          title: 'Coolant leak on Machine M-302',
          area: 'Production Area B',
          time: '11:45',
          shift: 'Day',
          priority: 'HIGH',
          category: 'Mechanical',
          subcategory: 'Hydraulics',
          description: 'Small coolant drip detected during Gemba walk - preventive maintenance scheduled',
          contact: 'Area Leader',
          status: 'RESOLVED',
          source: 'gemba',
          dateCreated: '2025-02-05',
          resolvedDate: '2025-02-06',
          resolvedTime: '09:00',
          impact: {
            downtimePrevented: 240,
            defectsReduced: 200,
            costSavings: 8500
          }
        },
        {
          id: 6,
          level: 1,
          title: 'Lighting insufficient in inspection area',
          area: 'Quality Control',
          time: '13:20',
          shift: 'Day',
          priority: 'MEDIUM',
          category: 'Other',
          subcategory: 'Ergonomics',
          description: 'Gemba observation: inspectors straining eyes, may affect quality detection',
          contact: 'Plant Manager',
          status: 'OPEN',
          source: 'gemba',
          dateCreated: '2025-02-06'
        },
        {
          id: 7,
          level: 1,
          title: 'Material handling delay',
          area: 'Warehouse',
          time: '14:15',
          shift: 'Day',
          priority: 'LOW',
          category: 'Material',
          subcategory: 'Logistics',
          description: 'Forklift unavailable - causing 10min delays',
          contact: 'Warehouse Lead',
          status: 'OPEN',
          source: 'production',
          dateCreated: '2025-02-07'
        }
      ],
      nextIssueId: 8,
      aiAssistant: {
        enabled: true,
        queryHistory: [],
        suggestions: []
      },
      voiceRecognition: {
        active: false,
        recognition: null,
        targetField: null,
        quickFormMode: false
      },
      currentLanguage: 'en',
      adminConfig: {
        workstations: [
          { id: 'M-401', name: 'Assembly Line 2 - Station 3', area: 'Production Area A', team: 'Team A' },
          { id: 'M-402', name: 'Assembly Line 2 - Station 1', area: 'Production Area A', team: 'Team A' },
          { id: 'M-403', name: 'Assembly Line 2 - Station 2', area: 'Production Area A', team: 'Team A' },
          { id: 'M-301', name: 'Assembly Line 1 - Station 1', area: 'Production Area A', team: 'Team B' },
          { id: 'M-302', name: 'Assembly Line 1 - Station 2', area: 'Production Area A', team: 'Team B' },
          { id: 'M-303', name: 'Assembly Line 1 - Station 3', area: 'Production Area A', team: 'Team B' }
        ],
        categories: ['Mechanical', 'Electrical', 'Quality', 'Material', 'Safety', 'Other'],
        priorities: ['LOW', 'MEDIUM', 'HIGH'],
        areas: ['Production Area A', 'Production Area B', 'Packaging', 'Warehouse', 'Maintenance'],
        teams: ['Team A', 'Team B', 'Team C'],
        shifts: ['Early', 'Late', 'Night'],
        operators: ['Team Member A', 'Team Member B', 'Team Member C', 'John Smith', 'Lisa Chen', 'Mike Brown']
      },
      languages: {
        en: { name: 'English', code: 'en-US', flag: 'üá¨üáß' },
        es: { name: 'Espa√±ol', code: 'es-ES', flag: 'üá™üá∏' },
        de: { name: 'Deutsch', code: 'de-DE', flag: 'üá©üá™' },
        fr: { name: 'Fran√ßais', code: 'fr-FR', flag: 'üá´üá∑' },
        it: { name: 'Italiano', code: 'it-IT', flag: 'üáÆüáπ' },
        pl: { name: 'Polski', code: 'pl-PL', flag: 'üáµüá±' },
        pt: { name: 'Portugu√™s', code: 'pt-PT', flag: 'üáµüáπ' },
        ro: { name: 'Rom√¢nƒÉ', code: 'ro-RO', flag: 'üá∑üá¥' },
        ru: { name: '–†—É—Å—Å–∫–∏–π', code: 'ru-RU', flag: 'üá∑üá∫' },
        zh: { name: '‰∏≠Êñá', code: 'zh-CN', flag: 'üá®üá≥' },
        ja: { name: 'Êó•Êú¨Ë™û', code: 'ja-JP', flag: 'üáØüáµ' },
        ko: { name: 'ÌïúÍµ≠Ïñ¥', code: 'ko-KR', flag: 'üá∞üá∑' },
        vi: { name: 'Ti·∫øng Vi·ªát', code: 'vi-VN', flag: 'üáªüá≥' },
        tr: { name: 'T√ºrk√ße', code: 'tr-TR', flag: 'üáπüá∑' },
        hu: { name: 'Magyar', code: 'hu-HU', flag: 'üá≠üá∫' }
      },
      translations: {
        en: {
          // Login
          login: 'Login',
          username: 'Username',
          password: 'Password',
          selectAccessLevel: 'Or select access level',
          level1Teams: 'Level 1 - Team Members',
          level2Areas: 'Level 2 - Area Leaders',
          level3Plant: 'Level 3 - Plant Managers',
          
          // Navigation
          managementLevels: 'Management Levels',
          issueManagement: 'Issue Management',
          managementTools: 'Management Tools',
          issueEscalations: 'Issue Escalations',
          issueResolution: 'Issue Resolution',
          issueDashboard: 'Issue Dashboard',
          safetyCross: 'Safety Cross',
          gembaWalk: 'Gemba Walk',
          
          // General
          logout: 'Logout',
          currentShift: 'Current Shift',
          save: 'Save',
          cancel: 'Cancel',
          close: 'Close',
          confirm: 'Confirm',
          delete: 'Delete',
          edit: 'Edit',
          add: 'Add',
          
          // Production
          hourlyProduction: 'Hourly Production Entry',
          selectWorkstation: 'Select Your Workstation',
          chooseWorkstation: 'Choose your machine/workstation',
          changeWorkstation: 'Change Workstation',
          workstation: 'Workstation',
          machineId: 'Machine ID',
          operator: 'Operator',
          partNumber: 'Part Number',
          shift: 'Shift',
          hour: 'Hour',
          target: 'Target',
          actual: 'Actual',
          variance: 'Variance',
          notes: 'Notes',
          efficiency: 'Efficiency',
          saveShiftData: 'Save Shift Data',
          reportIssue: 'Report Issue',
          
          // Issues
          myOpenIssues: 'My Open Issues',
          noOpenIssues: 'No open issues',
          addNewIssue: 'Add New Issue',
          issueTitle: 'Issue Title',
          category: 'Category',
          priority: 'Priority',
          time: 'Time',
          subcategory: 'Subcategory',
          area: 'Area',
          description: 'Description',
          contactPerson: 'Contact Person',
          escalate: 'Escalate',
          resolve: 'Resolve',
          status: 'Status',
          
          // Categories
          mechanical: 'Mechanical',
          electrical: 'Electrical',
          quality: 'Quality',
          material: 'Material',
          safety: 'Safety',
          other: 'Other',
          
          // Priority
          low: 'Low',
          medium: 'Medium',
          high: 'High',
          
          // Status
          open: 'Open',
          escalated: 'Escalated',
          resolved: 'Resolved',
          
          // Safety
          safetyStatus: 'Safety Status',
          markSafetyStatus: 'Mark Your Safety Status',
          safe: 'Safe',
          nearMiss: 'Near Miss',
          incident: 'Incident',
          notReported: 'Not Reported',
          daysWithoutAccident: 'Days Without Accident',
          plantDaysWithoutAccident: 'Plant Days Without Accident',
          
          // Voice
          voice: 'Voice',
          voiceInput: 'Voice Input',
          recording: 'Recording',
          voiceDictation: 'Voice Dictation',
          clickToDictate: 'Click to dictate hands-free',
          
          // Gemba Walk
          gembaWalkProcess: 'Gemba Walk Process',
          initiation: 'Initiation',
          observation: 'Observation',
          documentation: 'Documentation',
          issues: 'Issues',
          report: 'Report',
          targetAreas: 'Target Areas',
          focus: 'Focus / Objectives',
          participants: 'Participants',
          observationsFindings: 'Observations and Findings',
          teamFeedback: 'Team Feedback',
          
          // AI Assistant
          aiAssistant: 'AI Assistant',
          naturalLanguageQuery: 'Natural Language Query',
          search: 'Search',
          generateReport: 'Generate AI Report',
          resolutionTimes: 'Resolution Times',
          
          // Shift Handover
          shiftHandover: 'Shift Handover Notes',
          previousShift: 'Previous Shift',
          currentShiftHandover: 'Current Shift Handover',
          noHandoverNotes: 'No handover notes from previous shift',
          saveHandoverNotes: 'Save Handover Notes'
        },
        es: {
          login: 'Iniciar sesi√≥n',
          username: 'Usuario',
          password: 'Contrase√±a',
          selectAccessLevel: 'O seleccione nivel de acceso',
          level1Teams: 'Nivel 1 - Miembros del equipo',
          level2Areas: 'Nivel 2 - L√≠deres de √°rea',
          level3Plant: 'Nivel 3 - Gerentes de planta',
          
          managementLevels: 'Niveles de gesti√≥n',
          issueManagement: 'Gesti√≥n de problemas',
          managementTools: 'Herramientas de gesti√≥n',
          issueEscalations: 'Escaladas de problemas',
          issueResolution: 'Resoluci√≥n de problemas',
          issueDashboard: 'Panel de problemas',
          safetyCross: 'Cruz de seguridad',
          gembaWalk: 'Gemba Walk',
          
          logout: 'Cerrar sesi√≥n',
          currentShift: 'Turno actual',
          save: 'Guardar',
          cancel: 'Cancelar',
          close: 'Cerrar',
          confirm: 'Confirmar',
          delete: 'Eliminar',
          edit: 'Editar',
          add: 'Agregar',
          
          hourlyProduction: 'Entrada de producci√≥n horaria',
          selectWorkstation: 'Seleccione su estaci√≥n de trabajo',
          chooseWorkstation: 'Elija su m√°quina/estaci√≥n de trabajo',
          changeWorkstation: 'Cambiar estaci√≥n de trabajo',
          workstation: 'Estaci√≥n de trabajo',
          machineId: 'ID de m√°quina',
          operator: 'Operador',
          partNumber: 'N√∫mero de pieza',
          shift: 'Turno',
          hour: 'Hora',
          target: 'Objetivo',
          actual: 'Real',
          variance: 'Variaci√≥n',
          notes: 'Notas',
          efficiency: 'Eficiencia',
          saveShiftData: 'Guardar datos del turno',
          reportIssue: 'Reportar problema',
          
          myOpenIssues: 'Mis problemas abiertos',
          noOpenIssues: 'No hay problemas abiertos',
          addNewIssue: 'Agregar nuevo problema',
          issueTitle: 'T√≠tulo del problema',
          category: 'Categor√≠a',
          priority: 'Prioridad',
          time: 'Hora',
          subcategory: 'Subcategor√≠a',
          area: '√Årea',
          description: 'Descripci√≥n',
          contactPerson: 'Persona de contacto',
          escalate: 'Escalar',
          resolve: 'Resolver',
          status: 'Estado',
          
          mechanical: 'Mec√°nico',
          electrical: 'El√©ctrico',
          quality: 'Calidad',
          material: 'Material',
          safety: 'Seguridad',
          other: 'Otro',
          
          low: 'Bajo',
          medium: 'Medio',
          high: 'Alto',
          
          open: 'Abierto',
          escalated: 'Escalado',
          resolved: 'Resuelto',
          
          safetyStatus: 'Estado de seguridad',
          markSafetyStatus: 'Marque su estado de seguridad',
          safe: 'Seguro',
          nearMiss: 'Casi accidente',
          incident: 'Incidente',
          notReported: 'No reportado',
          daysWithoutAccident: 'D√≠as sin accidente',
          plantDaysWithoutAccident: 'D√≠as sin accidente en planta',
          
          voice: 'Voz',
          voiceInput: 'Entrada de voz',
          recording: 'Grabando',
          voiceDictation: 'Dictado por voz',
          clickToDictate: 'Haga clic para dictar sin manos',
          
          aiAssistant: 'Asistente IA',
          naturalLanguageQuery: 'Consulta en lenguaje natural',
          search: 'Buscar',
          generateReport: 'Generar informe IA',
          resolutionTimes: 'Tiempos de resoluci√≥n',
          
          shiftHandover: 'Notas de entrega de turno',
          previousShift: 'Turno anterior',
          currentShiftHandover: 'Entrega de turno actual',
          noHandoverNotes: 'Sin notas de turno anterior',
          saveHandoverNotes: 'Guardar notas de entrega'
        },
        de: {
          login: 'Anmelden',
          username: 'Benutzername',
          password: 'Passwort',
          selectAccessLevel: 'Oder Zugriffsebene w√§hlen',
          level1Teams: 'Ebene 1 - Teammitglieder',
          level2Areas: 'Ebene 2 - Bereichsleiter',
          level3Plant: 'Ebene 3 - Werksleiter',
          
          managementLevels: 'F√ºhrungsebenen',
          issueManagement: 'Problemverwaltung',
          managementTools: 'Verwaltungstools',
          issueEscalations: 'Problemeskalationen',
          issueResolution: 'Probleml√∂sung',
          issueDashboard: 'Problem-Dashboard',
          safetyCross: 'Sicherheitskreuz',
          gembaWalk: 'Gemba Walk',
          
          logout: 'Abmelden',
          currentShift: 'Aktuelle Schicht',
          save: 'Speichern',
          cancel: 'Abbrechen',
          close: 'Schlie√üen',
          confirm: 'Best√§tigen',
          
          hourlyProduction: 'St√ºndliche Produktionseingabe',
          selectWorkstation: 'W√§hlen Sie Ihren Arbeitsplatz',
          chooseWorkstation: 'W√§hlen Sie Ihre Maschine/Arbeitsplatz',
          changeWorkstation: 'Arbeitsplatz wechseln',
          workstation: 'Arbeitsplatz',
          machineId: 'Maschinen-ID',
          operator: 'Bediener',
          partNumber: 'Teilenummer',
          shift: 'Schicht',
          hour: 'Stunde',
          target: 'Ziel',
          actual: 'Ist',
          variance: 'Abweichung',
          notes: 'Notizen',
          efficiency: 'Effizienz',
          saveShiftData: 'Schichtdaten speichern',
          reportIssue: 'Problem melden',
          
          myOpenIssues: 'Meine offenen Probleme',
          noOpenIssues: 'Keine offenen Probleme',
          addNewIssue: 'Neues Problem hinzuf√ºgen',
          issueTitle: 'Problemtitel',
          category: 'Kategorie',
          priority: 'Priorit√§t',
          time: 'Zeit',
          subcategory: 'Unterkategorie',
          area: 'Bereich',
          description: 'Beschreibung',
          contactPerson: 'Kontaktperson',
          escalate: 'Eskalieren',
          resolve: 'L√∂sen',
          status: 'Status',
          
          mechanical: 'Mechanisch',
          electrical: 'Elektrisch',
          quality: 'Qualit√§t',
          material: 'Material',
          safety: 'Sicherheit',
          other: 'Sonstiges',
          
          low: 'Niedrig',
          medium: 'Mittel',
          high: 'Hoch',
          
          open: 'Offen',
          escalated: 'Eskaliert',
          resolved: 'Gel√∂st',
          
          safetyStatus: 'Sicherheitsstatus',
          markSafetyStatus: 'Markieren Sie Ihren Sicherheitsstatus',
          safe: 'Sicher',
          nearMiss: 'Beinaheunfall',
          incident: 'Vorfall',
          notReported: 'Nicht gemeldet',
          daysWithoutAccident: 'Tage ohne Unfall',
          plantDaysWithoutAccident: 'Tage ohne Unfall im Werk',
          
          voice: 'Sprache',
          voiceInput: 'Spracheingabe',
          recording: 'Aufnahme',
          voiceDictation: 'Sprachdiktat',
          clickToDictate: 'Klicken Sie zum freih√§ndigen Diktieren',
          
          aiAssistant: 'KI-Assistent',
          naturalLanguageQuery: 'Nat√ºrlichsprachliche Abfrage',
          search: 'Suchen',
          generateReport: 'KI-Bericht generieren',
          resolutionTimes: 'L√∂sungszeiten'
        },
        zh: {
          login: 'ÁôªÂΩï',
          username: 'Áî®Êà∑Âêç',
          password: 'ÂØÜÁ†Å',
          selectAccessLevel: 'ÊàñÈÄâÊã©ËÆøÈóÆÁ∫ßÂà´',
          level1Teams: '‰∏ÄÁ∫ß - Âõ¢ÈòüÊàêÂëò',
          level2Areas: '‰∫åÁ∫ß - Âå∫ÂüüË¥üË¥£‰∫∫',
          level3Plant: '‰∏âÁ∫ß - Â∑•ÂéÇÁªèÁêÜ',
          
          managementLevels: 'ÁÆ°ÁêÜÁ∫ßÂà´',
          issueManagement: 'ÈóÆÈ¢òÁÆ°ÁêÜ',
          managementTools: 'ÁÆ°ÁêÜÂ∑•ÂÖ∑',
          issueEscalations: 'ÈóÆÈ¢òÂçáÁ∫ß',
          issueResolution: 'ÈóÆÈ¢òËß£ÂÜ≥',
          issueDashboard: 'ÈóÆÈ¢ò‰ª™Ë°®Êùø',
          safetyCross: 'ÂÆâÂÖ®‰∫§Âèâ',
          gembaWalk: 'Áé∞Âú∫Â∑°Êü•',
          
          logout: 'ÈÄÄÂá∫',
          currentShift: 'ÂΩìÂâçÁè≠Ê¨°',
          save: '‰øùÂ≠ò',
          cancel: 'ÂèñÊ∂à',
          close: 'ÂÖ≥Èó≠',
          confirm: 'Á°ÆËÆ§',
          
          hourlyProduction: 'ÊØèÂ∞èÊó∂Áîü‰∫ßÂΩïÂÖ•',
          selectWorkstation: 'ÈÄâÊã©ÊÇ®ÁöÑÂ∑•‰ΩúÁ´ô',
          chooseWorkstation: 'ÈÄâÊã©ÊÇ®ÁöÑÊú∫Âô®/Â∑•‰ΩúÁ´ô',
          changeWorkstation: 'Êõ¥Êç¢Â∑•‰ΩúÁ´ô',
          workstation: 'Â∑•‰ΩúÁ´ô',
          machineId: 'Êú∫Âô®ÁºñÂè∑',
          operator: 'Êìç‰ΩúÂëò',
          partNumber: 'Èõ∂‰ª∂Âè∑',
          shift: 'Áè≠Ê¨°',
          hour: 'Â∞èÊó∂',
          target: 'ÁõÆÊ†á',
          actual: 'ÂÆûÈôÖ',
          variance: 'Â∑ÆÂºÇ',
          notes: 'Â§áÊ≥®',
          efficiency: 'ÊïàÁéá',
          saveShiftData: '‰øùÂ≠òÁè≠Ê¨°Êï∞ÊçÆ',
          reportIssue: 'Êä•ÂëäÈóÆÈ¢ò',
          
          myOpenIssues: 'ÊàëÁöÑÊú™Ëß£ÂÜ≥ÈóÆÈ¢ò',
          noOpenIssues: 'Ê≤°ÊúâÊú™Ëß£ÂÜ≥ÁöÑÈóÆÈ¢ò',
          addNewIssue: 'Ê∑ªÂä†Êñ∞ÈóÆÈ¢ò',
          issueTitle: 'ÈóÆÈ¢òÊ†áÈ¢ò',
          category: 'Á±ªÂà´',
          priority: '‰ºòÂÖàÁ∫ß',
          time: 'Êó∂Èó¥',
          subcategory: 'Â≠êÁ±ªÂà´',
          area: 'Âå∫Âüü',
          description: 'ÊèèËø∞',
          contactPerson: 'ËÅîÁ≥ª‰∫∫',
          escalate: 'ÂçáÁ∫ß',
          resolve: 'Ëß£ÂÜ≥',
          status: 'Áä∂ÊÄÅ',
          
          mechanical: 'Êú∫Ê¢∞',
          electrical: 'ÁîµÊ∞î',
          quality: 'Ë¥®Èáè',
          material: 'ÊùêÊñô',
          safety: 'ÂÆâÂÖ®',
          other: 'ÂÖ∂‰ªñ',
          
          low: '‰Ωé',
          medium: '‰∏≠',
          high: 'È´ò',
          
          open: 'Êú™Ëß£ÂÜ≥',
          escalated: 'Â∑≤ÂçáÁ∫ß',
          resolved: 'Â∑≤Ëß£ÂÜ≥',
          
          safetyStatus: 'ÂÆâÂÖ®Áä∂ÊÄÅ',
          markSafetyStatus: 'Ê†áËÆ∞ÊÇ®ÁöÑÂÆâÂÖ®Áä∂ÊÄÅ',
          safe: 'ÂÆâÂÖ®',
          nearMiss: 'Èô©ÂÖÜ‰∫ã‰ª∂',
          incident: '‰∫ãÊïÖ',
          notReported: 'Êú™Êä•Âëä',
          daysWithoutAccident: 'Êó†‰∫ãÊïÖÂ§©Êï∞',
          plantDaysWithoutAccident: 'Â∑•ÂéÇÊó†‰∫ãÊïÖÂ§©Êï∞',
          
          voice: 'ËØ≠Èü≥',
          voiceInput: 'ËØ≠Èü≥ËæìÂÖ•',
          recording: 'ÂΩïÈü≥‰∏≠',
          voiceDictation: 'ËØ≠Èü≥Âê¨ÂÜô',
          clickToDictate: 'ÁÇπÂáªÂÖçÊèêÂê¨ÂÜô',
          
          aiAssistant: 'AIÂä©Êâã',
          naturalLanguageQuery: 'Ëá™ÁÑ∂ËØ≠Ë®ÄÊü•ËØ¢',
          search: 'ÊêúÁ¥¢',
          generateReport: 'ÁîüÊàêAIÊä•Âëä',
          resolutionTimes: 'Ëß£ÂÜ≥Êó∂Èó¥'
        },
        ru: {
          login: '–í–æ–π—Ç–∏',
          username: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
          password: '–ü–∞—Ä–æ–ª—å',
          selectAccessLevel: '–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞',
          level1Teams: '–£—Ä–æ–≤–µ–Ω—å 1 - –ß–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã',
          level2Areas: '–£—Ä–æ–≤–µ–Ω—å 2 - –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ —É—á–∞—Å—Ç–∫–æ–≤',
          level3Plant: '–£—Ä–æ–≤–µ–Ω—å 3 - –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –∑–∞–≤–æ–¥–∞',
          
          managementLevels: '–£—Ä–æ–≤–Ω–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
          issueManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–∞–º–∏',
          managementTools: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
          issueEscalations: '–≠—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º',
          issueResolution: '–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º',
          issueDashboard: '–ü–∞–Ω–µ–ª—å –ø—Ä–æ–±–ª–µ–º',
          safetyCross: '–ö—Ä–µ—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
          gembaWalk: '–û–±—Ö–æ–¥ –ì–µ–º–±–∞',
          
          logout: '–í—ã–π—Ç–∏',
          currentShift: '–¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞',
          save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
          cancel: '–û—Ç–º–µ–Ω–∞',
          close: '–ó–∞–∫—Ä—ã—Ç—å',
          confirm: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
          
          hourlyProduction: '–ü–æ—á–∞—Å–æ–≤–æ–π –≤–≤–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞',
          selectWorkstation: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ',
          chooseWorkstation: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π —Å—Ç–∞–Ω–æ–∫/—Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ',
          changeWorkstation: '–°–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ',
          workstation: '–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ',
          machineId: 'ID —Å—Ç–∞–Ω–∫–∞',
          operator: '–û–ø–µ—Ä–∞—Ç–æ—Ä',
          partNumber: '–ù–æ–º–µ—Ä –¥–µ—Ç–∞–ª–∏',
          shift: '–°–º–µ–Ω–∞',
          hour: '–ß–∞—Å',
          target: '–¶–µ–ª—å',
          actual: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏',
          variance: '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ',
          notes: '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è',
          efficiency: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
          saveShiftData: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–º–µ–Ω—ã',
          reportIssue: '–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ',
          
          myOpenIssues: '–ú–æ–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã',
          noOpenIssues: '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º',
          addNewIssue: '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É',
          issueTitle: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã',
          category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
          priority: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç',
          time: '–í—Ä–µ–º—è',
          subcategory: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è',
          area: '–û–±–ª–∞—Å—Ç—å',
          description: '–û–ø–∏—Å–∞–Ω–∏–µ',
          contactPerson: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ',
          escalate: '–≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å',
          resolve: '–†–µ—à–∏—Ç—å',
          status: '–°—Ç–∞—Ç—É—Å',
          
          mechanical: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π',
          electrical: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π',
          quality: '–ö–∞—á–µ—Å—Ç–≤–æ',
          material: '–ú–∞—Ç–µ—Ä–∏–∞–ª',
          safety: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
          other: '–î—Ä—É–≥–æ–µ',
          
          low: '–ù–∏–∑–∫–∏–π',
          medium: '–°—Ä–µ–¥–Ω–∏–π',
          high: '–í—ã—Å–æ–∫–∏–π',
          
          open: '–û—Ç–∫—Ä—ã—Ç–æ',
          escalated: '–≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–æ',
          resolved: '–†–µ—à–µ–Ω–æ',
          
          safetyStatus: '–°—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
          markSafetyStatus: '–û—Ç–º–µ—Ç—å—Ç–µ —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
          safe: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ',
          nearMiss: '–ü–æ—á—Ç–∏ –∞–≤–∞—Ä–∏—è',
          incident: '–ò–Ω—Ü–∏–¥–µ–Ω—Ç',
          notReported: '–ù–µ —Å–æ–æ–±—â–µ–Ω–æ',
          daysWithoutAccident: '–î–Ω–∏ –±–µ–∑ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–π',
          plantDaysWithoutAccident: '–î–Ω–∏ –±–µ–∑ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–π –Ω–∞ –∑–∞–≤–æ–¥–µ',
          
          voice: '–ì–æ–ª–æ—Å',
          voiceInput: '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥',
          recording: '–ó–∞–ø–∏—Å—å',
          voiceDictation: '–ì–æ–ª–æ—Å–æ–≤–æ–π –¥–∏–∫—Ç–∞–Ω—Ç',
          clickToDictate: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–∏–∫—Ç–æ–≤–∫–∏ –±–µ–∑ —Ä—É–∫'
        },
        hu: {
          login: 'Bejelentkez√©s',
          username: 'Felhaszn√°l√≥n√©v',
          password: 'Jelsz√≥',
          selectAccessLevel: 'Vagy v√°lasszon hozz√°f√©r√©si szintet',
          level1Teams: '1. szint - Csapattagok',
          level2Areas: '2. szint - Ter√ºletvezet≈ëk',
          level3Plant: '3. szint - √územvezet≈ëk',
          
          managementLevels: 'Vezet√©si szintek',
          issueManagement: 'Probl√©ma kezel√©s',
          managementTools: 'Vezet√©si eszk√∂z√∂k',
          issueEscalations: 'Probl√©ma eszkal√°ci√≥k',
          issueResolution: 'Probl√©ma megold√°s',
          issueDashboard: 'Probl√©ma dashboard',
          safetyCross: 'Biztons√°gi kereszt',
          gembaWalk: 'Gemba s√©ta',
          
          logout: 'Kijelentkez√©s',
          currentShift: 'Jelenlegi m≈±szak',
          save: 'Ment√©s',
          cancel: 'M√©gse',
          close: 'Bez√°r',
          confirm: 'Meger≈ës√≠t√©s',
          
          hourlyProduction: '√ìr√°nk√©nti termel√©s r√∂gz√≠t√©s',
          selectWorkstation: 'V√°lassza ki a munka√°llom√°s√°t',
          chooseWorkstation: 'V√°lassza ki a g√©p√©t/munka√°llom√°s√°t',
          changeWorkstation: 'Munka√°llom√°s v√°lt√°s',
          workstation: 'Munka√°llom√°s',
          machineId: 'G√©p azonos√≠t√≥',
          operator: 'Oper√°tor',
          partNumber: 'Alkatr√©sz sz√°m',
          shift: 'M≈±szak',
          hour: '√ìra',
          target: 'C√©l',
          actual: 'T√©nyleges',
          variance: 'Elt√©r√©s',
          notes: 'Megjegyz√©sek',
          efficiency: 'Hat√©konys√°g',
          saveShiftData: 'M≈±szak adatok ment√©se',
          reportIssue: 'Probl√©ma jelent√©se',
          
          myOpenIssues: 'Nyitott probl√©m√°im',
          noOpenIssues: 'Nincs nyitott probl√©ma',
          addNewIssue: '√öj probl√©ma hozz√°ad√°sa',
          issueTitle: 'Probl√©ma c√≠me',
          category: 'Kateg√≥ria',
          priority: 'Priorit√°s',
          time: 'Id≈ë',
          subcategory: 'Alkateg√≥ria',
          area: 'Ter√ºlet',
          description: 'Le√≠r√°s',
          contactPerson: 'Kapcsolattart√≥',
          escalate: 'Eszkal√°ci√≥',
          resolve: 'Megold√°s',
          status: '√Ållapot',
          
          mechanical: 'Mechanikai',
          electrical: 'Elektromos',
          quality: 'Min≈ës√©g',
          material: 'Anyag',
          safety: 'Biztons√°g',
          other: 'Egy√©b',
          
          low: 'Alacsony',
          medium: 'K√∂zepes',
          high: 'Magas',
          
          open: 'Nyitott',
          escalated: 'Eszkal√°lt',
          resolved: 'Megoldott',
          
          safetyStatus: 'Biztons√°gi √°llapot',
          markSafetyStatus: 'Jel√∂lje meg biztons√°gi √°llapot√°t',
          safe: 'Biztons√°gos',
          nearMiss: 'Majdnem baleset',
          incident: 'Incidens',
          notReported: 'Nem jelentett',
          daysWithoutAccident: 'Baleset n√©lk√ºli napok',
          plantDaysWithoutAccident: '√územ baleset n√©lk√ºli napjai',
          
          voice: 'Hang',
          voiceInput: 'Hangbemenet',
          recording: 'Felv√©tel',
          voiceDictation: 'Hang dikt√°l√°s',
          clickToDictate: 'Kattintson a k√©z n√©lk√ºli dikt√°l√°shoz'
        }
      },
      shiftHandover: {
        'Early': {
          notes: 'Morning startup went smoothly. M-401 had minor belt issue - resolved. All safety checks completed.',
          completedBy: 'Team Leader A',
          timestamp: '2025-02-07 13:45'
        },
        'Late': {
          notes: '',
          completedBy: '',
          timestamp: ''
        },
        'Night': {
          notes: '',
          completedBy: '',
          timestamp: ''
        }
      },
      
      init() {
        // Load saved language preference
        const savedLang = localStorage.getItem('gemba_language');
        if (savedLang && this.languages[savedLang]) {
          this.currentLanguage = savedLang;
        }
        
        // Load admin configuration from localStorage
        const savedConfig = localStorage.getItem('gemba_admin_config');
        if (savedConfig) {
          try {
            this.adminConfig = JSON.parse(savedConfig);
          } catch(e) {
            console.error('Failed to load admin config:', e);
          }
        }
        
        // Initialize machines from config
        this.machines = this.getMachinesFromConfig();
        
        this.initVoiceRecognition();
        this.render();
      },
      
      saveAdminConfig() {
        localStorage.setItem('gemba_admin_config', JSON.stringify(this.adminConfig));
        this.machines = this.getMachinesFromConfig();
        alert('Configuration saved successfully!');
        this.render();
      },
      
      addCategory(category) {
        if (category && !this.adminConfig.categories.includes(category)) {
          this.adminConfig.categories.push(category);
          this.render();
        }
      },
      
      deleteCategory(category) {
        if (confirm('Delete category "' + category + '"?')) {
          this.adminConfig.categories = this.adminConfig.categories.filter(c => c !== category);
          this.render();
        }
      },
      
      addArea(area) {
        if (area && !this.adminConfig.areas.includes(area)) {
          this.adminConfig.areas.push(area);
          this.render();
        }
      },
      
      deleteArea(area) {
        if (confirm('Delete area "' + area + '"?')) {
          this.adminConfig.areas = this.adminConfig.areas.filter(a => a !== area);
          this.render();
        }
      },
      
      addTeam(team) {
        if (team && !this.adminConfig.teams.includes(team)) {
          this.adminConfig.teams.push(team);
          this.render();
        }
      },
      
      deleteTeam(team) {
        if (confirm('Delete team "' + team + '"?')) {
          this.adminConfig.teams = this.adminConfig.teams.filter(t => t !== team);
          this.render();
        }
      },
      
      addOperator(operator) {
        if (operator && !this.adminConfig.operators.includes(operator)) {
          this.adminConfig.operators.push(operator);
          this.render();
        }
      },
      
      deleteOperator(operator) {
        if (confirm('Delete operator "' + operator + '"?')) {
          this.adminConfig.operators = this.adminConfig.operators.filter(o => o !== operator);
          this.render();
        }
      },
      
      deleteWorkstation(wsId) {
        this.adminConfig.workstations = this.adminConfig.workstations.filter(w => w.id !== wsId);
        this.closeModal();
        this.render();
      },
      
      addPartNumber(hour, partNumber) {
        if (!partNumber || !partNumber.trim()) {
          alert('Please enter a part number');
          return;
        }
        
        const machineId = this.currentMachine;
        if (!this.productionData[machineId]) {
          this.productionData[machineId] = [];
        }
        
        let hourData = this.productionData[machineId].find(d => d.hour === parseInt(hour));
        if (!hourData) {
          hourData = { hour: parseInt(hour), target: 100, actual: 0, partNumbers: [], notes: '' };
          this.productionData[machineId].push(hourData);
        }
        
        if (!hourData.partNumbers) {
          hourData.partNumbers = [];
        }
        
        if (!hourData.partNumbers.includes(partNumber.trim())) {
          hourData.partNumbers.push(partNumber.trim());
        }
        
        this.render();
      },
      
      removePartNumber(hour, index) {
        const machineId = this.currentMachine;
        const hourData = this.productionData[machineId].find(d => d.hour === parseInt(hour));
        
        if (hourData && hourData.partNumbers) {
          hourData.partNumbers.splice(index, 1);
        }
        
        this.render();
      },
      
      t(key) {
        // Translation helper - returns translated text for current language
        const translations = this.translations[this.currentLanguage];
        if (translations && translations[key]) {
          return translations[key];
        }
        // Fallback to English
        return this.translations.en[key] || key;
      },
      
      setLanguage(lang) {
        if (this.languages[lang]) {
          this.currentLanguage = lang;
          localStorage.setItem('gemba_language', lang);
          // Update voice recognition language
          if (this.voiceRecognition.recognition) {
            this.voiceRecognition.recognition.lang = this.languages[lang].code;
          }
          this.render();
        }
      },
      
      initVoiceRecognition() {
        // Check for browser support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
          this.voiceRecognition.recognition = new SpeechRecognition();
          this.voiceRecognition.recognition.continuous = false;
          this.voiceRecognition.recognition.interimResults = false;
          this.voiceRecognition.recognition.lang = this.languages[this.currentLanguage].code;
          
          const self = this;
          
          this.voiceRecognition.recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            const targetField = document.getElementById(self.voiceRecognition.targetField);
            
            if (targetField) {
              if (targetField.tagName === 'TEXTAREA' || targetField.tagName === 'INPUT') {
                const currentValue = targetField.value;
                targetField.value = currentValue + (currentValue ? ' ' : '') + transcript;
              }
            }
            
            self.voiceRecognition.active = false;
            self.updateVoiceButton();
            
            // Update quick voice button if in quick mode
            const quickBtn = document.getElementById('quick-voice-btn');
            if (quickBtn) {
              quickBtn.innerHTML = '‚úì RECORDED - Click to Record Again';
              quickBtn.style.background = '#2d862d';
            }
          };
          
          this.voiceRecognition.recognition.onerror = function(event) {
            console.error('Voice recognition error:', event.error);
            self.voiceRecognition.active = false;
            self.updateVoiceButton();
            
            const quickBtn = document.getElementById('quick-voice-btn');
            if (quickBtn) {
              quickBtn.innerHTML = 'üé§ START VOICE REPORT';
              quickBtn.style.background = '#4CAF50';
            }
            
            if (event.error === 'not-allowed') {
              alert('Microphone access denied. Please enable microphone permissions in your browser settings.');
            }
          };
          
          this.voiceRecognition.recognition.onend = function() {
            self.voiceRecognition.active = false;
            self.updateVoiceButton();
          };
        }
      },
      
      toggleVoiceInput(fieldId) {
        if (!this.voiceRecognition.recognition) {
          alert('Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
          return;
        }
        
        if (this.voiceRecognition.active) {
          this.voiceRecognition.recognition.stop();
          this.voiceRecognition.active = false;
        } else {
          this.voiceRecognition.targetField = fieldId;
          this.voiceRecognition.active = true;
          this.voiceRecognition.recognition.start();
        }
        
        this.updateVoiceButton();
      },
      
      updateVoiceButton() {
        const buttons = document.querySelectorAll('.voice-btn');
        buttons.forEach(btn => {
          const fieldId = btn.getAttribute('data-field');
          if (fieldId === this.voiceRecognition.targetField && this.voiceRecognition.active) {
            btn.innerHTML = 'üî¥ ' + this.t('recording');
            btn.style.background = '#ff4444';
            btn.style.color = 'white';
          } else {
            btn.innerHTML = 'üé§ ' + this.t('voice');
            btn.style.background = '';
            btn.style.color = '';
          }
        });
      },
      
      login(role) {
        this.currentUser = role;
        if (role === 'admin') {
          this.currentView = 'admin-workstations';
        } else {
          this.currentView = role === 'level1' ? 'level1' : role === 'level2' ? 'level2' : 'level3';
        }
        this.render();
      },
      
      logout() {
        this.currentUser = null;
        this.currentView = 'level1';
        this.render();
      },
      
      setView(view) {
        this.currentView = view;
        this.render();
      },
      
      setMachine(machineId) {
        this.currentMachine = machineId;
        this.render();
      },
      
      getMachine(machineId) {
        return this.machines.find(m => m.id === machineId);
      },
      
      getProductionData(machineId) {
        return this.productionData[machineId] || [];
      },
      
      openModal(modalType, data = null) {
        this.showModal = modalType;
        this.modalData = data;
        this.voiceRecognition.quickFormMode = false; // Reset to full mode by default
        this.render();
      },
      
      toggleFormMode() {
        this.voiceRecognition.quickFormMode = !this.voiceRecognition.quickFormMode;
        this.render();
      },
      
      startQuickVoiceReport() {
        if (!this.voiceRecognition.recognition) {
          alert('Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
          return;
        }
        
        const quickBtn = document.getElementById('quick-voice-btn');
        if (quickBtn) {
          quickBtn.innerHTML = 'üî¥ RECORDING... Speak Now';
          quickBtn.style.background = '#ff4444';
        }
        
        this.voiceRecognition.targetField = 'quick-voice-description';
        this.voiceRecognition.active = true;
        this.voiceRecognition.recognition.start();
      },
      
      closeModal() {
        this.showModal = null;
        this.modalData = null;
        this.issueWizardStep = 1;
        this.issueWizardData = null;
        this.render();
      },
      
      setWizardData(field, value) {
        if (!this.issueWizardData) {
          this.issueWizardData = {};
        }
        this.issueWizardData[field] = value;
        this.render();
      },
      
      nextWizardStep() {
        if (this.issueWizardStep < 6) {
          this.issueWizardStep++;
          this.render();
        }
      },
      
      previousWizardStep() {
        if (this.issueWizardStep > 1) {
          this.issueWizardStep--;
          this.render();
        }
      },
      
      submitWizardIssue() {
        const data = this.issueWizardData;
        
        // Map impact to priority
        let priority = 'MEDIUM';
        if (data.impact === 'stopped' || data.impact === 'safety') priority = 'HIGH';
        if (data.impact === 'minor') priority = 'LOW';
        
        // Build title from problem type and location
        const title = data.problemType + ' issue at ' + (data.specificLocation || data.location);
        
        // Build description
        let description = 'What happened: ' + data.whatHappened + '\n\n';
        description += 'When: ' + data.whenHappened + '\n';
        description += 'Impact: ' + data.impact + '\n';
        if (data.triedSolutions) {
          description += 'Already tried: ' + data.triedSolutions + '\n';
        }
        description += 'Help needed: ' + data.helpNeeded;
        
        // Create issue
        this.addIssue({
          level: 1,
          title: title,
          category: data.problemType,
          priority: priority,
          area: data.specificLocation || data.location,
          description: description,
          contact: 'Team Member',
          subcategory: data.helpNeeded
        });
        
        // Reset wizard
        this.issueWizardStep = 1;
        this.issueWizardData = null;
      },
      
      canAccessView(view) {
        if (!this.currentUser) return false;
        
        const accessMap = {
          'level1': ['level1', 'level2', 'level3'],
          'level2': ['level2', 'level3'],
          'level3': ['level3'],
          'gemba-walk': ['level2', 'level3'],
          'escalations': ['level1', 'level2', 'level3'],
          'resolution': ['level2', 'level3'],
          'dashboard': ['level2', 'level3'],
          'safety-cross': ['level1', 'level2', 'level3'],
          'issue-history': ['level2', 'level3', 'admin'],
          'admin-workstations': ['admin'],
          'admin-categories': ['admin'],
          'admin-areas': ['admin'],
          'admin-teams': ['admin'],
          'admin-operators': ['admin']
        };
        
        return accessMap[view] ? accessMap[view].includes(this.currentUser) : false;
      },
      
      getCurrentShift() {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 14) return 'Early';
        if (hour >= 14 && hour < 22) return 'Late';
        return 'Night';
      },
      
      getShiftTime(shift) {
        const times = {
          'Early': '06:00 - 14:00',
          'Late': '14:00 - 22:00',
          'Night': '22:00 - 06:00'
        };
        return times[shift] || '';
      },
      
      addIssue(issueData) {
        const aiSuggestion = this.getAIEscalationSuggestion(issueData);
        
        // Auto-detect if issue is from Gemba walk (Level 2 or 3 can submit Gemba issues)
        const source = (this.currentView === 'gemba-walk' || this.currentUser === 'level2' || this.currentUser === 'level3') && 
                       issueData.contact && issueData.contact.includes('Leader' || 'Manager') ? 
                       'gemba' : 'production';
        
        this.issues.push({
          id: this.nextIssueId++,
          ...issueData,
          status: 'OPEN',
          source: issueData.source || source,
          dateCreated: new Date().toISOString().split('T')[0],
          aiSuggestion: aiSuggestion
        });
        this.closeModal();
      },
      
      escalateIssue(issueId, toLevel, escalationData) {
        const issue = this.issues.find(i => i.id === issueId);
        if (issue) {
          issue.escalatedFrom = issue.level;
          issue.level = toLevel;
          issue.status = 'ESCALATED';
          issue.escalationReason = escalationData.reason;
          issue.actionsTaken = escalationData.actions;
          issue.supportNeeded = escalationData.support;
        }
        this.closeModal();
      },
      
      resolveIssue(issueId, resolutionData) {
        const issue = this.issues.find(i => i.id === issueId);
        if (issue) {
          const dateCreated = new Date(issue.dateCreated);
          const dateResolved = new Date();
          const resolutionTimeHours = Math.round((dateResolved - dateCreated) / (1000 * 60 * 60));
          
          issue.status = 'RESOLVED';
          issue.resolution = resolutionData.resolution;
          issue.resolvedBy = resolutionData.resolvedBy;
          issue.dateResolved = dateResolved.toISOString().split('T')[0];
          issue.resolvedTime = dateResolved.getHours().toString().padStart(2, '0') + ':' + dateResolved.getMinutes().toString().padStart(2, '0');
          issue.resolutionTime = resolutionTimeHours;
          
          // Add impact data if provided (especially for Gemba issues)
          if (resolutionData.impact) {
            issue.impact = resolutionData.impact;
          }
        }
        this.closeModal();
      },
      
      getAIEscalationSuggestion(issueData) {
        // Simulate AI analysis of issue to suggest escalation level
        let suggestedLevel = 1;
        let reason = 'Team can handle at current level';
        let confidence = 70;
        
        // Check for keywords and patterns
        const description = (issueData.description || '').toLowerCase();
        const category = (issueData.category || '').toLowerCase();
        
        // High-impact keywords suggest higher escalation
        if (description.includes('recurring') || description.includes('multiple') || description.includes('repeated')) {
          suggestedLevel = 2;
          reason = 'Recurring issue requires area-level investigation';
          confidence = 85;
        }
        
        if (category === 'electrical' || category === 'safety' || description.includes('safety')) {
          suggestedLevel = 3;
          reason = 'Safety-critical issue requires immediate management attention';
          confidence = 95;
        }
        
        if (description.includes('downtime >') || description.includes('stopped')) {
          const match = description.match(/(\d+)\s*(min|hour)/i);
          if (match && parseInt(match[1]) > 30) {
            suggestedLevel = 2;
            reason = 'Extended downtime (>30min) requires area leader coordination';
            confidence = 88;
          }
        }
        
        if (issueData.priority === 'HIGH' && (category === 'quality' || category === 'mechanical')) {
          suggestedLevel = 2;
          reason = 'High priority issue with production impact';
          confidence = 82;
        }
        
        return {
          suggestedLevel: suggestedLevel,
          reason: reason,
          confidence: confidence
        };
      },
      
      processNaturalLanguageQuery(query) {
        // Simulate AI-powered natural language search
        const queryLower = query.toLowerCase();
        const results = {
          query: query,
          timestamp: new Date().toISOString(),
          matches: [],
          summary: ''
        };
        
        // Search issues
        this.issues.forEach(issue => {
          let score = 0;
          const searchableText = (issue.title + ' ' + issue.description + ' ' + 
                                 (issue.category || '') + ' ' + (issue.area || '')).toLowerCase();
          
          // Keyword matching
          if (queryLower.includes('electrical') && (issue.category || '').toLowerCase() === 'electrical') score += 10;
          if (queryLower.includes('quality') && (issue.category || '').toLowerCase() === 'quality') score += 10;
          if (queryLower.includes('mechanical') && (issue.category || '').toLowerCase() === 'mechanical') score += 10;
          if (queryLower.includes('this month') || queryLower.includes('last month')) {
            const issueDate = new Date(issue.dateCreated);
            const now = new Date();
            if (issueDate.getMonth() === now.getMonth()) score += 8;
          }
          if (queryLower.includes('open') && issue.status === 'OPEN') score += 5;
          if (queryLower.includes('resolved') && issue.status === 'RESOLVED') score += 5;
          if (queryLower.includes('high priority') && issue.priority === 'HIGH') score += 5;
          
          // General text matching
          queryLower.split(' ').forEach(word => {
            if (word.length > 3 && searchableText.includes(word)) score += 2;
          });
          
          if (score > 0) {
            results.matches.push({ issue: issue, relevance: score });
          }
        });
        
        // Sort by relevance
        results.matches.sort((a, b) => b.relevance - a.relevance);
        
        // Generate summary
        if (results.matches.length === 0) {
          results.summary = 'No matching issues found for your query.';
        } else {
          results.summary = 'Found ' + results.matches.length + ' matching issue(s). ';
          const topCategories = {};
          results.matches.forEach(m => {
            const cat = m.issue.category || 'Other';
            topCategories[cat] = (topCategories[cat] || 0) + 1;
          });
          const catList = Object.entries(topCategories).map(e => e[1] + ' ' + e[0]).join(', ');
          results.summary += 'Categories: ' + catList;
        }
        
        // Save to history
        this.aiAssistant.queryHistory.unshift(results);
        if (this.aiAssistant.queryHistory.length > 10) this.aiAssistant.queryHistory.pop();
        
        return results;
      },
      
      generateAIReport(reportType) {
        // Simulate AI-generated reports
        const report = {
          type: reportType,
          generated: new Date().toISOString(),
          data: {}
        };
        
        if (reportType === 'resolution-times') {
          const resolved = this.issues.filter(i => i.status === 'RESOLVED' && i.resolutionTime);
          report.data.averageHours = resolved.length > 0 ? 
            Math.round(resolved.reduce((sum, i) => sum + i.resolutionTime, 0) / resolved.length) : 0;
          report.data.fastest = resolved.length > 0 ? Math.min(...resolved.map(i => i.resolutionTime)) : 0;
          report.data.slowest = resolved.length > 0 ? Math.max(...resolved.map(i => i.resolutionTime)) : 0;
          report.data.total = resolved.length;
        } else if (reportType === 'category-breakdown') {
          const categories = {};
          this.issues.forEach(i => {
            const cat = i.category || 'Uncategorized';
            categories[cat] = (categories[cat] || 0) + 1;
          });
          report.data.categories = categories;
        } else if (reportType === 'escalation-analysis') {
          const byLevel = { 1: 0, 2: 0, 3: 0 };
          this.issues.forEach(i => byLevel[i.level]++);
          report.data.byLevel = byLevel;
          report.data.escalationRate = this.issues.filter(i => i.escalatedFrom).length / this.issues.length;
        }
        
        return report;
      },
      
      addGembaIssue(issueData) {
        this.gembaWalkData.issues.push(issueData);
        this.closeModal();
      },
      
      viewMachineLive(machineId) {
        const machine = this.getMachine(machineId);
        if (!machine) return;
        
        const currentShift = this.getCurrentShift();
        const shiftStart = currentShift === 'Early' ? 6 : currentShift === 'Late' ? 14 : 22;
        const shiftEnd = currentShift === 'Early' ? 14 : currentShift === 'Late' ? 22 : 6;
        const shiftHours = currentShift === 'Night' ? 
          Array.from({length: 24 - 22}, (_, i) => 22 + i).concat(Array.from({length: 6}, (_, i) => i)) :
          Array.from({length: shiftEnd - shiftStart}, (_, i) => shiftStart + i);
        const currentHour = new Date().getHours();
        const savedData = this.getProductionData(machineId);
        
        const liveViewHtml = '<div class="card" style="background: #f0f8ff; border: 3px solid #000">' +
          '<div class="card-header">' +
            '<div class="card-title">LIVE DATA - ' + machine.name + '</div>' +
            '<button class="btn" style="font-size: 0.85rem" onclick="document.getElementById(\'level2-live-view\').innerHTML = \'\'">Close</button>' +
          '</div>' +
          '<div class="info-box">' +
            '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem">' +
              '<div><strong>Machine ID:</strong> ' + machine.id + '</div>' +
              '<div><strong>Operator:</strong> ' + machine.operator + '</div>' +
              '<div><strong>Part:</strong> ' + machine.part + '</div>' +
              '<div><strong>Current Shift:</strong> ' + currentShift + '</div>' +
              '<div><strong>Time:</strong> ' + currentHour + ':00</div>' +
              '<div><strong>Status:</strong> <span style="color: #2d862d; font-weight: bold">ACTIVE</span></div>' +
            '</div>' +
          '</div>' +
          '<div style="font-weight: bold; margin: 1rem 0 0.5rem 0; font-size: 1.05rem">Hourly Production - Current Shift</div>' +
          '<table class="data-table">' +
            '<thead><tr>' +
              '<th>Hour</th><th>Target</th><th>Actual</th><th>Variance</th><th>Efficiency</th><th>Notes</th>' +
            '</tr></thead>' +
            '<tbody>' +
              shiftHours.map(function(hour) {
                const isPastHour = hour < currentHour || (currentShift === 'Night' && hour >= 22 && currentHour < 6);
                const savedHourData = savedData.find(function(d) { return d.hour === hour; });
                const target = savedHourData ? savedHourData.target : 100;
                const actual = savedHourData ? savedHourData.actual : (isPastHour ? 95 + Math.floor(Math.random() * 10) : '');
                const notes = savedHourData ? savedHourData.notes : '';
                const variance = actual ? actual - target : 0;
                const efficiency = actual ? Math.round((actual / target) * 100) : null;
                const nextHour = (hour + 1) % 24;
                
                return '<tr style="' + (hour === currentHour ? 'background: #fffacd; font-weight: bold' : '') + '">' +
                  '<td>' + hour + ':00-' + nextHour + ':00' + (hour === currentHour ? ' ‚óÑ NOW' : '') + '</td>' +
                  '<td>' + target + '</td>' +
                  '<td>' + (actual || '-') + '</td>' +
                  '<td style="' + (variance < 0 ? 'color: #c41e3a' : variance > 0 ? 'color: #2d862d' : '') + '">' +
                    (variance ? (variance > 0 ? '+' : '') + variance : '-') +
                  '</td>' +
                  '<td>' + (efficiency ? efficiency + '%' : '-') + '</td>' +
                  '<td style="font-size: 0.85rem">' + (notes || '-') + '</td>' +
                '</tr>';
              }).join('') +
            '</tbody>' +
          '</table>' +
          '<div style="margin-top: 1rem; padding: 1rem; background: white; border: 2px solid #000">' +
            '<strong>Shift Summary:</strong> ' +
            'Target: ' + (shiftHours.length * 100) + ' | ' +
            'Actual: ' + savedData.reduce(function(sum, d) { return sum + (d.actual || 0); }, 0) + ' | ' +
            'Efficiency: ' + Math.round((savedData.reduce(function(sum, d) { return sum + (d.actual || 0); }, 0) / (shiftHours.length * 100)) * 100) + '%' +
          '</div>' +
        '</div>';
        
        document.getElementById('level2-live-view').innerHTML = liveViewHtml;
      },
      
      runAIQuery() {
        const query = document.getElementById('ai-query').value;
        if (!query) return;
        
        const results = this.processNaturalLanguageQuery(query);
        const resultsDiv = document.getElementById('ai-results');
        
        let html = '<div style="padding: 1rem; background: white; border: 2px solid #1d4ed8">' +
          '<div style="font-weight: bold; margin-bottom: 0.5rem">üîç Search Results</div>' +
          '<div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem">' + results.summary + '</div>';
        
        if (results.matches.length > 0) {
          html += '<div class="issue-list">';
          results.matches.slice(0, 5).forEach(function(match) {
            const issue = match.issue;
            html += '<div class="issue-item" style="margin-bottom: 0.75rem">' +
              '<div class="issue-header">' +
                '<div class="issue-title">Issue ' + issue.id + ': ' + issue.title + '</div>' +
                '<div class="issue-badge">' + issue.status + '</div>' +
              '</div>' +
              '<div class="issue-meta">' +
                '<span>Category: ' + (issue.category || 'N/A') + '</span>' +
                '<span>Priority: ' + issue.priority + '</span>' +
                '<span>Level: ' + issue.level + '</span>' +
                '<span>Relevance: ' + match.relevance + '%</span>' +
              '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.5rem">' + issue.description + '</div>' +
            '</div>';
          });
          html += '</div>';
          
          if (results.matches.length > 5) {
            html += '<div style="text-align: center; margin-top: 0.5rem; font-size: 0.85rem; color: #666">... and ' + 
              (results.matches.length - 5) + ' more results</div>';
          }
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
      },
      
      generateReport() {
        const resultsDiv = document.getElementById('ai-results');
        const categoryReport = this.generateAIReport('category-breakdown');
        const escalationReport = this.generateAIReport('escalation-analysis');
        
        let html = '<div style="padding: 1rem; background: white; border: 2px solid #1d4ed8">' +
          '<div style="font-weight: bold; margin-bottom: 1rem">üìä AI-Generated Report</div>' +
          '<div style="margin-bottom: 1.5rem">' +
            '<div style="font-weight: bold; margin-bottom: 0.5rem">Issue Breakdown by Category:</div>' +
            '<table class="data-table" style="font-size: 0.9rem">' +
              '<thead><tr><th>Category</th><th>Count</th><th>Percentage</th></tr></thead>' +
              '<tbody>';
        
        const total = this.issues.length;
        Object.entries(categoryReport.data.categories).forEach(function(entry) {
          const pct = Math.round((entry[1] / total) * 100);
          html += '<tr><td>' + entry[0] + '</td><td>' + entry[1] + '</td><td>' + pct + '%</td></tr>';
        });
        
        html += '</tbody></table>' +
          '</div>' +
          '<div>' +
            '<div style="font-weight: bold; margin-bottom: 0.5rem">Escalation Analysis:</div>' +
            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem">' +
              '<div style="padding: 0.75rem; border: 2px solid #000; text-align: center">' +
                '<div style="font-size: 0.85rem">Level 1</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">' + escalationReport.data.byLevel[1] + '</div>' +
              '</div>' +
              '<div style="padding: 0.75rem; border: 2px solid #000; text-align: center">' +
                '<div style="font-size: 0.85rem">Level 2</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">' + escalationReport.data.byLevel[2] + '</div>' +
              '</div>' +
              '<div style="padding: 0.75rem; border: 2px solid #000; text-align: center">' +
                '<div style="font-size: 0.85rem">Level 3</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">' + escalationReport.data.byLevel[3] + '</div>' +
              '</div>' +
            '</div>' +
            '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666">Escalation Rate: ' + 
              Math.round(escalationReport.data.escalationRate * 100) + '%</div>' +
          '</div>' +
          '<div style="margin-top: 1rem; font-size: 0.75rem; color: #999; text-align: right">Generated: ' + 
            new Date().toLocaleString() + '</div>' +
        '</div>';
        
        resultsDiv.innerHTML = html;
      },
      
      showResolutionTimes() {
        const resultsDiv = document.getElementById('ai-results');
        const report = this.generateAIReport('resolution-times');
        
        let html = '<div style="padding: 1rem; background: white; border: 2px solid #1d4ed8">' +
          '<div style="font-weight: bold; margin-bottom: 1rem">‚è±Ô∏è Resolution Time Analysis</div>' +
          '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem">' +
            '<div style="padding: 1rem; border: 2px solid #000; text-align: center">' +
              '<div style="font-size: 0.85rem; color: #666">Average</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + report.data.averageHours + 'h</div>' +
            '</div>' +
            '<div style="padding: 1rem; border: 2px solid #000; text-align: center">' +
              '<div style="font-size: 0.85rem; color: #666">Fastest</div>' +
              '<div style="font-size: 2rem; font-weight: bold; color: #2d862d">' + report.data.fastest + 'h</div>' +
            '</div>' +
            '<div style="padding: 1rem; border: 2px solid #000; text-align: center">' +
              '<div style="font-size: 0.85rem; color: #666">Slowest</div>' +
              '<div style="font-size: 2rem; font-weight: bold; color: #c41e3a">' + report.data.slowest + 'h</div>' +
            '</div>' +
            '<div style="padding: 1rem; border: 2px solid #000; text-align: center">' +
              '<div style="font-size: 0.85rem; color: #666">Resolved</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + report.data.total + '</div>' +
            '</div>' +
          '</div>' +
          '<div style="margin-top: 1rem; font-size: 0.85rem; color: #666">' +
            'Time from issue identification to resolution. Tracking ' + report.data.total + ' resolved issues.' +
          '</div>' +
          '<div style="margin-top: 1rem; font-size: 0.75rem; color: #999; text-align: right">Generated: ' + 
            new Date().toLocaleString() + '</div>' +
        '</div>';
        
        resultsDiv.innerHTML = html;
      },
      
      saveShiftHandover() {
        const notes = document.getElementById('handover-notes').value;
        const currentShift = this.getCurrentShift();
        
        if (notes.trim()) {
          this.shiftHandover[currentShift] = {
            notes: notes,
            completedBy: 'Shift Leader', // In real app, this would be current user
            timestamp: new Date().toLocaleString()
          };
          alert('Shift handover notes saved successfully!');
          this.render();
        }
      },
      
      completeGembaWalk() {
        this.gembaWalkData.issues.forEach(issue => {
          this.issues.push({
            id: this.nextIssueId++,
            ...issue,
            status: 'OPEN',
            dateCreated: new Date().toISOString().split('T')[0],
            source: 'Gemba Walk'
          });
        });
        
        this.gembaWalkStep = 1;
        this.gembaWalkData = {
          targetAreas: '',
          focus: '',
          participants: '',
          findings: [],
          issues: []
        };
        this.closeModal();
        this.setView('escalations');
      },
      
      render() {
        const container = document.getElementById('app');
        
        if (!this.currentUser) {
          container.innerHTML = this.renderLogin();
        } else {
          container.innerHTML = '<div class="app-container">' +
            this.renderSidebar() +
            '<div class="main-container">' +
              this.renderContentHeader() +
              '<main class="main-content">' +
                this.renderCurrentView() +
              '</main>' +
            '</div>' +
          '</div>' +
          (this.showModal ? this.renderModal() : '');
        }
        
        this.attachEventListeners();
      },
      
      renderLogin() {
        const self = this;
        return '<div class="login-screen">' +
          '<div class="login-card">' +
            '<div class="login-title">GEMBA</div>' +
            '<div class="login-subtitle">Shopfloor Management System</div>' +
            '<div style="margin: 1.5rem 0; text-align: center">' +
              '<label style="font-size: 0.75rem; text-transform: uppercase; color: #666; display: block; margin-bottom: 0.5rem">üåç Language / Sprache / Langue</label>' +
              '<select id="language-selector" class="form-select" style="padding: 0.5rem; font-size: 0.9rem; max-width: 300px; margin: 0 auto">' +
                Object.keys(this.languages).map(function(langKey) {
                  return '<option value="' + langKey + '" ' + (self.currentLanguage === langKey ? 'selected' : '') + '>' +
                    self.languages[langKey].flag + ' ' + self.languages[langKey].name +
                  '</option>';
                }).join('') +
              '</select>' +
            '</div>' +
            '<form id="login-form" style="margin-bottom: 2rem">' +
              '<div class="form-group">' +
                '<label class="form-label" style="font-size: 0.9rem">' + this.t('username') + '</label>' +
                '<input type="text" class="form-input" placeholder="' + this.t('username') + '" required />' +
              '</div>' +
              '<div class="form-group">' +
                '<label class="form-label" style="font-size: 0.9rem">' + this.t('password') + '</label>' +
                '<input type="password" class="form-input" placeholder="' + this.t('password') + '" required />' +
              '</div>' +
              '<button type="submit" class="login-btn login-btn-primary" style="width: 100%">' + this.t('login') + '</button>' +
            '</form>' +
            '<div style="text-align: center; margin: 2rem 0; color: #999; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px">' +
              this.t('select_access') +
            '</div>' +
            '<div class="login-options">' +
              '<button class="login-btn" data-role="level1" style="padding: 0.75rem; font-size: 0.9rem">' +
                this.t('level1') +
              '</button>' +
              '<button class="login-btn" data-role="level2" style="padding: 0.75rem; font-size: 0.9rem">' +
                this.t('level2') +
              '</button>' +
              '<button class="login-btn" data-role="level3" style="padding: 0.75rem; font-size: 0.9rem">' +
                this.t('level3') +
              '</button>' +
              '<button class="login-btn" data-role="admin" style="padding: 0.75rem; font-size: 0.9rem">' +
                'Admin Configuration' +
              '</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      },
      
      renderSidebar() {
        const roleNames = {
          'level1': 'Team Member',
          'level2': 'Area Leader',
          'level3': 'Plant Manager',
          'admin': 'Administrator'
        };
        
        const accessLevel = this.currentUser === 'admin' ? 'Admin' : 'Level ' + this.currentUser.slice(-1);
        
        return '<aside class="sidebar">' +
          '<div class="sidebar-header">' +
            '<div class="logo">GEMBA</div>' +
            '<div class="subtitle">Shopfloor Management</div>' +
            '<div class="user-info">' +
              '<div><strong>Role:</strong> ' + roleNames[this.currentUser] + '</div>' +
              '<div><strong>Access:</strong> ' + accessLevel + '</div>' +
            '</div>' +
          '</div>' +
          '<nav class="sidebar-nav">' +
            (this.currentUser === 'admin' ? 
              '<div class="nav-section">' +
                '<div class="nav-section-title">Admin Configuration</div>' +
                '<button class="nav-item ' + (this.currentView === 'admin-workstations' ? 'active' : '') + '" data-view="admin-workstations">' +
                  'Workstations' +
                '</button>' +
                '<button class="nav-item ' + (this.currentView === 'admin-categories' ? 'active' : '') + '" data-view="admin-categories">' +
                  'Categories' +
                '</button>' +
                '<button class="nav-item ' + (this.currentView === 'admin-areas' ? 'active' : '') + '" data-view="admin-areas">' +
                  'Areas' +
                '</button>' +
                '<button class="nav-item ' + (this.currentView === 'admin-teams' ? 'active' : '') + '" data-view="admin-teams">' +
                  'Teams' +
                '</button>' +
                '<button class="nav-item ' + (this.currentView === 'admin-operators' ? 'active' : '') + '" data-view="admin-operators">' +
                  'Operators' +
                '</button>' +
              '</div>' :
              '<div class="nav-section">' +
                '<div class="nav-section-title">Management Levels</div>' +
                (this.canAccessView('level1') ? 
                  '<button class="nav-item ' + (this.currentView === 'level1' ? 'active' : '') + '" data-view="level1">' +
                    'Level 1 - Teams' +
                  '</button>' : '') +
                (this.canAccessView('level2') ? 
                  '<button class="nav-item ' + (this.currentView === 'level2' ? 'active' : '') + '" data-view="level2">' +
                    'Level 2 - Areas' +
                  '</button>' : '') +
                (this.canAccessView('level3') ? 
                  '<button class="nav-item ' + (this.currentView === 'level3' ? 'active' : '') + '" data-view="level3">' +
                    'Level 3 - Plant' +
                  '</button>' : '') +
              '</div>' +
              '<div class="nav-section">' +
                '<div class="nav-section-title">Issue Management</div>' +
                (this.canAccessView('escalations') ? 
                  '<button class="nav-item ' + (this.currentView === 'escalations' ? 'active' : '') + '" data-view="escalations">' +
                    'Issue Escalations' +
                  '</button>' : '') +
                (this.canAccessView('resolution') ? 
                  '<button class="nav-item ' + (this.currentView === 'resolution' ? 'active' : '') + '" data-view="resolution">' +
                    'Issue Resolution' +
                  '</button>' : '') +
                (this.canAccessView('dashboard') ? 
                  '<button class="nav-item ' + (this.currentView === 'dashboard' ? 'active' : '') + '" data-view="dashboard">' +
                    'Issue Dashboard' +
                  '</button>' : '') +
                (this.canAccessView('issue-history') ? 
                  '<button class="nav-item ' + (this.currentView === 'issue-history' ? 'active' : '') + '" data-view="issue-history">' +
                    'Issue History & Analytics' +
                  '</button>' : '') +
              '</div>' +
              '<div class="nav-section">' +
                '<div class="nav-section-title">Management Tools</div>' +
                (this.canAccessView('safety-cross') ? 
                  '<button class="nav-item ' + (this.currentView === 'safety-cross' ? 'active' : '') + '" data-view="safety-cross">' +
                    'Safety Cross' +
                  '</button>' : '') +
                (this.canAccessView('gemba-walk') ? 
                  '<button class="nav-item ' + (this.currentView === 'gemba-walk' ? 'active' : '') + '" data-view="gemba-walk">' +
                    'Gemba Walk' +
                  '</button>' : '') +
              '</div>'
            ) +
          '</nav>' +
          '<div class="sidebar-footer">' +
            '<div style="padding: 0.75rem 0; margin-bottom: 0.75rem; font-size: 0.85rem">' +
              '<label style="font-size: 0.75rem; text-transform: uppercase; color: #666; display: block; margin-bottom: 0.5rem">Language / Langue / Sprache</label>' +
              '<select id="sidebar-language-selector" class="form-select" style="padding: 0.5rem; font-size: 0.85rem; width: 100%">' +
                Object.keys(this.languages).map((langKey) => {
                  const lang = this.languages[langKey];
                  return '<option value="' + langKey + '" ' + (this.currentLanguage === langKey ? 'selected' : '') + '>' +
                    lang.flag + ' ' + lang.name +
                  '</option>';
                }).join('') +
              '</select>' +
            '</div>' +
            '<div style="padding: 0.75rem 0; border-top: 2px solid #ccc; border-bottom: 2px solid #ccc; margin-bottom: 0.75rem; font-size: 0.85rem">' +
              '<div><strong>' + this.t('current_shift') + ':</strong> ' + this.getCurrentShift() + '</div>' +
              '<div>' + this.getShiftTime(this.getCurrentShift()) + '</div>' +
            '</div>' +
            '<button class="logout-btn" data-action="logout">' + this.t('logout') + '</button>' +
          '</div>' +
        '</aside>';
      },
      
      renderContentHeader() {
        const titles = {
          'level1': 'Level 1 - Team Performance',
          'level2': 'Level 2 - Area Performance',
          'level3': 'Level 3 - Plant Performance',
          'gemba-walk': 'Gemba Walk Process',
          'escalations': 'Issue Escalations',
          'resolution': 'Issue Resolution',
          'dashboard': 'Issue Management Dashboard',
          'issue-history': 'Issue History & Analytics',
          'safety-cross': 'Safety Cross - Daily Safety Tracking',
          'admin-workstations': 'Admin - Workstations Configuration',
          'admin-categories': 'Admin - Issue Categories Configuration',
          'admin-areas': 'Admin - Areas Configuration',
          'admin-teams': 'Admin - Teams Configuration',
          'admin-operators': 'Admin - Operators Configuration'
        };
        
        return '<div class="content-header">' +
          '<h1>' + titles[this.currentView] + '</h1>' +
          '<div class="breadcrumb">Shopfloor Management / ' + titles[this.currentView] + '</div>' +
        '</div>';
      },
      
      renderCurrentView() {
        if (!this.canAccessView(this.currentView)) {
          return '<div class="card"><div class="empty-state">' +
            '<div style="font-size: 1.2rem; margin-bottom: 1rem;">Access Denied</div>' +
            '<div>You do not have permission to access this section.</div>' +
          '</div></div>';
        }
        
        switch(this.currentView) {
          case 'level1': return this.renderLevel1();
          case 'level2': return this.renderLevel2();
          case 'level3': return this.renderLevel3();
          case 'gemba-walk': return this.renderGembaWalk();
          case 'escalations': return this.renderEscalations();
          case 'resolution': return this.renderResolution();
          case 'dashboard': return this.renderDashboard();
          case 'issue-history': return this.renderIssueHistory();
          case 'safety-cross': return this.renderSafetyCross();
          case 'admin-workstations': return this.renderAdminWorkstations();
          case 'admin-categories': return this.renderAdminCategories();
          case 'admin-areas': return this.renderAdminAreas();
          case 'admin-teams': return this.renderAdminTeams();
          case 'admin-operators': return this.renderAdminOperators();
          default: return '';
        }
      },
      
      renderIssueHistory() {
        // Sort issues by date (newest first)
        const sortedIssues = this.issues.slice().sort((a, b) => {
          const dateA = new Date(a.dateCreated + ' ' + a.time);
          const dateB = new Date(b.dateCreated + ' ' + b.time);
          return dateB - dateA;
        });
        
        // Calculate statistics
        const totalIssues = this.issues.length;
        const resolvedIssues = this.issues.filter(i => i.status === 'RESOLVED').length;
        const escalatedIssues = this.issues.filter(i => i.status === 'ESCALATED' || i.escalatedFrom).length;
        const openIssues = this.issues.filter(i => i.status === 'OPEN').length;
        const gembaIssues = this.issues.filter(i => i.source === 'gemba').length;
        const productionIssues = this.issues.filter(i => i.source === 'production' || !i.source).length;
        
        // Average resolution time
        const resolvedWithTime = this.issues.filter(i => i.status === 'RESOLVED' && i.resolvedDate);
        let avgResolutionHours = 0;
        if (resolvedWithTime.length > 0) {
          const totalHours = resolvedWithTime.reduce((sum, issue) => {
            const created = new Date(issue.dateCreated + ' ' + issue.time);
            const resolved = new Date(issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00'));
            return sum + ((resolved - created) / (1000 * 60 * 60));
          }, 0);
          avgResolutionHours = (totalHours / resolvedWithTime.length).toFixed(1);
        }
        
        // Category breakdown
        const categoryStats = {};
        this.issues.forEach(issue => {
          if (!categoryStats[issue.category]) {
            categoryStats[issue.category] = { total: 0, resolved: 0 };
          }
          categoryStats[issue.category].total++;
          if (issue.status === 'RESOLVED') {
            categoryStats[issue.category].resolved++;
          }
        });
        
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Issue History Overview</div>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem">' +
            '<div style="border: 2px solid #000; padding: 1rem; text-align: center">' +
              '<div style="font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 0.5rem">Total Issues</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + totalIssues + '</div>' +
            '</div>' +
            '<div style="border: 2px solid #000; padding: 1rem; text-align: center">' +
              '<div style="font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 0.5rem">Resolved</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + resolvedIssues + '</div>' +
              '<div style="font-size: 0.75rem; color: #666">' + Math.round((resolvedIssues / totalIssues) * 100) + '%</div>' +
            '</div>' +
            '<div style="border: 2px solid #000; padding: 1rem; text-align: center">' +
              '<div style="font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 0.5rem">Escalated</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + escalatedIssues + '</div>' +
              '<div style="font-size: 0.75rem; color: #666">' + Math.round((escalatedIssues / totalIssues) * 100) + '%</div>' +
            '</div>' +
            '<div style="border: 2px solid #000; padding: 1rem; text-align: center">' +
              '<div style="font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 0.5rem">Open</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + openIssues + '</div>' +
            '</div>' +
            '<div style="border: 2px solid #000; padding: 1rem; text-align: center">' +
              '<div style="font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 0.5rem">Avg Resolution</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + avgResolutionHours + '</div>' +
              '<div style="font-size: 0.75rem; color: #666">hours</div>' +
            '</div>' +
            '<div style="border: 2px solid #000; padding: 1rem; text-align: center">' +
              '<div style="font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 0.5rem">Gemba Issues</div>' +
              '<div style="font-size: 2rem; font-weight: bold">' + gembaIssues + '</div>' +
              '<div style="font-size: 0.75rem; color: #666">' + Math.round((gembaIssues / totalIssues) * 100) + '%</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Category Breakdown</div>' +
          '</div>' +
          '<table class="data-table">' +
            '<thead><tr>' +
              '<th>Category</th>' +
              '<th>Total Issues</th>' +
              '<th>Resolved</th>' +
              '<th>Open</th>' +
              '<th>Resolution Rate</th>' +
            '</tr></thead>' +
            '<tbody>' +
              Object.keys(categoryStats).map(category => {
                const stats = categoryStats[category];
                const rate = Math.round((stats.resolved / stats.total) * 100);
                return '<tr>' +
                  '<td><strong>' + category + '</strong></td>' +
                  '<td>' + stats.total + '</td>' +
                  '<td>' + stats.resolved + '</td>' +
                  '<td>' + (stats.total - stats.resolved) + '</td>' +
                  '<td><strong>' + rate + '%</strong></td>' +
                '</tr>';
              }).join('') +
            '</tbody>' +
          '</table>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Complete Issue History</div>' +
            '<div style="display: flex; gap: 0.5rem">' +
              '<select class="form-select" id="history-filter-status" style="width: 150px; font-size: 0.85rem">' +
                '<option value="">All Status</option>' +
                '<option value="OPEN">Open</option>' +
                '<option value="ESCALATED">Escalated</option>' +
                '<option value="RESOLVED">Resolved</option>' +
              '</select>' +
              '<select class="form-select" id="history-filter-source" style="width: 150px; font-size: 0.85rem">' +
                '<option value="">All Sources</option>' +
                '<option value="gemba">Gemba Walk</option>' +
                '<option value="production">Production</option>' +
              '</select>' +
              '<select class="form-select" id="history-filter-category" style="width: 150px; font-size: 0.85rem">' +
                '<option value="">All Categories</option>' +
                Object.keys(categoryStats).map(cat => 
                  '<option value="' + cat + '">' + cat + '</option>'
                ).join('') +
              '</select>' +
            '</div>' +
          '</div>' +
          '<table class="data-table">' +
            '<thead><tr>' +
              '<th>ID</th>' +
              '<th>Date</th>' +
              '<th>Title</th>' +
              '<th>Category</th>' +
              '<th>Source</th>' +
              '<th>Priority</th>' +
              '<th>Level</th>' +
              '<th>Status</th>' +
              '<th>Escalation Path</th>' +
              '<th>Resolution Time</th>' +
              '<th>Actions</th>' +
            '</tr></thead>' +
            '<tbody>' +
              sortedIssues.map(issue => {
                let resolutionTime = '-';
                if (issue.status === 'RESOLVED' && issue.resolvedDate) {
                  const created = new Date(issue.dateCreated + ' ' + issue.time);
                  const resolved = new Date(issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00'));
                  const hours = ((resolved - created) / (1000 * 60 * 60)).toFixed(1);
                  resolutionTime = hours + 'h';
                }
                
                let escalationPath = 'L' + issue.level;
                if (issue.escalatedFrom) {
                  escalationPath = 'L' + issue.escalatedFrom + ' ‚Üí L' + issue.level;
                }
                
                const sourceLabel = issue.source === 'gemba' ? 'Gemba' : 'Production';
                const sourceBg = issue.source === 'gemba' ? '#f0f0f0' : '#fff';
                
                return '<tr data-issue-status="' + issue.status + '" data-issue-source="' + (issue.source || 'production') + '" data-issue-category="' + issue.category + '">' +
                  '<td><strong>' + issue.id + '</strong></td>' +
                  '<td>' + issue.dateCreated + '<br><span style="font-size: 0.85rem; color: #666">' + issue.time + '</span></td>' +
                  '<td style="max-width: 250px"><strong>' + issue.title + '</strong><br><span style="font-size: 0.85rem; color: #666">' + issue.area + '</span></td>' +
                  '<td>' + issue.category + '</td>' +
                  '<td><span style="padding: 0.25rem 0.5rem; background: ' + sourceBg + '; border: 1px solid #000; font-size: 0.75rem; font-weight: bold">' + sourceLabel + '</span></td>' +
                  '<td>' + issue.priority + '</td>' +
                  '<td>Level ' + issue.level + '</td>' +
                  '<td><strong>' + issue.status + '</strong></td>' +
                  '<td>' + escalationPath + '</td>' +
                  '<td>' + resolutionTime + '</td>' +
                  '<td><button class="btn" style="padding: 0.5rem; font-size: 0.75rem" data-modal="issue-detail" data-issue-id="' + issue.id + '">View</button></td>' +
                '</tr>';
              }).join('') +
            '</tbody>' +
          '</table>' +
        '</div>';
      },
      
      renderAdminWorkstations() {
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Workstations Management</div>' +
            '<button class="btn btn-primary" data-modal="add-workstation">+ Add Workstation</button>' +
          '</div>' +
          '<table class="data-table">' +
            '<thead><tr>' +
              '<th>ID</th><th>Name</th><th>Area</th><th>Team</th><th>Actions</th>' +
            '</tr></thead>' +
            '<tbody>' +
              this.adminConfig.workstations.map(ws => 
                '<tr>' +
                  '<td><strong>' + ws.id + '</strong></td>' +
                  '<td>' + ws.name + '</td>' +
                  '<td>' + ws.area + '</td>' +
                  '<td>' + ws.team + '</td>' +
                  '<td>' +
                    '<button class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-right: 0.5rem" data-modal="edit-workstation" data-ws-id="' + ws.id + '">Edit</button>' +
                    '<button class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #000; color: white" data-modal="delete-workstation" data-ws-id="' + ws.id + '">Delete</button>' +
                  '</td>' +
                '</tr>'
              ).join('') +
            '</tbody>' +
          '</table>' +
          '<div style="margin-top: 1.5rem; padding: 1rem; background: #fafafa; border: 2px solid #000">' +
            '<div style="font-weight: bold; margin-bottom: 0.5rem">Save Configuration</div>' +
            '<button class="btn btn-primary" onclick="app.saveAdminConfig()">Save All Changes to LocalStorage</button>' +
          '</div>' +
        '</div>';
      },
      
      renderAdminCategories() {
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Issue Categories</div>' +
          '</div>' +
          '<div style="margin-bottom: 1rem">' +
            '<input type="text" class="form-input" id="new-category-input" placeholder="Enter new category name" style="width: 300px; display: inline-block; margin-right: 0.5rem" />' +
            '<button class="btn btn-primary" onclick="app.addCategory(document.getElementById(\'new-category-input\').value); document.getElementById(\'new-category-input\').value=\'\';">+ Add Category</button>' +
          '</div>' +
          '<div style="display: flex; flex-wrap: wrap; gap: 1rem">' +
            this.adminConfig.categories.map(cat => 
              '<div style="padding: 0.75rem 1rem; border: 3px solid #000; background: #fafafa; display: flex; align-items: center; gap: 0.75rem">' +
                '<strong>' + cat + '</strong>' +
                '<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #000; color: white" onclick="app.deleteCategory(\'' + cat + '\')">√ó</button>' +
              '</div>'
            ).join('') +
          '</div>' +
          '<div style="margin-top: 1.5rem; padding: 1rem; background: #fafafa; border: 2px solid #000">' +
            '<button class="btn btn-primary" onclick="app.saveAdminConfig()">Save Configuration</button>' +
          '</div>' +
        '</div>';
      },
      
      renderAdminAreas() {
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Production Areas</div>' +
          '</div>' +
          '<div style="margin-bottom: 1rem">' +
            '<input type="text" class="form-input" id="new-area-input" placeholder="Enter new area name" style="width: 300px; display: inline-block; margin-right: 0.5rem" />' +
            '<button class="btn btn-primary" onclick="app.addArea(document.getElementById(\'new-area-input\').value); document.getElementById(\'new-area-input\').value=\'\';">+ Add Area</button>' +
          '</div>' +
          '<div style="display: flex; flex-wrap: wrap; gap: 1rem">' +
            this.adminConfig.areas.map(area => 
              '<div style="padding: 0.75rem 1rem; border: 3px solid #000; background: #fafafa; display: flex; align-items: center; gap: 0.75rem">' +
                '<strong>' + area + '</strong>' +
                '<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #000; color: white" onclick="app.deleteArea(\'' + area + '\')">√ó</button>' +
              '</div>'
            ).join('') +
          '</div>' +
          '<div style="margin-top: 1.5rem; padding: 1rem; background: #fafafa; border: 2px solid #000">' +
            '<button class="btn btn-primary" onclick="app.saveAdminConfig()">Save Configuration</button>' +
          '</div>' +
        '</div>';
      },
      
      renderAdminTeams() {
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Teams</div>' +
          '</div>' +
          '<div style="margin-bottom: 1rem">' +
            '<input type="text" class="form-input" id="new-team-input" placeholder="Enter new team name" style="width: 300px; display: inline-block; margin-right: 0.5rem" />' +
            '<button class="btn btn-primary" onclick="app.addTeam(document.getElementById(\'new-team-input\').value); document.getElementById(\'new-team-input\').value=\'\';">+ Add Team</button>' +
          '</div>' +
          '<div style="display: flex; flex-wrap: wrap; gap: 1rem">' +
            this.adminConfig.teams.map(team => 
              '<div style="padding: 0.75rem 1rem; border: 3px solid #000; background: #fafafa; display: flex; align-items: center; gap: 0.75rem">' +
                '<strong>' + team + '</strong>' +
                '<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #000; color: white" onclick="app.deleteTeam(\'' + team + '\')">√ó</button>' +
              '</div>'
            ).join('') +
          '</div>' +
          '<div style="margin-top: 1.5rem; padding: 1rem; background: #fafafa; border: 2px solid #000">' +
            '<button class="btn btn-primary" onclick="app.saveAdminConfig()">Save Configuration</button>' +
          '</div>' +
        '</div>';
      },
      
      renderAdminOperators() {
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Operators</div>' +
          '</div>' +
          '<div style="margin-bottom: 1rem">' +
            '<input type="text" class="form-input" id="new-operator-input" placeholder="Enter operator name" style="width: 300px; display: inline-block; margin-right: 0.5rem" />' +
            '<button class="btn btn-primary" onclick="app.addOperator(document.getElementById(\'new-operator-input\').value); document.getElementById(\'new-operator-input\').value=\'\';">+ Add Operator</button>' +
          '</div>' +
          '<div style="display: flex; flex-wrap: wrap; gap: 1rem">' +
            this.adminConfig.operators.map(op => 
              '<div style="padding: 0.75rem 1rem; border: 3px solid #000; background: #fafafa; display: flex; align-items: center; gap: 0.75rem">' +
                '<strong>' + op + '</strong>' +
                '<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #000; color: white" onclick="app.deleteOperator(\'' + op + '\')">√ó</button>' +
              '</div>'
            ).join('') +
          '</div>' +
          '<div style="margin-top: 1.5rem; padding: 1rem; background: #fafafa; border: 2px solid #000">' +
            '<button class="btn btn-primary" onclick="app.saveAdminConfig()">Save Configuration</button>' +
          '</div>' +
        '</div>';
      },
      
      renderLevel1() {
        // If no machine selected, show selection screen
        if (!this.currentMachine) {
          return '<div class="card">' +
            '<div class="card-header">' +
              '<div class="card-title">Select Your Workstation</div>' +
            '</div>' +
            '<div style="margin-bottom: 1rem">' +
              '<label class="form-label">Choose your machine/workstation:</label>' +
              '<select class="form-select" id="machine-selector" style="font-size: 1rem; padding: 0.75rem">' +
                '<option value="">-- Select Workstation --</option>' +
                this.machines.filter(m => m.team === 'Team A').map(machine =>
                  '<option value="' + machine.id + '">' + machine.name + ' (' + machine.id + ')</option>'
                ).join('') +
              '</select>' +
            '</div>' +
            '<button class="btn btn-primary" onclick="app.setMachine(document.getElementById(\'machine-selector\').value)">Confirm Selection</button>' +
          '</div>';
        }
        
        const machine = this.getMachine(this.currentMachine);
        const level1Issues = this.issues.filter(i => i.level === 1 && i.status !== 'RESOLVED');
        const currentHour = new Date().getHours();
        const currentShift = this.getCurrentShift();
        const shiftStart = currentShift === 'Early' ? 6 : currentShift === 'Late' ? 14 : 22;
        const shiftEnd = currentShift === 'Early' ? 14 : currentShift === 'Late' ? 22 : 6;
        const shiftHours = currentShift === 'Night' ? 
          Array.from({length: 24 - 22}, (_, i) => 22 + i).concat(Array.from({length: 6}, (_, i) => i)) :
          Array.from({length: shiftEnd - shiftStart}, (_, i) => shiftStart + i);
        
        const currentDate = new Date().toISOString().split('T')[0];
        const todayShiftEntry = this.safetyCross.entries.find(e => e.date === currentDate && e.shift === currentShift);
        const savedData = this.getProductionData(this.currentMachine);
        
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Hourly Production Entry</div>' +
            '<button class="btn" style="font-size: 0.85rem" onclick="app.setMachine(null)">Change Workstation</button>' +
          '</div>' +
          '<div class="info-box">' +
            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">' +
              '<div><strong>Workstation:</strong> ' + machine.name + '</div>' +
              '<div><strong>Machine ID:</strong> ' + machine.id + '</div>' +
              '<div><strong>Operator:</strong> ' + machine.operator + '</div>' +
              '<div><strong>Part Number:</strong> ' + machine.part + '</div>' +
              '<div><strong>Shift:</strong> ' + currentShift + ' (' + this.getShiftTime(currentShift) + ')</div>' +
            '</div>' +
          '</div>' +
          '<table class="data-table">' +
            '<thead>' +
              '<tr>' +
                '<th>Hour</th>' +
                '<th>Target</th>' +
                '<th>Actual</th>' +
                '<th>Part Numbers</th>' +
                '<th>Variance</th>' +
                '<th>Notes</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' +
              shiftHours.map((hour, i) => {
                const isPastHour = hour < currentHour || (currentShift === 'Night' && hour >= 22 && currentHour < 6);
                const savedHourData = savedData.find(d => d.hour === hour);
                const target = savedHourData ? savedHourData.target : 100;
                const actual = savedHourData ? savedHourData.actual : (isPastHour ? '' : '');
                const partNumbers = savedHourData && savedHourData.partNumbers ? savedHourData.partNumbers.join(', ') : '';
                const note = savedHourData ? savedHourData.notes : '';
                const variance = actual ? actual - target : 0;
                const nextHour = (hour + 1) % 24;
                const rowId = 'hour-' + hour;
                
                return '<tr>' +
                  '<td><strong>' + hour + ':00-' + nextHour + ':00</strong></td>' +
                  '<td>' +
                    '<input type="number" class="form-input hour-target" data-hour="' + hour + '" style="width: 80px; padding: 0.5rem" value="' + target + '" />' +
                  '</td>' +
                  '<td>' +
                    '<input type="number" class="form-input hour-actual" data-hour="' + hour + '" style="width: 80px; padding: 0.5rem" value="' + actual + '" ' +
                    (hour > currentHour && !(currentShift === 'Night' && hour >= 22 && currentHour < 6) ? 'disabled' : '') + ' />' +
                  '</td>' +
                  '<td>' +
                    '<div style="display: flex; align-items: center; gap: 0.5rem">' +
                      '<input type="text" class="form-input hour-parts" data-hour="' + hour + '" style="padding: 0.5rem; flex: 1" value="' + partNumbers + '" ' +
                      'placeholder="P-123-A, P-456-B" ' + (hour > currentHour && !(currentShift === 'Night' && hour >= 22 && currentHour < 6) ? 'disabled' : '') + ' />' +
                      '<button class="btn" style="padding: 0.5rem; font-size: 0.75rem" data-modal="manage-parts" data-hour="' + hour + '" ' +
                      (hour > currentHour && !(currentShift === 'Night' && hour >= 22 && currentHour < 6) ? 'disabled' : '') + '>Manage</button>' +
                    '</div>' +
                  '</td>' +
                  '<td style="font-weight: bold; ' + (variance < 0 ? 'color: #721c24' : variance > 0 ? 'color: #155724' : '') + '">' +
                    (actual ? (variance > 0 ? '+' : '') + variance : '-') +
                  '</td>' +
                  '<td>' +
                    '<input type="text" class="form-input hour-notes" data-hour="' + hour + '" style="padding: 0.5rem" value="' + note + '" ' +
                    'placeholder="Add note if needed" ' + (hour > currentHour && !(currentShift === 'Night' && hour >= 22 && currentHour < 6) ? 'disabled' : '') + ' />' +
                  '</td>' +
                '</tr>';
              }).join('') +
            '</tbody>' +
          '</table>' +
          '<div style="margin-top: 1rem; display: flex; gap: 1rem">' +
            '<button class="btn btn-primary" id="save-shift-data">Save Shift Data</button>' +
            '<button class="btn" data-modal="add-issue" data-level="1">Report Issue</button>' +
          '</div>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">My Open Issues</div>' +
          '</div>' +
          (level1Issues.length === 0 ? 
            '<div class="empty-state"><div>No open issues</div></div>' :
            '<div class="issue-list">' +
              level1Issues.map(issue => 
                '<div class="issue-item">' +
                  '<div class="issue-header">' +
                    '<div class="issue-title">Issue ' + issue.id + ': ' + issue.title + '</div>' +
                    '<div class="issue-badge">' + issue.priority + '</div>' +
                  '</div>' +
                  '<div class="issue-meta">' +
                    '<span>Time: ' + issue.time + '</span>' +
                    '<span>Status: ' + issue.status + '</span>' +
                  '</div>' +
                  '<div class="issue-description">' + issue.description + '</div>' +
                  '<div style="margin-top: 1rem; display: flex; gap: 1rem">' +
                    '<button class="btn" data-modal="escalate" data-issue-id="' + issue.id + '">Escalate</button>' +
                    '<button class="btn" data-modal="resolve" data-issue-id="' + issue.id + '">Resolve</button>' +
                  '</div>' +
                '</div>'
              ).join('') +
            '</div>'
          ) +
        '</div>' +
        '<div class="card" style="border: 3px solid #000; background: #fafafa">' +
          '<div style="display: flex; justify-content: space-between; align-items: center">' +
            '<div>' +
              '<div style="font-weight: bold; margin-bottom: 0.25rem">Safety Status - ' + currentShift + ' Shift</div>' +
              (todayShiftEntry ? 
                '<div style="display: inline-block; padding: 0.25rem 0.75rem; background: ' + 
                  (todayShiftEntry.status === 'safe' ? '#90EE90' : 
                   todayShiftEntry.status === 'near-miss' ? '#FFD700' : '#FFB6C1') + 
                  '; border: 2px solid #000; font-size: 0.85rem; font-weight: bold">' +
                  (todayShiftEntry.status === 'safe' ? '‚úì SAFE' : 
                   todayShiftEntry.status === 'near-miss' ? '! NEAR MISS' : '‚úó INCIDENT') +
                '</div>' :
                '<div style="color: #c41e3a; font-weight: bold; font-size: 0.85rem">‚ö† Not Reported</div>'
              ) +
            '</div>' +
            '<div style="display: flex; gap: 0.5rem">' +
              (todayShiftEntry ? 
                '<button class="btn" style="font-size: 0.85rem" data-action="mark-safety" data-status="' + todayShiftEntry.status + '">Update Status</button>' :
                '<button class="btn" style="background: #90EE90; font-size: 0.85rem" data-action="mark-safety" data-status="safe">Safe</button>' +
                '<button class="btn" style="background: #FFD700; font-size: 0.85rem" data-action="mark-safety" data-status="near-miss">Near Miss</button>' +
                '<button class="btn" style="background: #FFB6C1; font-size: 0.85rem" data-action="mark-safety" data-status="incident">Incident</button>'
              ) +
            '</div>' +
          '</div>' +
          '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #ccc; font-size: 0.85rem; color: #666">' +
            'Plant Days Without Accident: ' + this.safetyCross.daysWithoutAccident +
          '</div>' +
        '</div>';
      },
      
      renderLevel2() {
        const level2Issues = this.issues.filter(i => i.level === 2 && i.status !== 'RESOLVED');
        
        const productionData = [
          {
            line: 'Assembly Line 1',
            stations: [
              { id: 'Station 1', operator: 'John Smith', part: 'P-123-A', target: 800, actual: 785, efficiency: 98, machineId: 'M-301' },
              { id: 'Station 2', operator: 'Lisa Chen', part: 'P-123-A', target: 800, actual: 810, efficiency: 101, machineId: 'M-302' },
              { id: 'Station 3', operator: 'Mike Brown', part: 'P-123-A', target: 800, actual: 750, efficiency: 94, machineId: 'M-303' }
            ]
          },
          {
            line: 'Assembly Line 2',
            stations: [
              { id: 'Station 1', operator: 'Team Member B', part: 'P-456-B', target: 900, actual: 850, efficiency: 94, machineId: 'M-402' },
              { id: 'Station 2', operator: 'Team Member C', part: 'P-456-B', target: 900, actual: 895, efficiency: 99, machineId: 'M-403' },
              { id: 'Station 3', operator: 'Team Member A', part: 'P-456-B', target: 900, actual: 860, efficiency: 96, machineId: 'M-401' }
            ]
          }
        ];
        
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Production Area A - Performance Dashboard</div>' +
          '</div>' +
          '<div class="info-box">' +
            '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center">' +
              '<div>' +
                '<div style="font-size: 0.85rem; color: #666">Total Output</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">5,950</div>' +
              '</div>' +
              '<div>' +
                '<div style="font-size: 0.85rem; color: #666">Target</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">6,200</div>' +
              '</div>' +
              '<div>' +
                '<div style="font-size: 0.85rem; color: #666">Efficiency</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">96%</div>' +
              '</div>' +
              '<div>' +
                '<div style="font-size: 0.85rem; color: #666">Issues</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">' + level2Issues.length + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Live Workstation Monitoring</div>' +
          '</div>' +
          '<div style="margin-bottom: 1rem">' +
            '<label class="form-label">Select workstation to view live data:</label>' +
            '<select class="form-select" id="level2-machine-selector" style="font-size: 0.95rem; padding: 0.6rem">' +
              '<option value="">-- All Workstations Summary --</option>' +
              this.machines.map(machine =>
                '<option value="' + machine.id + '">' + machine.name + ' (' + machine.id + ') - ' + machine.operator + '</option>'
              ).join('') +
            '</select>' +
          '</div>' +
          '<div id="level2-live-view"></div>' +
        '</div>' +
        productionData.map(line => 
          '<div class="card">' +
            '<div class="card-title" style="margin-bottom: 1rem">' + line.line + '</div>' +
            '<table class="data-table">' +
              '<thead>' +
                '<tr>' +
                  '<th>Station</th>' +
                  '<th>Operator</th>' +
                  '<th>Part</th>' +
                  '<th>Target</th>' +
                  '<th>Actual</th>' +
                  '<th>Efficiency</th>' +
                  '<th>Status</th>' +
                  '<th>Actions</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                line.stations.map(station => 
                  '<tr>' +
                    '<td><strong>' + station.id + '</strong></td>' +
                    '<td>' + station.operator + '</td>' +
                    '<td>' + station.part + '</td>' +
                    '<td>' + station.target + '</td>' +
                    '<td><strong>' + station.actual + '</strong></td>' +
                    '<td><strong>' + station.efficiency + '%</strong></td>' +
                    '<td>' + (station.efficiency >= 98 ? 'ON TARGET' : 'BELOW TARGET') + '</td>' +
                    '<td><button class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem" onclick="app.viewMachineLive(\'' + station.machineId + '\')">View Live</button></td>' +
                  '</tr>'
                ).join('') +
              '</tbody>' +
            '</table>' +
            '<div style="margin-top: 1rem; padding: 1rem; background: #fafafa; border: 2px dashed #000">' +
              '<div><strong>Line Summary:</strong></div>' +
              '<div>Total Output: ' + line.stations.reduce((sum, s) => sum + s.actual, 0) + ' / ' +
                line.stations.reduce((sum, s) => sum + s.target, 0) + '</div>' +
              '<div>Average Efficiency: ' + Math.round(line.stations.reduce((sum, s) => sum + s.efficiency, 0) / line.stations.length) + '%</div>' +
            '</div>' +
          '</div>'
        ).join('') +
        '<div class="card" style="background: #fffef0; border: 3px solid #d4a017">' +
          '<div class="card-header">' +
            '<div class="card-title" style="color: #000">üìù Shift Handover Notes</div>' +
          '</div>' +
          '<div style="margin-bottom: 1rem">' +
            '<div style="font-weight: bold; margin-bottom: 0.5rem">Previous Shift (' + (this.getCurrentShift() === 'Early' ? 'Night' : this.getCurrentShift() === 'Late' ? 'Early' : 'Late') + '):</div>' +
            (this.shiftHandover[this.getCurrentShift() === 'Early' ? 'Night' : this.getCurrentShift() === 'Late' ? 'Early' : 'Late'].notes ? 
              '<div style="padding: 1rem; background: white; border: 2px solid #000; margin-bottom: 1rem">' +
                '<div style="font-size: 0.95rem">' + this.shiftHandover[this.getCurrentShift() === 'Early' ? 'Night' : this.getCurrentShift() === 'Late' ? 'Early' : 'Late'].notes + '</div>' +
                '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666">' +
                  'By: ' + this.shiftHandover[this.getCurrentShift() === 'Early' ? 'Night' : this.getCurrentShift() === 'Late' ? 'Early' : 'Late'].completedBy + ' | ' +
                  this.shiftHandover[this.getCurrentShift() === 'Early' ? 'Night' : this.getCurrentShift() === 'Late' ? 'Early' : 'Late'].timestamp +
                '</div>' +
              '</div>' :
              '<div style="padding: 1rem; background: white; border: 2px dashed #999; color: #999; text-align: center">No handover notes from previous shift</div>'
            ) +
          '</div>' +
          '<div style="font-weight: bold; margin-bottom: 0.5rem">Current Shift Handover (' + this.getCurrentShift() + '):</div>' +
          '<button type="button" class="btn voice-btn" data-field="handover-notes" onclick="app.toggleVoiceInput(\'handover-notes\')" style="margin-bottom: 0.5rem">üé§ Voice Dictation</button>' +
          '<textarea class="form-textarea" id="handover-notes" placeholder="Enter observations and important notes for next shift..." style="min-height: 100px"></textarea>' +
          '<button class="btn btn-primary" style="margin-top: 0.5rem" onclick="app.saveShiftHandover()">Save Handover Notes</button>' +
        '</div>' +
        '<div class="card" style="background: #e8f4fd; border: 3px solid #1d4ed8">' +
          '<div class="card-header">' +
            '<div class="card-title" style="color: #1d4ed8">ü§ñ AI Assistant</div>' +
          '</div>' +
          '<div class="form-group">' +
            '<label class="form-label">Natural Language Query</label>' +
            '<input type="text" class="form-input" id="ai-query" placeholder="e.g., Show me all electrical issues this month" />' +
          '</div>' +
          '<button class="btn btn-primary" onclick="app.runAIQuery()">Search</button>' +
          '<div id="ai-results" style="margin-top: 1rem"></div>' +
        '</div>' +
        this.renderGembaWalkMetrics();
      },
      
      renderLevel3() {
        const level3Issues = this.issues.filter(i => i.level === 3 && i.status !== 'RESOLVED');
        
        const plantAreas = [
          { area: 'Production Area A', lines: 2, output: 5950, target: 6200, efficiency: 96, issues: 1 },
          { area: 'Production Area B', lines: 3, output: 13500, target: 13200, efficiency: 102, issues: 0 },
          { area: 'Packaging', lines: 2, output: 18800, target: 19000, efficiency: 99, issues: 0 }
        ];
        
        const totalOutput = plantAreas.reduce((sum, a) => sum + a.output, 0);
        const totalTarget = plantAreas.reduce((sum, a) => sum + a.target, 0);
        const plantEfficiency = Math.round((totalOutput / totalTarget) * 100);
        
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Plant Performance Dashboard</div>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem">' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Plant Output</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + totalOutput.toLocaleString() + '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">Target: ' + totalTarget.toLocaleString() + '</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Efficiency</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + plantEfficiency + '%</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">Target: 98%</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Production Lines</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + plantAreas.reduce((sum, a) => sum + a.lines, 0) + '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">Active</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Open Issues</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + this.issues.filter(i => i.status !== 'RESOLVED').length + '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">Requires Action</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-title" style="margin-bottom: 1rem">Production Area Summary</div>' +
          '<table class="data-table">' +
            '<thead>' +
              '<tr>' +
                '<th>Area</th>' +
                '<th>Lines</th>' +
                '<th>Output Today</th>' +
                '<th>Target</th>' +
                '<th>Efficiency</th>' +
                '<th>Open Issues</th>' +
                '<th>Status</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' +
              plantAreas.map(area => 
                '<tr>' +
                  '<td><strong>' + area.area + '</strong></td>' +
                  '<td>' + area.lines + '</td>' +
                  '<td><strong>' + area.output.toLocaleString() + '</strong></td>' +
                  '<td>' + area.target.toLocaleString() + '</td>' +
                  '<td><strong>' + area.efficiency + '%</strong></td>' +
                  '<td>' + area.issues + '</td>' +
                  '<td>' + (area.efficiency >= 98 ? 'ON TARGET' : area.efficiency >= 95 ? 'MONITORING' : 'BELOW TARGET') + '</td>' +
                '</tr>'
              ).join('') +
            '</tbody>' +
          '</table>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Plant KPIs - Current Shift</div>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem">' +
            '<div style="border: 3px solid #000; padding: 1.5rem">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; font-weight: bold; margin-bottom: 1rem">Safety</div>' +
              '<div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem">0</div>' +
              '<div style="font-size: 0.85rem; color: #666">Incidents | Target: 0</div>' +
              '<div style="margin-top: 1rem; padding: 0.5rem; border: 2px solid #000; text-align: center; font-weight: bold">TARGET MET</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; font-weight: bold; margin-bottom: 1rem">Delivery</div>' +
              '<div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem">96%</div>' +
              '<div style="font-size: 0.85rem; color: #666">On-Time | Target: 95%</div>' +
              '<div style="margin-top: 1rem; padding: 0.5rem; border: 2px solid #000; text-align: center; font-weight: bold">ABOVE TARGET</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; font-weight: bold; margin-bottom: 1rem">Cost</div>' +
              '<div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem">102%</div>' +
              '<div style="font-size: 0.85rem; color: #666">of Budget | Target: 100%</div>' +
              '<div style="margin-top: 1rem; padding: 0.5rem; border: 2px solid #000; text-align: center; font-weight: bold; background: #e9e9e9">OVER BUDGET</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; font-weight: bold; margin-bottom: 1rem">OEE</div>' +
              '<div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem">79%</div>' +
              '<div style="font-size: 0.85rem; color: #666">Overall | Target: 85%</div>' +
              '<div style="margin-top: 1rem; padding: 0.5rem; border: 2px solid #000; text-align: center; font-weight: bold; background: #e9e9e9">BELOW TARGET</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        this.renderGembaWalkMetrics() +
        '<div class="card" style="background: #e8f4fd; border: 3px solid #1d4ed8">' +
          '<div class="card-header">' +
            '<div class="card-title" style="color: #1d4ed8">ü§ñ AI Assistant - Management Tools</div>' +
          '</div>' +
          '<div class="form-group">' +
            '<label class="form-label">Natural Language Query</label>' +
            '<input type="text" class="form-input" id="ai-query" placeholder="e.g., Show me all electrical issues this month" />' +
          '</div>' +
          '<button class="btn btn-primary" onclick="app.runAIQuery()" style="margin-right: 0.5rem">Search</button>' +
          '<button class="btn" onclick="app.generateReport()" style="margin-right: 0.5rem">Generate AI Report</button>' +
          '<button class="btn" onclick="app.showResolutionTimes()">Resolution Times</button>' +
          '<div id="ai-results" style="margin-top: 1rem"></div>' +
        '</div>';
      },
      
      renderGembaWalkMetrics() {
        // Only show for management (Level 2 and Level 3) - Currently showing for all for testing
        // if (this.currentUser !== 'level2' && this.currentUser !== 'level3' && this.currentUser !== 'admin') {
        //   return '';
        // }
        
        // Calculate Gemba Walk metrics
        const gembaIssues = this.issues.filter(i => i.source === 'gemba');
        const productionIssues = this.issues.filter(i => i.source === 'production' || !i.source);
        const allIssues = this.issues;
        
        // Issues identified per walk
        const gembaWalks = this.gembaWalkData.completed || [];
        const issuesPerWalk = gembaWalks.length > 0 ? (gembaIssues.length / gembaWalks.length).toFixed(1) : 0;
        
        // Resolution rate from Gemba observations
        const gembaResolved = gembaIssues.filter(i => i.status === 'RESOLVED').length;
        const gembaResolutionRate = gembaIssues.length > 0 ? Math.round((gembaResolved / gembaIssues.length) * 100) : 0;
        
        // Average time from identification to resolution (in hours)
        const resolvedGembaIssues = gembaIssues.filter(i => i.status === 'RESOLVED' && i.resolvedDate);
        let avgResolutionTime = 0;
        if (resolvedGembaIssues.length > 0) {
          const totalHours = resolvedGembaIssues.reduce((sum, issue) => {
            const created = new Date(issue.dateCreated + ' ' + issue.time);
            const resolved = new Date(issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00'));
            const hoursDiff = (resolved - created) / (1000 * 60 * 60);
            return sum + hoursDiff;
          }, 0);
          avgResolutionTime = (totalHours / resolvedGembaIssues.length).toFixed(1);
        }
        
        // Impact quantification
        const downtimePrevented = gembaIssues
          .filter(i => i.impact && i.impact.downtimePrevented)
          .reduce((sum, i) => sum + (i.impact.downtimePrevented || 0), 0);
        
        const qualityImprovements = gembaIssues
          .filter(i => i.impact && i.impact.defectsReduced)
          .reduce((sum, i) => sum + (i.impact.defectsReduced || 0), 0);
        
        const costSavings = gembaIssues
          .filter(i => i.impact && i.impact.costSavings)
          .reduce((sum, i) => sum + (i.impact.costSavings || 0), 0);
        
        // GAMIFICATION: Calculate streaks and badges
        const streakData = this.calculateGembaStreak();
        const badges = this.getGembaBadges(streakData, gembaWalks.length);
        
        // Recent Gemba issues with impact
        const recentGembaIssues = gembaIssues.slice(-5).reverse();
        
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Gemba Walk Effectiveness Metrics & Gamification</div>' +
            '<button class="btn" data-modal="gemba-metrics-detail" style="font-size: 0.85rem">View Details</button>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem">' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Issues Per Walk</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + issuesPerWalk + '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">' + gembaWalks.length + ' Walks Completed</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Gemba Resolution Rate</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + gembaResolutionRate + '%</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">' + gembaResolved + ' of ' + gembaIssues.length + ' Resolved</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Avg Resolution Time</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + avgResolutionTime + '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">Hours (Gemba Issues)</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Downtime Prevented</div>' +
              '<div style="font-size: 2.5rem; font-weight: bold">' + downtimePrevented + '</div>' +
              '<div style="font-size: 0.85rem; margin-top: 0.25rem">Minutes This Month</div>' +
            '</div>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem">' +
            '<div>' +
              '<div style="font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Issue Source Breakdown</div>' +
              '<table class="data-table">' +
                '<thead><tr><th>Source</th><th>Count</th><th>Resolved</th><th>Rate</th></tr></thead>' +
                '<tbody>' +
                  '<tr>' +
                    '<td><strong>Gemba Walk</strong></td>' +
                    '<td>' + gembaIssues.length + '</td>' +
                    '<td>' + gembaResolved + '</td>' +
                    '<td><strong>' + gembaResolutionRate + '%</strong></td>' +
                  '</tr>' +
                  '<tr>' +
                    '<td><strong>Production</strong></td>' +
                    '<td>' + productionIssues.length + '</td>' +
                    '<td>' + productionIssues.filter(i => i.status === 'RESOLVED').length + '</td>' +
                    '<td><strong>' + (productionIssues.length > 0 ? Math.round((productionIssues.filter(i => i.status === 'RESOLVED').length / productionIssues.length) * 100) : 0) + '%</strong></td>' +
                  '</tr>' +
                '</tbody>' +
              '</table>' +
            '</div>' +
            '<div>' +
              '<div style="font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Gemba Streak</div>' +
              '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center; background: ' + (streakData.currentStreak >= 7 ? '#f0f0f0' : '#fff') + '">' +
                '<div style="font-size: 3rem; font-weight: bold; margin-bottom: 0.5rem">' + streakData.currentStreak + '</div>' +
                '<div style="font-size: 0.85rem; font-weight: bold">' + (streakData.currentStreak === 1 ? 'DAY' : 'DAYS') + ' IN A ROW</div>' +
                (streakData.currentStreak >= 7 ? '<div style="margin-top: 0.75rem; padding: 0.5rem; background: #000; color: #fff; font-weight: bold; font-size: 0.85rem">STREAK ACTIVE</div>' : '') +
                '<div style="margin-top: 1rem; font-size: 0.75rem; color: #666">Best: ' + streakData.longestStreak + ' days</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem">' +
            '<div>' +
              '<div style="font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Impact Quantification</div>' +
              '<div style="border: 2px solid #000; padding: 1rem; margin-bottom: 0.75rem">' +
                '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem">Quality Improvements</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">' + qualityImprovements + ' defects reduced</div>' +
              '</div>' +
              '<div style="border: 2px solid #000; padding: 1rem">' +
                '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem">Cost Savings</div>' +
                '<div style="font-size: 1.5rem; font-weight: bold">$' + costSavings.toLocaleString() + '</div>' +
              '</div>' +
            '</div>' +
            '<div>' +
              '<div style="font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Achievements</div>' +
              '<div style="display: flex; flex-direction: column; gap: 0.75rem">' +
                badges.map(badge => 
                  '<div style="padding: 1rem; border: 2px solid #000; background: ' + (badge.earned ? '#f0f0f0' : '#fff') + '">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center">' +
                      '<div>' +
                        '<div style="font-weight: bold; margin-bottom: 0.25rem">' + badge.name + '</div>' +
                        '<div style="font-size: 0.75rem; color: #666">' + badge.description + '</div>' +
                      '</div>' +
                      '<div style="font-size: 1.5rem; font-weight: bold; padding: 0.5rem 1rem; border: 2px solid #000; background: ' + (badge.earned ? '#000' : '#fff') + '; color: ' + (badge.earned ? '#fff' : '#000') + '">' +
                        (badge.earned ? badge.icon : '-') +
                      '</div>' +
                    '</div>' +
                  '</div>'
                ).join('') +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      },
      
      calculateGembaStreak() {
        const walks = this.gembaWalkData.completed || [];
        if (walks.length === 0) {
          return { currentStreak: 0, longestStreak: 0 };
        }
        
        // Sort walks by date descending
        const sortedWalks = walks.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 1;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Check if most recent walk was today or yesterday
        const mostRecentDate = new Date(sortedWalks[0].date);
        mostRecentDate.setHours(0, 0, 0, 0);
        const daysDiff = Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff <= 1) {
          currentStreak = 1;
          
          // Count consecutive days backwards
          for (let i = 1; i < sortedWalks.length; i++) {
            const prevDate = new Date(sortedWalks[i - 1].date);
            const currDate = new Date(sortedWalks[i].date);
            prevDate.setHours(0, 0, 0, 0);
            currDate.setHours(0, 0, 0, 0);
            
            const diff = Math.floor((prevDate - currDate) / (1000 * 60 * 60 * 24));
            
            if (diff === 1) {
              currentStreak++;
            } else {
              break;
            }
          }
        }
        
        // Calculate longest streak in history
        for (let i = 0; i < sortedWalks.length - 1; i++) {
          const prevDate = new Date(sortedWalks[i].date);
          const currDate = new Date(sortedWalks[i + 1].date);
          prevDate.setHours(0, 0, 0, 0);
          currDate.setHours(0, 0, 0, 0);
          
          const diff = Math.floor((prevDate - currDate) / (1000 * 60 * 60 * 24));
          
          if (diff === 1) {
            tempStreak++;
          } else {
            longestStreak = Math.max(longestStreak, tempStreak);
            tempStreak = 1;
          }
        }
        longestStreak = Math.max(longestStreak, tempStreak, currentStreak);
        
        return { currentStreak, longestStreak };
      },
      
      getGembaBadges(streakData, totalWalks) {
        return [
          {
            name: '7-Day Streak',
            description: 'Complete Gemba walks 7 days in a row',
            icon: '7',
            earned: streakData.currentStreak >= 7 || streakData.longestStreak >= 7
          },
          {
            name: '30-Day Streak',
            description: 'Complete Gemba walks 30 days in a row',
            icon: '30',
            earned: streakData.currentStreak >= 30 || streakData.longestStreak >= 30
          },
          {
            name: 'Centurion',
            description: 'Complete 100 Gemba walks',
            icon: '100',
            earned: totalWalks >= 100
          },
          {
            name: 'Gemba Master',
            description: 'Complete 250 Gemba walks',
            icon: '250',
            earned: totalWalks >= 250
          }
        ];
      },
      
      renderGembaWalk() {
        const steps = ['Initiation', 'Observation', 'Documentation', 'Issues', 'Report'];
        
        return '<div class="info-box" style="margin-bottom: 1rem; background: #fafafa; border: 2px solid #000">' +
          '<div style="font-weight: bold; margin-bottom: 0.25rem">Linear Process - Complete Each Step to Progress</div>' +
          '<div style="font-size: 0.85rem; color: #666">You must complete each step in order. Required fields are enforced before advancing.</div>' +
        '</div>' +
        '<div class="progress-steps">' +
          steps.map((step, idx) => 
            '<div class="progress-step ' + 
              (this.gembaWalkStep === idx + 1 ? 'active' : '') + ' ' +
              (this.gembaWalkStep > idx + 1 ? 'completed' : '') + '">' +
              'Step ' + (idx + 1) + '<br/>' + step +
            '</div>'
          ).join('') +
        '</div>' +
        '<div class="card">' +
          this.renderGembaWalkStep() +
        '</div>';
      },
      
      renderGembaWalkStep() {
        switch(this.gembaWalkStep) {
          case 1:
            return '<div class="card-header">' +
              '<div class="card-title">Step 1: Initiation</div>' +
            '</div>' +
            '<div class="info-box">' +
              '<div class="info-box-title">Purpose</div>' +
              '<div>Define the scope, objectives, and participants for this Gemba Walk.</div>' +
              '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666">All fields are required to proceed to Step 2.</div>' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Target Areas <span style="color: #000">*</span></label>' +
              '<input type="text" class="form-input" id="targetAreas" placeholder="e.g., Production Area A, Assembly Line 2" required />' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Focus / Objectives <span style="color: #000">*</span></label>' +
              '<input type="text" class="form-input" id="focus" placeholder="e.g., Safety standards, OEE issues" required />' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Participants <span style="color: #000">*</span></label>' +
              '<input type="text" class="form-input" id="participants" placeholder="e.g., Plant Manager, Area Manager" required />' +
            '</div>' +
            '<button class="btn btn-primary" data-action="gemba-next">Start Gemba Walk</button>';
          
          case 2:
            return '<div class="card-header">' +
              '<div class="card-title">Step 2: Observation</div>' +
            '</div>' +
            '<div class="info-box">' +
              '<div class="info-box-title">Observation Checklist</div>' +
              '<div>Target: ' + this.gembaWalkData.targetAreas + '</div>' +
              '<div>Focus: ' + this.gembaWalkData.focus + '</div>' +
            '</div>' +
            '<div class="checklist-item">' +
              '<input type="checkbox" class="checkbox" id="check1" />' +
              '<label for="check1">Verify 5S standards in work area</label>' +
            '</div>' +
            '<div class="checklist-item">' +
              '<input type="checkbox" class="checkbox" id="check2" />' +
              '<label for="check2">Check visual management boards are updated</label>' +
            '</div>' +
            '<div class="checklist-item">' +
              '<input type="checkbox" class="checkbox" id="check3" />' +
              '<label for="check3">Observe standard work adherence</label>' +
            '</div>' +
            '<div class="checklist-item">' +
              '<input type="checkbox" class="checkbox" id="check4" />' +
              '<label for="check4">Review safety conditions and PPE usage</label>' +
            '</div>' +
            '<div class="checklist-item">' +
              '<input type="checkbox" class="checkbox" id="check5" />' +
              '<label for="check5">Discuss performance gaps with team</label>' +
            '</div>' +
            '<div style="margin-top: 1.5rem; display: flex; gap: 1rem">' +
              '<button class="btn" data-action="gemba-prev">Previous</button>' +
              '<button class="btn btn-primary" data-action="gemba-next">Continue</button>' +
            '</div>';
          
          case 3:
            return '<div class="card-header">' +
              '<div class="card-title">Step 3: Documentation</div>' +
            '</div>' +
            '<div class="info-box" style="background: #e8f4fd; border: 2px solid #1d4ed8">' +
              '<div style="font-weight: bold; margin-bottom: 0.5rem">üé§ Voice Recording Available</div>' +
              '<div style="font-size: 0.85rem">Use voice input for hands-free observation capture while walking the floor</div>' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Observations and Findings <span style="color: #000">*</span></label>' +
              '<button type="button" class="btn voice-btn" data-field="findings" onclick="app.toggleVoiceInput(\'findings\')" style="margin-bottom: 0.5rem">üé§ Voice Input</button>' +
              '<textarea class="form-textarea" id="findings" placeholder="Document key observations, positive findings, and areas for improvement... (minimum 10 characters)" required></textarea>' +
              '<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem">Required to proceed to Step 4</div>' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Team Feedback (Optional)</label>' +
              '<button type="button" class="btn voice-btn" data-field="teamFeedback" onclick="app.toggleVoiceInput(\'teamFeedback\')" style="margin-bottom: 0.5rem">üé§ Voice Input</button>' +
              '<textarea class="form-textarea" id="teamFeedback" placeholder="Notes from team discussions..."></textarea>' +
            '</div>' +
            '<div style="display: flex; gap: 1rem">' +
              '<button class="btn" data-action="gemba-prev">Previous</button>' +
              '<button class="btn btn-primary" data-action="gemba-next">Continue</button>' +
            '</div>';
          
          case 4:
            return '<div class="card-header">' +
              '<div class="card-title">Step 4: Issue Identification</div>' +
            '</div>' +
            '<div class="info-box">' +
              '<div class="info-box-title">Identified Issues</div>' +
              '<div>Issues identified during this Gemba Walk will be added to the Issue Management system.</div>' +
            '</div>' +
            (this.gembaWalkData.issues.length > 0 ?
              '<div class="issue-list">' +
                this.gembaWalkData.issues.map((issue, idx) => 
                  '<div class="issue-item">' +
                    '<div class="issue-title">' + issue.title + '</div>' +
                    '<div class="issue-meta">' +
                      '<span>Priority: ' + issue.priority + '</span>' +
                      '<span>Area: ' + issue.area + '</span>' +
                    '</div>' +
                  '</div>'
                ).join('') +
              '</div>' : '') +
            '<button class="btn" data-modal="add-gemba-issue" style="margin: 1rem 0">Add Issue</button>' +
            '<div style="display: flex; gap: 1rem; margin-top: 1rem">' +
              '<button class="btn" data-action="gemba-prev">Previous</button>' +
              '<button class="btn btn-primary" data-action="gemba-next">Continue to Report</button>' +
            '</div>';
          
          case 5:
            return '<div class="card-header">' +
              '<div class="card-title">Step 5: Gemba Walk Report</div>' +
            '</div>' +
            '<div class="info-box" style="background: #f0f0f0; border: 3px solid #000; padding: 1.5rem">' +
              '<div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">GEMBA WALK SUMMARY</div>' +
              '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem">' +
                '<div><strong>Date:</strong> ' + new Date().toISOString().split('T')[0] + '</div>' +
                '<div><strong>Leader:</strong> ' + (this.currentUser === 'level2' ? 'Area Leader' : 'Plant Manager') + '</div>' +
                '<div><strong>Target Areas:</strong> ' + this.gembaWalkData.targetAreas + '</div>' +
                '<div><strong>Issues Identified:</strong> ' + this.gembaWalkData.issues.length + '</div>' +
              '</div>' +
              '<div style="margin-bottom: 1rem">' +
                '<strong>Focus/Objectives:</strong><br/>' +
                '<div style="padding: 0.5rem; background: white; border: 1px solid #000; margin-top: 0.25rem">' + this.gembaWalkData.focus + '</div>' +
              '</div>' +
              '<div style="margin-bottom: 1rem">' +
                '<strong>Participants:</strong><br/>' +
                '<div style="padding: 0.5rem; background: white; border: 1px solid #000; margin-top: 0.25rem">' + this.gembaWalkData.participants + '</div>' +
              '</div>' +
            '</div>' +
            (this.gembaWalkData.findings ?
              '<div style="margin-top: 1.5rem">' +
                '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Key Findings & Observations</div>' +
                '<div style="padding: 1rem; border: 2px solid #000; background: white; white-space: pre-wrap">' + this.gembaWalkData.findings + '</div>' +
              '</div>' : '') +
            (this.gembaWalkData.teamFeedback ?
              '<div style="margin-top: 1.5rem">' +
                '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Team Feedback</div>' +
                '<div style="padding: 1rem; border: 2px solid #000; background: white; white-space: pre-wrap">' + this.gembaWalkData.teamFeedback + '</div>' +
              '</div>' : '') +
            (this.gembaWalkData.issues.length > 0 ?
              '<div style="margin-top: 1.5rem">' +
                '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Issues Identified (' + this.gembaWalkData.issues.length + ')</div>' +
                '<div style="border: 2px solid #000">' +
                  this.gembaWalkData.issues.map((issue, idx) => 
                    '<div style="padding: 1rem; border-bottom: ' + (idx < this.gembaWalkData.issues.length - 1 ? '1px solid #ccc' : 'none') + '; background: white">' +
                      '<div style="font-weight: bold; margin-bottom: 0.25rem">' + issue.title + '</div>' +
                      '<div style="font-size: 0.85rem; color: #666">Priority: ' + issue.priority + ' | Category: ' + issue.category + ' | Area: ' + issue.area + '</div>' +
                    '</div>'
                  ).join('') +
                '</div>' +
              '</div>' :
              '<div style="margin-top: 1.5rem; padding: 1rem; border: 2px dashed #666; text-align: center; color: #666">' +
                'No issues identified during this walk' +
              '</div>') +
            '<div style="margin-top: 1.5rem; padding: 1rem; background: #fff; border: 2px solid #000">' +
              '<div style="font-weight: bold; margin-bottom: 0.5rem">Next Steps</div>' +
              '<div style="font-size: 0.9rem">Clicking "Complete Gemba Walk" will:</div>' +
              '<ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem">' +
                '<li>Save this walk to completed history</li>' +
                '<li>Add identified issues to Issue Management system</li>' +
                '<li>Update Gemba Walk metrics and streak</li>' +
                '<li>Reset form for next walk</li>' +
              '</ul>' +
            '</div>' +
            '<div style="display: flex; gap: 1rem; margin-top: 1.5rem">' +
              '<button class="btn" data-action="gemba-prev">Previous</button>' +
              '<button class="btn btn-primary" data-action="gemba-complete" style="flex: 1">Complete Gemba Walk</button>' +
            '</div>';
          
          default:
            return '';
        }
      },
      
      renderEscalations() {
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Escalation Flow Overview</div>' +
          '</div>' +
          '<div class="progress-steps">' +
            '<div class="progress-step">LEVEL 1<br/>Team</div>' +
            '<div style="font-size: 2rem; padding: 1rem">‚Üí</div>' +
            '<div class="progress-step">LEVEL 2<br/>Area</div>' +
            '<div style="font-size: 2rem; padding: 1rem">‚Üí</div>' +
            '<div class="progress-step">LEVEL 3<br/>Plant</div>' +
          '</div>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-title" style="margin-bottom: 1rem">All Issues by Level</div>' +
          '<table class="data-table">' +
            '<thead>' +
              '<tr>' +
                '<th>ID</th>' +
                '<th>Title</th>' +
                '<th>Level</th>' +
                '<th>Priority</th>' +
                '<th>Status</th>' +
                '<th>Area</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' +
              this.issues.filter(i => i.status !== 'RESOLVED').map(issue => 
                '<tr>' +
                  '<td><strong>' + issue.id + '</strong></td>' +
                  '<td>' + issue.title + '</td>' +
                  '<td>Level ' + issue.level + '</td>' +
                  '<td><strong>' + issue.priority + '</strong></td>' +
                  '<td>' + issue.status + '</td>' +
                  '<td>' + issue.area + '</td>' +
                '</tr>'
              ).join('') +
            '</tbody>' +
          '</table>' +
        '</div>';
      },
      
      renderResolution() {
        const openIssues = this.issues.filter(i => i.status !== 'RESOLVED');
        const resolvedIssues = this.issues.filter(i => i.status === 'RESOLVED');
        
        return '<div class="card">' +
          '<div class="card-header">' +
            '<div class="card-title">Open Issues Requiring Resolution</div>' +
          '</div>' +
          (openIssues.length === 0 ?
            '<div class="empty-state"><div>No open issues</div></div>' :
            '<div class="issue-list">' +
              openIssues.map(issue => 
                '<div class="issue-item">' +
                  '<div class="issue-header">' +
                    '<div class="issue-title">Issue ' + issue.id + ': ' + issue.title + '</div>' +
                    '<div class="issue-badge">' + issue.priority + '</div>' +
                  '</div>' +
                  '<div class="issue-meta">' +
                    '<span>Level ' + issue.level + '</span>' +
                    '<span>Status: ' + issue.status + '</span>' +
                    '<span>Area: ' + issue.area + '</span>' +
                  '</div>' +
                  '<div class="issue-description">' + issue.description + '</div>' +
                  '<div style="margin-top: 1rem">' +
                    '<button class="btn btn-primary" data-modal="resolve" data-issue-id="' + issue.id + '">Mark as Resolved</button>' +
                  '</div>' +
                '</div>'
              ).join('') +
            '</div>'
          ) +
        '</div>' +
        (resolvedIssues.length > 0 ?
          '<div class="card">' +
            '<div class="card-title" style="margin-bottom: 1rem">Recently Resolved Issues</div>' +
            '<div class="issue-list">' +
              resolvedIssues.map(issue => 
                '<div class="issue-item" style="opacity: 0.7">' +
                  '<div class="issue-header">' +
                    '<div class="issue-title">Issue ' + issue.id + ': ' + issue.title + '</div>' +
                    '<div class="issue-badge">RESOLVED</div>' +
                  '</div>' +
                  '<div class="issue-meta">' +
                    '<span>Resolved by: ' + (issue.resolvedBy || 'N/A') + '</span>' +
                    '<span>Date: ' + (issue.dateResolved || 'N/A') + '</span>' +
                  '</div>' +
                '</div>'
              ).join('') +
            '</div>' +
          '</div>' : ''
        );
      },
      
      renderSafetyCross() {
        const today = new Date();
        const currentDate = today.toISOString().split('T')[0];
        const currentShift = this.getCurrentShift();
        
        if (this.currentUser === 'level1') {
          // Level 1: Daily safety entry for team member
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];
          const daysInMonth = new Date(this.safetyCross.currentYear, this.safetyCross.currentMonth + 1, 0).getDate();
          const todayEntries = this.safetyCross.entries.filter(e => e.date === currentDate);
          
          return '<div class="card">' +
            '<div class="card-header">' +
              '<div class="card-title">My Safety Status - ' + monthNames[this.safetyCross.currentMonth] + ' ' + this.safetyCross.currentYear + '</div>' +
            '</div>' +
            '<div class="info-box">' +
              '<div><strong>Team:</strong> Team A - Assembly Line 1</div>' +
              '<div><strong>Current Shift:</strong> ' + currentShift + ' (' + this.getShiftTime(currentShift) + ')</div>' +
              '<div><strong>Days Without Accident (Plant):</strong> ' + this.safetyCross.daysWithoutAccident + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="card">' +
            '<div class="card-title" style="margin-bottom: 1rem">Today - ' + today.toLocaleDateString() + '</div>' +
            '<div style="margin-bottom: 1rem">' +
              '<div style="margin-bottom: 0.5rem; font-weight: bold">Mark Safety Status for Current Shift (' + currentShift + '):</div>' +
              '<div style="display: flex; gap: 1rem; flex-wrap: wrap">' +
                '<button class="btn" style="background: #90EE90; border-color: #000" data-action="mark-safety" data-status="safe">Safe - No Issues</button>' +
                '<button class="btn" style="background: #FFD700; border-color: #000" data-action="mark-safety" data-status="near-miss">Near Miss</button>' +
                '<button class="btn" style="background: #FFB6C1; border-color: #000" data-action="mark-safety" data-status="incident">Safety Incident</button>' +
              '</div>' +
            '</div>' +
            (todayEntries.length > 0 ? 
              '<div style="margin-top: 1rem; padding: 1rem; border: 2px solid #000; background: #fafafa">' +
                '<div style="font-weight: bold; margin-bottom: 0.5rem">Entered Today:</div>' +
                todayEntries.map(entry => 
                  '<div style="margin-bottom: 0.5rem">' +
                    '<strong>' + entry.shift + ' Shift (' + this.getShiftTime(entry.shift) + '):</strong> ' +
                    '<span style="padding: 0.25rem 0.5rem; background: ' + 
                      (entry.status === 'safe' ? '#90EE90' : entry.status === 'near-miss' ? '#FFD700' : '#FFB6C1') + 
                      '; border: 2px solid #000">' + 
                      (entry.status === 'safe' ? 'SAFE' : entry.status === 'near-miss' ? 'NEAR MISS' : 'INCIDENT') +
                    '</span>' +
                    (entry.notes ? ' - ' + entry.notes : '') +
                  '</div>'
                ).join('') +
              '</div>' : '') +
          '</div>' +
          '<div class="card">' +
            '<div class="card-title" style="margin-bottom: 1rem">My Safety Calendar - ' + monthNames[this.safetyCross.currentMonth] + '</div>' +
            '<table class="data-table">' +
              '<thead><tr>' +
                '<th>Day</th><th>Early<br/>06-14</th><th>Late<br/>14-22</th><th>Night<br/>22-06</th>' +
              '</tr></thead>' +
              '<tbody>' +
                Array.from({length: Math.min(daysInMonth, 7)}, (_, i) => {
                  const day = i + 1;
                  const dateStr = this.safetyCross.currentYear + '-' + 
                    String(this.safetyCross.currentMonth + 1).padStart(2, '0') + '-' + 
                    String(day).padStart(2, '0');
                  const dayEntries = this.safetyCross.entries.filter(e => e.date === dateStr);
                  const earlyShift = dayEntries.find(e => e.shift === 'Early');
                  const lateShift = dayEntries.find(e => e.shift === 'Late');
                  const nightShift = dayEntries.find(e => e.shift === 'Night');
                  
                  return '<tr>' +
                    '<td><strong>' + day + '</strong></td>' +
                    '<td style="background: ' + (earlyShift ? 
                      (earlyShift.status === 'safe' ? '#90EE90' : 
                       earlyShift.status === 'near-miss' ? '#FFD700' : '#FFB6C1') : '#fff') + '">' +
                      (earlyShift ? (earlyShift.status === 'safe' ? '‚úì' : earlyShift.status === 'near-miss' ? '!' : '‚úó') : '-') +
                    '</td>' +
                    '<td style="background: ' + (lateShift ? 
                      (lateShift.status === 'safe' ? '#90EE90' : 
                       lateShift.status === 'near-miss' ? '#FFD700' : '#FFB6C1') : '#fff') + '">' +
                      (lateShift ? (lateShift.status === 'safe' ? '‚úì' : lateShift.status === 'near-miss' ? '!' : '‚úó') : '-') +
                    '</td>' +
                    '<td style="background: ' + (nightShift ? 
                      (nightShift.status === 'safe' ? '#90EE90' : 
                       nightShift.status === 'near-miss' ? '#FFD700' : '#FFB6C1') : '#fff') + '">' +
                      (nightShift ? (nightShift.status === 'safe' ? '‚úì' : nightShift.status === 'near-miss' ? '!' : '‚úó') : '-') +
                    '</td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
            '</table>' +
            '<div style="margin-top: 1rem; display: flex; gap: 1rem; font-size: 0.85rem">' +
              '<div><span style="display: inline-block; width: 20px; height: 20px; background: #90EE90; border: 2px solid #000"></span> Safe</div>' +
              '<div><span style="display: inline-block; width: 20px; height: 20px; background: #FFD700; border: 2px solid #000"></span> Near Miss</div>' +
              '<div><span style="display: inline-block; width: 20px; height: 20px; background: #FFB6C1; border: 2px solid #000"></span> Incident</div>' +
            '</div>' +
          '</div>';
        } else if (this.currentUser === 'level2') {
          // Level 2: Area view of all teams
          const teams = ['Team A', 'Team B', 'Team C'];
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];
          
          return '<div class="card">' +
            '<div class="card-header">' +
              '<div class="card-title">Area Safety Overview - ' + monthNames[this.safetyCross.currentMonth] + ' ' + this.safetyCross.currentYear + '</div>' +
            '</div>' +
            '<div class="info-box">' +
              '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center">' +
                '<div>' +
                  '<div style="font-size: 0.85rem; color: #666">Days Without Accident</div>' +
                  '<div style="font-size: 2rem; font-weight: bold">' + this.safetyCross.daysWithoutAccident + '</div>' +
                '</div>' +
                '<div>' +
                  '<div style="font-size: 0.85rem; color: #666">Near Misses (Month)</div>' +
                  '<div style="font-size: 2rem; font-weight: bold">1</div>' +
                '</div>' +
                '<div>' +
                  '<div style="font-size: 0.85rem; color: #666">Incidents (Month)</div>' +
                  '<div style="font-size: 2rem; font-weight: bold">0</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          teams.map(team => 
            '<div class="card">' +
              '<div class="card-title" style="margin-bottom: 1rem">' + team + ' - Assembly Line 1</div>' +
              '<table class="data-table">' +
                '<thead><tr>' +
                  '<th>Date</th><th>Early<br/>06-14</th><th>Late<br/>14-22</th><th>Night<br/>22-06</th><th>Notes</th>' +
                '</tr></thead>' +
                '<tbody>' +
                  Array.from({length: 7}, (_, i) => {
                    const day = i + 1;
                    const dateStr = this.safetyCross.currentYear + '-' + 
                      String(this.safetyCross.currentMonth + 1).padStart(2, '0') + '-' + 
                      String(day).padStart(2, '0');
                    const dayEntries = this.safetyCross.entries.filter(e => e.date === dateStr && e.team === team);
                    const earlyShift = dayEntries.find(e => e.shift === 'Early');
                    const lateShift = dayEntries.find(e => e.shift === 'Late');
                    const nightShift = dayEntries.find(e => e.shift === 'Night');
                    const notes = [earlyShift, lateShift, nightShift].find(s => s && s.notes);
                    
                    return '<tr>' +
                      '<td><strong>Feb ' + day + '</strong></td>' +
                      '<td style="background: ' + (earlyShift ? 
                        (earlyShift.status === 'safe' ? '#90EE90' : 
                         earlyShift.status === 'near-miss' ? '#FFD700' : '#FFB6C1') : '#fff') + '">' +
                        (earlyShift ? (earlyShift.status === 'safe' ? 'SAFE' : earlyShift.status === 'near-miss' ? 'NEAR MISS' : 'INCIDENT') : '-') +
                      '</td>' +
                      '<td style="background: ' + (lateShift ? 
                        (lateShift.status === 'safe' ? '#90EE90' : 
                         lateShift.status === 'near-miss' ? '#FFD700' : '#FFB6C1') : '#fff') + '">' +
                        (lateShift ? (lateShift.status === 'safe' ? 'SAFE' : lateShift.status === 'near-miss' ? 'NEAR MISS' : 'INCIDENT') : '-') +
                      '</td>' +
                      '<td style="background: ' + (nightShift ? 
                        (nightShift.status === 'safe' ? '#90EE90' : 
                         nightShift.status === 'near-miss' ? '#FFD700' : '#FFB6C1') : '#fff') + '">' +
                        (nightShift ? (nightShift.status === 'safe' ? 'SAFE' : nightShift.status === 'near-miss' ? 'NEAR MISS' : 'INCIDENT') : '-') +
                      '</td>' +
                      '<td>' + (notes ? notes.notes : '-') + '</td>' +
                    '</tr>';
                  }).join('') +
                '</tbody>' +
              '</table>' +
            '</div>'
          ).join('');
        } else {
          // Level 3: Plant-wide safety view
          const areas = ['Production Area A', 'Production Area B', 'Packaging'];
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];
          
          return '<div class="card">' +
            '<div class="card-header">' +
              '<div class="card-title">Plant Safety Dashboard</div>' +
            '</div>' +
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem">' +
              '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
                '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Days Without Accident</div>' +
                '<div style="font-size: 3rem; font-weight: bold; color: #2d862d">' + this.safetyCross.daysWithoutAccident + '</div>' +
                '<div style="font-size: 0.85rem; margin-top: 0.25rem">Target: 365</div>' +
              '</div>' +
              '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
                '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Near Misses (YTD)</div>' +
                '<div style="font-size: 3rem; font-weight: bold">3</div>' +
                '<div style="font-size: 0.85rem; margin-top: 0.25rem">Last Month: 2</div>' +
              '</div>' +
              '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
                '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Incidents (YTD)</div>' +
                '<div style="font-size: 3rem; font-weight: bold">0</div>' +
                '<div style="font-size: 0.85rem; margin-top: 0.25rem">Target: 0</div>' +
              '</div>' +
              '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
                '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; color: #666">Safety Compliance</div>' +
                '<div style="font-size: 3rem; font-weight: bold">100%</div>' +
                '<div style="font-size: 0.85rem; margin-top: 0.25rem">All Teams Reporting</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="card">' +
            '<div class="card-title" style="margin-bottom: 1rem">Safety Status by Area - ' + monthNames[this.safetyCross.currentMonth] + ' ' + this.safetyCross.currentYear + '</div>' +
            '<table class="data-table">' +
              '<thead><tr>' +
                '<th>Area</th><th>Teams</th><th>Safe Days</th><th>Near Misses</th><th>Incidents</th><th>Compliance</th><th>Status</th>' +
              '</tr></thead>' +
              '<tbody>' +
                '<tr>' +
                  '<td><strong>Production Area A</strong></td>' +
                  '<td>3</td>' +
                  '<td>20</td>' +
                  '<td>1</td>' +
                  '<td>0</td>' +
                  '<td>100%</td>' +
                  '<td><strong>GOOD</strong></td>' +
                '</tr>' +
                '<tr>' +
                  '<td><strong>Production Area B</strong></td>' +
                  '<td>3</td>' +
                  '<td>21</td>' +
                  '<td>0</td>' +
                  '<td>0</td>' +
                  '<td>100%</td>' +
                  '<td><strong>EXCELLENT</strong></td>' +
                '</tr>' +
                '<tr>' +
                  '<td><strong>Packaging</strong></td>' +
                  '<td>2</td>' +
                  '<td>21</td>' +
                  '<td>0</td>' +
                  '<td>0</td>' +
                  '<td>100%</td>' +
                  '<td><strong>EXCELLENT</strong></td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<div class="card">' +
            '<div class="card-title" style="margin-bottom: 1rem">Safety Trend - Last 6 Months</div>' +
            '<div style="display: flex; gap: 1rem; align-items: flex-end; height: 200px; padding: 1rem">' +
              '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
                '<div style="width: 100%; height: 180px; border: 3px solid #000; background: #90EE90; display: flex; align-items: center; justify-content: center; font-weight: bold">0</div>' +
                '<div style="margin-top: 0.5rem; font-weight: bold">Sep</div>' +
              '</div>' +
              '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
                '<div style="width: 100%; height: 180px; border: 3px solid #000; background: #90EE90; display: flex; align-items: center; justify-content: center; font-weight: bold">0</div>' +
                '<div style="margin-top: 0.5rem; font-weight: bold">Oct</div>' +
              '</div>' +
              '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
                '<div style="width: 100%; height: 180px; border: 3px solid #000; background: #90EE90; display: flex; align-items: center; justify-content: center; font-weight: bold">0</div>' +
                '<div style="margin-top: 0.5rem; font-weight: bold">Nov</div>' +
              '</div>' +
              '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
                '<div style="width: 100%; height: 180px; border: 3px solid #000; background: #90EE90; display: flex; align-items: center; justify-content: center; font-weight: bold">0</div>' +
                '<div style="margin-top: 0.5rem; font-weight: bold">Dec</div>' +
              '</div>' +
              '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
                '<div style="width: 100%; height: 180px; border: 3px solid #000; background: #90EE90; display: flex; align-items: center; justify-content: center; font-weight: bold">0</div>' +
                '<div style="margin-top: 0.5rem; font-weight: bold">Jan</div>' +
              '</div>' +
              '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
                '<div style="width: 100%; height: 180px; border: 3px solid #000; background: #90EE90; display: flex; align-items: center; justify-content: center; font-weight: bold">0</div>' +
                '<div style="margin-top: 0.5rem; font-weight: bold">Feb</div>' +
              '</div>' +
            '</div>' +
            '<div style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #666">Incidents per Month</div>' +
          '</div>';
        }
      },
      
      renderDashboard() {
        const openIssues = this.issues.filter(i => i.status !== 'RESOLVED').length;
        const resolvedIssues = this.issues.filter(i => i.status === 'RESOLVED').length;
        const level1Count = this.issues.filter(i => i.level === 1 && i.status !== 'RESOLVED').length;
        const level2Count = this.issues.filter(i => i.level === 2 && i.status !== 'RESOLVED').length;
        const level3Count = this.issues.filter(i => i.level === 3 && i.status !== 'RESOLVED').length;
        
        return '<div class="card">' +
          '<div class="card-title" style="margin-bottom: 1.5rem">Issue Management Overview</div>' +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem">' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem">Total Issues</div>' +
              '<div style="font-size: 3rem; font-weight: bold">' + this.issues.length + '</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem">Open</div>' +
              '<div style="font-size: 3rem; font-weight: bold">' + openIssues + '</div>' +
            '</div>' +
            '<div style="border: 3px solid #000; padding: 1.5rem; text-align: center">' +
              '<div style="font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem">Resolved</div>' +
              '<div style="font-size: 3rem; font-weight: bold">' + resolvedIssues + '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card">' +
          '<div class="card-title" style="margin-bottom: 1rem">Issues by Level</div>' +
          '<div style="display: flex; gap: 1rem; align-items: flex-end; height: 200px; padding: 1rem">' +
            '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
              '<div style="width: 100%; height: ' + (level1Count * 30) + 'px; border: 3px solid #000; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold">' + level1Count + '</div>' +
              '<div style="margin-top: 0.5rem; font-weight: bold">Level 1</div>' +
            '</div>' +
            '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
              '<div style="width: 100%; height: ' + (level2Count * 30) + 'px; border: 3px solid #000; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold">' + level2Count + '</div>' +
              '<div style="margin-top: 0.5rem; font-weight: bold">Level 2</div>' +
            '</div>' +
            '<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center">' +
              '<div style="width: 100%; height: ' + (level3Count * 30) + 'px; border: 3px solid #000; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold">' + level3Count + '</div>' +
              '<div style="margin-top: 0.5rem; font-weight: bold">Level 3</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      },
      
      renderModal() {
        if (this.showModal === 'add-issue') {
          const level = this.modalData || 1;
          const now = new Date();
          const currentDateTime = now.getFullYear() + '-' + 
            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
            String(now.getDate()).padStart(2, '0') + 'T' +
            String(now.getHours()).padStart(2, '0') + ':' + 
            String(now.getMinutes()).padStart(2, '0');
          
          // LEVEL 1 - Guided Step-by-Step Issue Entry
          if (level === 1) {
            if (!this.issueWizardStep) this.issueWizardStep = 1;
            
            const wizardData = this.issueWizardData || {
              problemType: '',
              location: '',
              whenHappened: '',
              whatHappened: '',
              impact: '',
              triedSolutions: '',
              helpNeeded: ''
            };
            
            let stepContent = '';
            let canProceed = false;
            
            switch(this.issueWizardStep) {
              case 1:
                stepContent = '<div class="card-header">' +
                  '<div class="card-title">Step 1 of 6: What type of problem is this?</div>' +
                '</div>' +
                '<div class="info-box">' +
                  '<div style="font-size: 0.9rem">Select the category that best describes your problem</div>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0">' +
                  this.adminConfig.categories.map(cat => 
                    '<button type="button" class="btn" style="padding: 1.5rem; text-align: center; border: 3px solid ' + (wizardData.problemType === cat ? '#000' : '#ccc') + '; background: ' + (wizardData.problemType === cat ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'problemType\', \'' + cat + '\')">' +
                      '<div style="font-weight: bold; margin-bottom: 0.25rem">' + cat + '</div>' +
                    '</button>'
                  ).join('') +
                '</div>';
                canProceed = !!wizardData.problemType;
                break;
                
              case 2:
                stepContent = '<div class="card-header">' +
                  '<div class="card-title">Step 2 of 6: Where is the problem?</div>' +
                '</div>' +
                '<div class="info-box">' +
                  '<div style="font-size: 0.9rem">Tell us the exact location so we can find it quickly</div>' +
                '</div>' +
                '<div class="form-group" style="margin: 1.5rem 0">' +
                  '<label class="form-label">Location / Workstation</label>' +
                  '<select class="form-select" id="wizard-location" onchange="app.setWizardData(\'location\', this.value)" style="font-size: 1rem; padding: 1rem">' +
                    '<option value="">Select location...</option>' +
                    this.adminConfig.areas.map(area => 
                      '<option value="' + area + '" ' + (wizardData.location === area ? 'selected' : '') + '>' + area + '</option>'
                    ).join('') +
                  '</select>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Specific Machine or Area (Optional)</label>' +
                  '<input type="text" class="form-input" id="wizard-specific-location" value="' + (wizardData.specificLocation || '') + '" onchange="app.setWizardData(\'specificLocation\', this.value)" placeholder="e.g., Machine M-401, Station 3" style="font-size: 1rem; padding: 1rem" />' +
                '</div>';
                canProceed = !!wizardData.location;
                break;
                
              case 3:
                stepContent = '<div class="card-header">' +
                  '<div class="card-title">Step 3 of 6: When did this happen?</div>' +
                '</div>' +
                '<div class="info-box">' +
                  '<div style="font-size: 0.9rem">Knowing when helps us understand if it\'s a recurring issue</div>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0">' +
                  '<button type="button" class="btn" style="padding: 1.5rem; border: 3px solid ' + (wizardData.whenHappened === 'now' ? '#000' : '#ccc') + '; background: ' + (wizardData.whenHappened === 'now' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'whenHappened\', \'now\')">' +
                    '<div style="font-weight: bold">Happening Now</div>' +
                    '<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem">Problem is active</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; border: 3px solid ' + (wizardData.whenHappened === 'earlier-today' ? '#000' : '#ccc') + '; background: ' + (wizardData.whenHappened === 'earlier-today' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'whenHappened\', \'earlier-today\')">' +
                    '<div style="font-weight: bold">Earlier Today</div>' +
                    '<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem">Within last few hours</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; border: 3px solid ' + (wizardData.whenHappened === 'recurring' ? '#000' : '#ccc') + '; background: ' + (wizardData.whenHappened === 'recurring' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'whenHappened\', \'recurring\')">' +
                    '<div style="font-weight: bold">Recurring Issue</div>' +
                    '<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem">Happens repeatedly</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; border: 3px solid ' + (wizardData.whenHappened === 'yesterday' ? '#000' : '#ccc') + '; background: ' + (wizardData.whenHappened === 'yesterday' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'whenHappened\', \'yesterday\')">' +
                    '<div style="font-weight: bold">Yesterday</div>' +
                    '<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem">Previous shift</div>' +
                  '</button>' +
                '</div>';
                canProceed = !!wizardData.whenHappened;
                break;
                
              case 4:
                stepContent = '<div class="card-header">' +
                  '<div class="card-title">Step 4 of 6: What exactly happened?</div>' +
                '</div>' +
                '<div class="info-box">' +
                  '<div style="font-size: 0.9rem">Describe the problem in your own words - be as specific as possible</div>' +
                '</div>' +
                '<div class="form-group" style="margin: 1.5rem 0">' +
                  '<label class="form-label">Problem Description</label>' +
                  '<textarea class="form-textarea" id="wizard-what-happened" onchange="app.setWizardData(\'whatHappened\', this.value)" placeholder="Example: Machine stopped making noise and won\'t start. Red light is blinking. It was working fine 10 minutes ago." style="min-height: 150px; font-size: 1rem; padding: 1rem">' + (wizardData.whatHappened || '') + '</textarea>' +
                  '<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem">Minimum 20 characters required</div>' +
                '</div>';
                canProceed = wizardData.whatHappened && wizardData.whatHappened.length >= 20;
                break;
                
              case 5:
                stepContent = '<div class="card-header">' +
                  '<div class="card-title">Step 5 of 6: How is this affecting work?</div>' +
                '</div>' +
                '<div class="info-box">' +
                  '<div style="font-size: 0.9rem">Understanding the impact helps us prioritize</div>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin: 1.5rem 0">' +
                  '<button type="button" class="btn" style="padding: 1.5rem; text-align: left; border: 3px solid ' + (wizardData.impact === 'stopped' ? '#000' : '#ccc') + '; background: ' + (wizardData.impact === 'stopped' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'impact\', \'stopped\')">' +
                    '<div style="font-weight: bold; margin-bottom: 0.25rem">Work is Stopped</div>' +
                    '<div style="font-size: 0.85rem; color: #666">Cannot continue production - HIGH priority</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; text-align: left; border: 3px solid ' + (wizardData.impact === 'slowed' ? '#000' : '#ccc') + '; background: ' + (wizardData.impact === 'slowed' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'impact\', \'slowed\')">' +
                    '<div style="font-weight: bold; margin-bottom: 0.25rem">Work is Slowed Down</div>' +
                    '<div style="font-size: 0.85rem; color: #666">Can work but much slower - MEDIUM priority</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; text-align: left; border: 3px solid ' + (wizardData.impact === 'quality' ? '#000' : '#ccc') + '; background: ' + (wizardData.impact === 'quality' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'impact\', \'quality\')">' +
                    '<div style="font-weight: bold; margin-bottom: 0.25rem">Affecting Quality</div>' +
                    '<div style="font-size: 0.85rem; color: #666">Parts might be defective - MEDIUM priority</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; text-align: left; border: 3px solid ' + (wizardData.impact === 'safety' ? '#000' : '#ccc') + '; background: ' + (wizardData.impact === 'safety' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'impact\', \'safety\')">' +
                    '<div style="font-weight: bold; margin-bottom: 0.25rem">Safety Concern</div>' +
                    '<div style="font-size: 0.85rem; color: #666">Potential injury risk - HIGH priority</div>' +
                  '</button>' +
                  '<button type="button" class="btn" style="padding: 1.5rem; text-align: left; border: 3px solid ' + (wizardData.impact === 'minor' ? '#000' : '#ccc') + '; background: ' + (wizardData.impact === 'minor' ? '#f0f0f0' : '#fff') + '" onclick="app.setWizardData(\'impact\', \'minor\')">' +
                    '<div style="font-weight: bold; margin-bottom: 0.25rem">Minor Issue</div>' +
                    '<div style="font-size: 0.85rem; color: #666">Can still work normally - LOW priority</div>' +
                  '</button>' +
                '</div>';
                canProceed = !!wizardData.impact;
                break;
                
              case 6:
                stepContent = '<div class="card-header">' +
                  '<div class="card-title">Step 6 of 6: What have you tried?</div>' +
                '</div>' +
                '<div class="info-box">' +
                  '<div style="font-size: 0.9rem">This helps us avoid repeating steps and find a solution faster</div>' +
                '</div>' +
                '<div class="form-group" style="margin: 1.5rem 0">' +
                  '<label class="form-label">Solutions Already Tried (Optional)</label>' +
                  '<textarea class="form-textarea" id="wizard-tried-solutions" onchange="app.setWizardData(\'triedSolutions\', this.value)" placeholder="Example: Pressed reset button, checked power cable, restarted machine" style="min-height: 100px; font-size: 1rem; padding: 1rem">' + (wizardData.triedSolutions || '') + '</textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">What help do you need?</label>' +
                  '<select class="form-select" id="wizard-help-needed" onchange="app.setWizardData(\'helpNeeded\', this.value)" style="font-size: 1rem; padding: 1rem">' +
                    '<option value="">Select type of help...</option>' +
                    '<option value="maintenance" ' + (wizardData.helpNeeded === 'maintenance' ? 'selected' : '') + '>Maintenance/Repair</option>' +
                    '<option value="supervisor" ' + (wizardData.helpNeeded === 'supervisor' ? 'selected' : '') + '>Talk to Supervisor</option>' +
                    '<option value="materials" ' + (wizardData.helpNeeded === 'materials' ? 'selected' : '') + '>Need Materials/Parts</option>' +
                    '<option value="quality" ' + (wizardData.helpNeeded === 'quality' ? 'selected' : '') + '>Quality Check</option>' +
                    '<option value="other" ' + (wizardData.helpNeeded === 'other' ? 'selected' : '') + '>Other Help</option>' +
                  '</select>' +
                '</div>';
                canProceed = !!wizardData.helpNeeded;
                break;
            }
            
            return '<div class="modal-overlay" data-close-modal>' +
              '<div class="modal" style="max-width: 700px">' +
                '<div class="modal-header">' +
                  '<div class="modal-title">Report a Problem - Guided Process</div>' +
                  '<button class="close-btn" data-close-modal>√ó</button>' +
                '</div>' +
                '<div class="progress-steps">' +
                  [1,2,3,4,5,6].map(step => 
                    '<div class="progress-step ' + 
                      (this.issueWizardStep === step ? 'active' : '') + ' ' +
                      (this.issueWizardStep > step ? 'completed' : '') + '" style="font-size: 0.75rem">' +
                      step +
                    '</div>'
                  ).join('') +
                '</div>' +
                stepContent +
                '<div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #ccc">' +
                  (this.issueWizardStep > 1 ? 
                    '<button type="button" class="btn" onclick="app.previousWizardStep()" style="flex: 1">Previous</button>' : 
                    '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>') +
                  (this.issueWizardStep < 6 ?
                    '<button type="button" class="btn btn-primary" onclick="app.nextWizardStep()" style="flex: 2" ' + (!canProceed ? 'disabled' : '') + '>Continue</button>' :
                    '<button type="button" class="btn btn-primary" onclick="app.submitWizardIssue()" style="flex: 2" ' + (!canProceed ? 'disabled' : '') + '>Submit Issue</button>') +
                '</div>' +
              '</div>' +
            '</div>';
          }
          
          // LEVEL 2/3 - Keep existing form with Quick/Full modes
          // QUICK MODE - Voice-first for rapid reporting
          if (this.voiceRecognition.quickFormMode) {
            return '<div class="modal-overlay" data-close-modal>' +
              '<div class="modal">' +
                '<div class="modal-header">' +
                  '<div class="modal-title">üé§ Quick Voice Report</div>' +
                  '<button class="btn" onclick="app.toggleFormMode()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: auto; margin-right: 0.5rem">‚öôÔ∏è Full</button>' +
                  '<button class="close-btn" data-close-modal>√ó</button>' +
                '</div>' +
                '<div class="info-box" style="background: #fff3cd; border: 2px solid #ffc107">' +
                  '<div style="font-weight: bold; margin-bottom: 0.5rem">üì¢ Quick Voice Mode</div>' +
                  '<div style="font-size: 0.9rem">Press the microphone button and describe the issue in one take. Speak naturally and include all details.</div>' +
                '</div>' +
                '<form id="issue-form">' +
                  '<div style="text-align: center; padding: 2rem; border: 3px dashed #000; margin: 1.5rem 0">' +
                    '<button type="button" class="btn voice-btn" id="quick-voice-btn" data-field="quick-voice-description" onclick="app.startQuickVoiceReport()" style="padding: 2rem 3rem; font-size: 1.5rem; background: #4CAF50; color: white; border: 3px solid #000; width: 50%; max-width: 400px">' +
                      'üé§ START VOICE REPORT' +
                    '</button>' +
                    '<div style="margin-top: 1rem; font-size: 0.85rem; color: #666">Click to start recording</div>' +
                  '</div>' +
                  '<div class="form-group">' +
                    '<label class="form-label">Voice Transcription</label>' +
                    '<textarea class="form-textarea" name="description" id="quick-voice-description" required style="min-height: 150px; background: #f9f9f9"></textarea>' +
                    '<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem">Your voice will be transcribed here automatically</div>' +
                  '</div>' +
                  '<div class="form-group">' +
                    '<label class="form-label">Date & Time (Auto-set)</label>' +
                    '<input type="datetime-local" class="form-input" name="datetime" value="' + currentDateTime + '" required style="background: #f0f0f0" />' +
                  '</div>' +
                  '<input type="hidden" name="title" value="Voice Report" />' +
                  '<input type="hidden" name="category" value="Other" />' +
                  '<input type="hidden" name="priority" value="MEDIUM" />' +
                  '<input type="hidden" name="subcategory" value="" />' +
                  '<input type="hidden" name="area" value="Shopfloor" />' +
                  '<input type="hidden" name="contact" value="' + (this.currentUser === 'level1' ? 'Team Member' : this.currentUser === 'level2' ? 'Area Leader' : 'Plant Manager') + '" />' +
                  '<input type="hidden" name="level" value="' + level + '" />' +
                  '<input type="hidden" name="shift" value="' + this.getCurrentShift() + '" />' +
                  '<div style="display: flex; gap: 1rem; margin-top: 1.5rem">' +
                    '<button type="submit" class="btn btn-primary" style="flex: 1">Submit Report</button>' +
                    '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                  '</div>' +
                '</form>' +
              '</div>' +
            '</div>';
          }
          
          // FULL MODE - Detailed form without voice
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Add New Issue</div>' +
                '<button class="btn" onclick="app.toggleFormMode()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: auto; margin-right: 0.5rem">üé§ Quick</button>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<form id="issue-form">' +
                '<div class="form-group">' +
                  '<label class="form-label">Issue Title</label>' +
                  '<input type="text" class="form-input" name="title" id="issue-title" required />' +
                '</div>' +
                '<div class="form-row">' +
                  '<div class="form-group">' +
                    '<label class="form-label">Category</label>' +
                    '<select class="form-select" name="category" required>' +
                      '<option value="">Select Category</option>' +
                      this.adminConfig.categories.map(cat => 
                        '<option value="' + cat + '">' + cat + '</option>'
                      ).join('') +
                    '</select>' +
                  '</div>' +
                  '<div class="form-group">' +
                    '<label class="form-label">Priority</label>' +
                    '<select class="form-select" name="priority" required>' +
                      '<option value="LOW">Low</option>' +
                      '<option value="MEDIUM">Medium</option>' +
                      '<option value="HIGH">High</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
                '<div class="form-row">' +
                  '<div class="form-group">' +
                    '<label class="form-label">Date & Time (Auto-set)</label>' +
                    '<input type="datetime-local" class="form-input" name="datetime" value="' + currentDateTime + '" required style="background: #f0f0f0" />' +
                  '</div>' +
                  '<div class="form-group">' +
                    '<label class="form-label">Subcategory</label>' +
                    '<input type="text" class="form-input" name="subcategory" id="issue-subcategory" placeholder="e.g., Belt System" />' +
                  '</div>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Area</label>' +
                  '<input type="text" class="form-input" name="area" id="issue-area" required />' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Description</label>' +
                  '<textarea class="form-textarea" name="description" id="issue-description" required></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Contact Person</label>' +
                  '<input type="text" class="form-input" name="contact" id="issue-contact" required />' +
                '</div>' +
                '<input type="hidden" name="level" value="' + level + '" />' +
                '<input type="hidden" name="shift" value="' + this.getCurrentShift() + '" />' +
                '<div id="ai-suggestion-box" style="display: none; margin-bottom: 1rem"></div>' +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Add Issue</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'escalate') {
          const issueId = parseInt(this.modalData);
          const issue = this.issues.find(i => i.id === issueId);
          const toLevel = issue.level === 1 ? 2 : issue.level + 1; // Level 1 can only go to Level 2
          const aiSuggestion = issue.aiSuggestion;
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Escalate Issue</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div class="info-box">' +
                '<div style="margin-bottom: 0.5rem"><strong>Issue ' + issueId + ':</strong> ' + issue.title + '</div>' +
                '<div>Escalating from Level ' + issue.level + ' to Level ' + toLevel + '</div>' +
                (issue.level === 1 ? '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666">Operators can only escalate to Shift Leader (Level 2)</div>' : '') +
              '</div>' +
              (aiSuggestion ? 
                '<div class="info-box" style="background: #e8f4fd; border: 2px solid #1d4ed8">' +
                  '<div class="info-box-title" style="color: #1d4ed8">ü§ñ AI Escalation Suggestion</div>' +
                  '<div style="margin-bottom: 0.5rem"><strong>Recommended Level:</strong> ' + aiSuggestion.suggestedLevel + '</div>' +
                  '<div style="margin-bottom: 0.5rem"><strong>Reason:</strong> ' + aiSuggestion.reason + '</div>' +
                  '<div><strong>Confidence:</strong> ' + aiSuggestion.confidence + '%</div>' +
                '</div>' : '') +
              '<form id="escalate-form">' +
                '<input type="hidden" name="issueId" value="' + issueId + '" />' +
                '<input type="hidden" name="toLevel" value="' + toLevel + '" />' +
                '<div class="form-group">' +
                  '<label class="form-label">Reason for Escalation</label>' +
                  '<textarea class="form-textarea" name="reason" required></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Actions Taken</label>' +
                  '<textarea class="form-textarea" name="actions"></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Support Needed</label>' +
                  '<textarea class="form-textarea" name="support"></textarea>' +
                '</div>' +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Escalate</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'resolve') {
          const issueId = parseInt(this.modalData);
          const issue = this.issues.find(i => i.id === issueId);
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Resolve Issue</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div class="info-box">' +
                '<div><strong>Issue ' + issueId + ':</strong> ' + issue.title + '</div>' +
              '</div>' +
              '<form id="resolve-form">' +
                '<input type="hidden" name="issueId" value="' + issueId + '" />' +
                '<div class="form-group">' +
                  '<label class="form-label">Root Cause</label>' +
                  '<textarea class="form-textarea" name="rootCause" required></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Corrective Actions</label>' +
                  '<textarea class="form-textarea" name="actions" required></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Preventive Measures</label>' +
                  '<textarea class="form-textarea" name="preventive" required></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Resolved By</label>' +
                  '<input type="text" class="form-input" name="resolvedBy" required />' +
                '</div>' +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Resolve</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'add-gemba-issue') {
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Add Gemba Walk Issue</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<form id="gemba-issue-form">' +
                '<div class="form-group">' +
                  '<label class="form-label">Issue Title</label>' +
                  '<input type="text" class="form-input" name="title" required />' +
                '</div>' +
                '<div class="form-row">' +
                  '<div class="form-group">' +
                    '<label class="form-label">Priority</label>' +
                    '<select class="form-select" name="priority" required>' +
                      '<option value="LOW">Low</option>' +
                      '<option value="MEDIUM">Medium</option>' +
                      '<option value="HIGH">High</option>' +
                    '</select>' +
                  '</div>' +
                  '<div class="form-group">' +
                    '<label class="form-label">Level</label>' +
                    '<select class="form-select" name="level" required>' +
                      '<option value="1">Level 1</option>' +
                      '<option value="2">Level 2</option>' +
                      '<option value="3">Level 3</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Area</label>' +
                  '<input type="text" class="form-input" name="area" required />' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Description</label>' +
                  '<textarea class="form-textarea" name="description" required></textarea>' +
                '</div>' +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Add Issue</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'safety-status') {
          const status = this.modalData.status;
          const statusText = status === 'safe' ? 'Safe - No Issues' : 
                            status === 'near-miss' ? 'Near Miss' : 'Safety Incident';
          const bgColor = status === 'safe' ? '#90EE90' : status === 'near-miss' ? '#FFD700' : '#FFB6C1';
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Report Safety Status</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div class="info-box" style="background: ' + bgColor + '">' +
                '<div style="font-weight: bold; font-size: 1.1rem">' + statusText + '</div>' +
                '<div style="margin-top: 0.5rem">Current Shift - ' + new Date().toLocaleDateString() + '</div>' +
              '</div>' +
              '<form id="safety-status-form">' +
                '<input type="hidden" name="status" value="' + status + '" />' +
                (status !== 'safe' ? 
                  '<div class="form-group">' +
                    '<label class="form-label">Description / Details *</label>' +
                    '<textarea class="form-textarea" name="notes" placeholder="Describe what happened and actions taken..." required></textarea>' +
                  '</div>' : 
                  '<div class="form-group">' +
                    '<label class="form-label">Optional Notes</label>' +
                    '<textarea class="form-textarea" name="notes" placeholder="Any observations or comments..."></textarea>' +
                  '</div>') +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Submit</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'add-workstation') {
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Add Workstation</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<form id="workstation-form">' +
                '<div class="form-group">' +
                  '<label class="form-label">Workstation ID</label>' +
                  '<input type="text" class="form-input" name="id" required placeholder="e.g., M-101" />' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Workstation Name</label>' +
                  '<input type="text" class="form-input" name="name" required placeholder="e.g., Assembly Line 1 - Station 1" />' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Area</label>' +
                  '<select class="form-select" name="area" required>' +
                    '<option value="">Select Area</option>' +
                    this.adminConfig.areas.map(area => '<option value="' + area + '">' + area + '</option>').join('') +
                  '</select>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Team</label>' +
                  '<select class="form-select" name="team" required>' +
                    '<option value="">Select Team</option>' +
                    this.adminConfig.teams.map(team => '<option value="' + team + '">' + team + '</option>').join('') +
                  '</select>' +
                '</div>' +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Add Workstation</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'edit-workstation') {
          const wsId = this.modalData;
          const ws = this.adminConfig.workstations.find(w => w.id === wsId);
          if (!ws) return '';
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Edit Workstation</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<form id="edit-workstation-form">' +
                '<input type="hidden" name="original-id" value="' + ws.id + '" />' +
                '<div class="form-group">' +
                  '<label class="form-label">Workstation ID</label>' +
                  '<input type="text" class="form-input" name="id" required value="' + ws.id + '" />' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Workstation Name</label>' +
                  '<input type="text" class="form-input" name="name" required value="' + ws.name + '" />' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Area</label>' +
                  '<select class="form-select" name="area" required>' +
                    this.adminConfig.areas.map(area => 
                      '<option value="' + area + '" ' + (area === ws.area ? 'selected' : '') + '>' + area + '</option>'
                    ).join('') +
                  '</select>' +
                '</div>' +
                '<div class="form-group">' +
                  '<label class="form-label">Team</label>' +
                  '<select class="form-select" name="team" required>' +
                    this.adminConfig.teams.map(team => 
                      '<option value="' + team + '" ' + (team === ws.team ? 'selected' : '') + '>' + team + '</option>'
                    ).join('') +
                  '</select>' +
                '</div>' +
                '<div style="display: flex; gap: 1rem">' +
                  '<button type="submit" class="btn btn-primary" style="flex: 1">Update Workstation</button>' +
                  '<button type="button" class="btn" data-close-modal style="flex: 1">Cancel</button>' +
                '</div>' +
              '</form>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'issue-detail') {
          const issueId = parseInt(this.modalData);
          const issue = this.issues.find(i => i.id === issueId);
          if (!issue) return '';
          
          // Calculate resolution time if resolved
          let resolutionTime = 'Not resolved yet';
          if (issue.status === 'RESOLVED' && issue.resolvedDate) {
            const created = new Date(issue.dateCreated + ' ' + issue.time);
            const resolved = new Date(issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00'));
            const hours = ((resolved - created) / (1000 * 60 * 60)).toFixed(1);
            const days = Math.floor(hours / 24);
            const remainingHours = (hours % 24).toFixed(1);
            resolutionTime = days > 0 ? days + ' days, ' + remainingHours + ' hours' : hours + ' hours';
          }
          
          // Build change history
          const changeHistory = [];
          changeHistory.push({
            timestamp: issue.dateCreated + ' ' + issue.time,
            action: 'Issue Created',
            details: 'Created by ' + issue.contact + ' at Level ' + issue.level,
            user: issue.contact
          });
          
          if (issue.escalatedFrom) {
            changeHistory.push({
              timestamp: issue.dateCreated + ' (later)',
              action: 'Escalated',
              details: 'From Level ' + issue.escalatedFrom + ' to Level ' + issue.level,
              user: 'System',
              reason: issue.escalationReason || 'N/A'
            });
          }
          
          if (issue.status === 'RESOLVED') {
            changeHistory.push({
              timestamp: issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00'),
              action: 'Resolved',
              details: issue.resolution || 'Issue resolved',
              user: issue.resolvedBy || 'Unknown'
            });
          }
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal" style="max-width: 900px">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Issue #' + issue.id + ' - Complete History</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div style="max-height: 600px; overflow-y: auto">' +
                '<div class="info-box" style="margin-bottom: 1.5rem">' +
                  '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">' +
                    '<div><strong>Status:</strong> ' + issue.status + '</div>' +
                    '<div><strong>Priority:</strong> ' + issue.priority + '</div>' +
                    '<div><strong>Category:</strong> ' + issue.category + '</div>' +
                    '<div><strong>Source:</strong> ' + (issue.source === 'gemba' ? 'Gemba Walk' : 'Production') + '</div>' +
                    '<div><strong>Created:</strong> ' + issue.dateCreated + ' ' + issue.time + '</div>' +
                    '<div><strong>Current Level:</strong> Level ' + issue.level + '</div>' +
                  '</div>' +
                '</div>' +
                '<div style="margin-bottom: 1.5rem">' +
                  '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Issue Details</div>' +
                  '<div style="padding: 1rem; border: 2px solid #000; background: #fafafa">' +
                    '<div style="font-weight: bold; margin-bottom: 0.5rem">' + issue.title + '</div>' +
                    '<div style="margin-bottom: 0.5rem"><strong>Area:</strong> ' + issue.area + '</div>' +
                    '<div style="margin-bottom: 0.5rem"><strong>Description:</strong></div>' +
                    '<div style="padding: 0.5rem; background: #fff; border: 1px solid #000">' + issue.description + '</div>' +
                    (issue.subcategory ? '<div style="margin-top: 0.5rem"><strong>Subcategory:</strong> ' + issue.subcategory + '</div>' : '') +
                  '</div>' +
                '</div>' +
                (issue.escalatedFrom ? 
                  '<div style="margin-bottom: 1.5rem">' +
                    '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Escalation Information</div>' +
                    '<div style="padding: 1rem; border: 2px solid #000">' +
                      '<div style="margin-bottom: 0.5rem"><strong>Escalation Path:</strong> Level ' + issue.escalatedFrom + ' ‚Üí Level ' + issue.level + '</div>' +
                      '<div style="margin-bottom: 0.5rem"><strong>Reason:</strong> ' + (issue.escalationReason || 'N/A') + '</div>' +
                      (issue.actionsTaken ? '<div style="margin-bottom: 0.5rem"><strong>Actions Taken:</strong> ' + issue.actionsTaken + '</div>' : '') +
                      (issue.supportNeeded ? '<div><strong>Support Needed:</strong> ' + issue.supportNeeded + '</div>' : '') +
                    '</div>' +
                  '</div>' : '') +
                (issue.status === 'RESOLVED' ? 
                  '<div style="margin-bottom: 1.5rem">' +
                    '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Resolution Information</div>' +
                    '<div style="padding: 1rem; border: 2px solid #000; background: #f0f0f0">' +
                      '<div style="margin-bottom: 0.5rem"><strong>Resolved By:</strong> ' + (issue.resolvedBy || 'Unknown') + '</div>' +
                      '<div style="margin-bottom: 0.5rem"><strong>Resolution Date:</strong> ' + issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00') + '</div>' +
                      '<div style="margin-bottom: 0.5rem"><strong>Resolution Time:</strong> ' + resolutionTime + '</div>' +
                      '<div style="margin-bottom: 0.5rem"><strong>Resolution:</strong></div>' +
                      '<div style="padding: 0.5rem; background: #fff; border: 1px solid #000">' + (issue.resolution || 'N/A') + '</div>' +
                      (issue.impact ? 
                        '<div style="margin-top: 1rem">' +
                          '<div style="font-weight: bold; margin-bottom: 0.5rem">Impact Quantification:</div>' +
                          '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem">' +
                            (issue.impact.downtimePrevented ? '<div style="padding: 0.5rem; border: 1px solid #000; text-align: center"><div style="font-size: 0.75rem; color: #666">Downtime Saved</div><div style="font-weight: bold">' + issue.impact.downtimePrevented + ' min</div></div>' : '') +
                            (issue.impact.defectsReduced ? '<div style="padding: 0.5rem; border: 1px solid #000; text-align: center"><div style="font-size: 0.75rem; color: #666">Defects Reduced</div><div style="font-weight: bold">' + issue.impact.defectsReduced + '</div></div>' : '') +
                            (issue.impact.costSavings ? '<div style="padding: 0.5rem; border: 1px solid #000; text-align: center"><div style="font-size: 0.75rem; color: #666">Cost Savings</div><div style="font-weight: bold">$' + issue.impact.costSavings.toLocaleString() + '</div></div>' : '') +
                          '</div>' +
                        '</div>' : '') +
                    '</div>' +
                  '</div>' : '') +
                '<div style="margin-bottom: 1.5rem">' +
                  '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Change History</div>' +
                  '<div style="border: 2px solid #000">' +
                    changeHistory.map((change, idx) => 
                      '<div style="padding: 1rem; border-bottom: ' + (idx < changeHistory.length - 1 ? '1px solid #ccc' : 'none') + '">' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem">' +
                          '<div style="font-weight: bold">' + change.action + '</div>' +
                          '<div style="font-size: 0.85rem; color: #666">' + change.timestamp + '</div>' +
                        '</div>' +
                        '<div style="font-size: 0.9rem">' + change.details + '</div>' +
                        '<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem">by ' + change.user + '</div>' +
                        (change.reason ? '<div style="margin-top: 0.5rem; padding: 0.5rem; background: #fafafa; border: 1px solid #ccc; font-size: 0.85rem"><strong>Reason:</strong> ' + change.reason + '</div>' : '') +
                      '</div>'
                    ).join('') +
                  '</div>' +
                '</div>' +
                (issue.aiSuggestion ? 
                  '<div style="margin-bottom: 1.5rem">' +
                    '<div style="font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">AI Analysis</div>' +
                    '<div style="padding: 1rem; border: 2px solid #000">' +
                      '<div style="margin-bottom: 0.5rem"><strong>Suggested Level:</strong> Level ' + issue.aiSuggestion.suggestedLevel + '</div>' +
                      '<div style="margin-bottom: 0.5rem"><strong>Confidence:</strong> ' + issue.aiSuggestion.confidence + '%</div>' +
                      '<div><strong>Reasoning:</strong> ' + issue.aiSuggestion.reason + '</div>' +
                    '</div>' +
                  '</div>' : '') +
              '</div>' +
              '<div style="margin-top: 1rem">' +
                '<button class="btn btn-primary" data-close-modal>Close</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'gemba-metrics-detail') {
          const gembaIssues = this.issues.filter(i => i.source === 'gemba');
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal" style="max-width: 900px">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Gemba Walk Effectiveness - Detailed Report</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div style="max-height: 600px; overflow-y: auto">' +
                '<div style="font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #000">Issues Identified from Gemba Walks</div>' +
                '<table class="data-table">' +
                  '<thead><tr>' +
                    '<th>Date</th>' +
                    '<th>Title</th>' +
                    '<th>Area</th>' +
                    '<th>Status</th>' +
                    '<th>Resolution Time</th>' +
                    '<th>Impact</th>' +
                  '</tr></thead>' +
                  '<tbody>' +
                    (gembaIssues.length === 0 ? 
                      '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666">No Gemba Walk issues recorded</td></tr>' :
                      gembaIssues.map(issue => {
                        let resolutionTime = '-';
                        if (issue.status === 'RESOLVED' && issue.resolvedDate) {
                          const created = new Date(issue.dateCreated + ' ' + issue.time);
                          const resolved = new Date(issue.resolvedDate + ' ' + (issue.resolvedTime || '12:00'));
                          const hoursDiff = ((resolved - created) / (1000 * 60 * 60)).toFixed(1);
                          resolutionTime = hoursDiff + 'h';
                        }
                        
                        const impactText = issue.impact ? 
                          (issue.impact.downtimePrevented ? issue.impact.downtimePrevented + 'min saved, ' : '') +
                          (issue.impact.defectsReduced ? issue.impact.defectsReduced + ' defects, ' : '') +
                          (issue.impact.costSavings ? '$' + issue.impact.costSavings : '') : 
                          'Not quantified';
                        
                        return '<tr>' +
                          '<td>' + issue.dateCreated + '</td>' +
                          '<td><strong>' + issue.title + '</strong></td>' +
                          '<td>' + issue.area + '</td>' +
                          '<td>' + issue.status + '</td>' +
                          '<td>' + resolutionTime + '</td>' +
                          '<td style="font-size: 0.85rem">' + impactText + '</td>' +
                        '</tr>';
                      }).join('')
                    ) +
                  '</tbody>' +
                '</table>' +
              '</div>' +
              '<div style="margin-top: 1rem">' +
                '<button class="btn btn-primary" data-close-modal>Close</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'manage-parts') {
          const hour = this.modalData;
          const savedData = this.getProductionData(this.currentMachine);
          const hourData = savedData.find(d => d.hour === parseInt(hour));
          const partNumbers = hourData && hourData.partNumbers ? hourData.partNumbers : [];
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Manage Part Numbers - Hour ' + hour + ':00</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div style="margin-bottom: 1rem">' +
                '<label class="form-label">Add Part Number</label>' +
                '<div style="display: flex; gap: 0.5rem">' +
                  '<input type="text" class="form-input" id="new-part-input" placeholder="e.g., P-123-A" style="flex: 1" />' +
                  '<button class="btn btn-primary" onclick="app.addPartNumber(' + hour + ', document.getElementById(\'new-part-input\').value)">+ Add</button>' +
                '</div>' +
              '</div>' +
              '<div class="form-label" style="margin-bottom: 0.5rem">Part Numbers for this Hour:</div>' +
              (partNumbers.length === 0 ? 
                '<div class="empty-state" style="padding: 1rem; border: 2px dashed #ccc">No part numbers added yet</div>' :
                '<div style="display: flex; flex-direction: column; gap: 0.5rem">' +
                  partNumbers.map((part, idx) => 
                    '<div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border: 2px solid #000; background: #fafafa">' +
                      '<strong>' + part + '</strong>' +
                      '<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #000; color: white" onclick="app.removePartNumber(' + hour + ', ' + idx + ')">Remove</button>' +
                    '</div>'
                  ).join('') +
                '</div>'
              ) +
              '<div style="display: flex; gap: 1rem; margin-top: 1rem">' +
                '<button class="btn btn-primary" data-close-modal style="flex: 1">Done</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
        
        if (this.showModal === 'delete-workstation') {
          const wsId = this.modalData;
          const ws = this.adminConfig.workstations.find(w => w.id === wsId);
          if (!ws) return '';
          
          return '<div class="modal-overlay" data-close-modal>' +
            '<div class="modal">' +
              '<div class="modal-header">' +
                '<div class="modal-title">Delete Workstation</div>' +
                '<button class="close-btn" data-close-modal>√ó</button>' +
              '</div>' +
              '<div style="padding: 1rem; background: #f0f0f0; border: 2px solid #000; margin-bottom: 1rem">' +
                '<strong>Warning:</strong> Are you sure you want to delete this workstation?' +
              '</div>' +
              '<div class="info-box">' +
                '<div><strong>ID:</strong> ' + ws.id + '</div>' +
                '<div><strong>Name:</strong> ' + ws.name + '</div>' +
                '<div><strong>Area:</strong> ' + ws.area + '</div>' +
              '</div>' +
              '<div style="display: flex; gap: 1rem; margin-top: 1rem">' +
                '<button class="btn btn-primary" style="flex: 1" onclick="app.deleteWorkstation(\'' + ws.id + '\')">Confirm Delete</button>' +
                '<button class="btn" data-close-modal style="flex: 1">Cancel</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
        
        return '';
      },
      
      attachEventListeners() {
        // Language selector (login and sidebar)
        const languageSelector = document.getElementById('language-selector');
        if (languageSelector) {
          languageSelector.addEventListener('change', (e) => {
            this.setLanguage(e.target.value);
          });
        }
        
        const sidebarLanguageSelector = document.getElementById('sidebar-language-selector');
        if (sidebarLanguageSelector) {
          sidebarLanguageSelector.addEventListener('change', (e) => {
            this.setLanguage(e.target.value);
          });
        }
        
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
          loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.login('level3');
          });
        }
        
        document.querySelectorAll('[data-role]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.login(e.currentTarget.dataset.role);
          });
        });
        
        document.querySelectorAll('[data-action="logout"]').forEach(btn => {
          btn.addEventListener('click', () => this.logout());
        });
        
        document.querySelectorAll('[data-view]').forEach(btn => {
          if (!btn.classList.contains('disabled')) {
            btn.addEventListener('click', (e) => {
              this.setView(e.currentTarget.dataset.view);
            });
          }
        });
        
        document.querySelectorAll('[data-modal]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const modal = e.currentTarget.dataset.modal;
            const data = e.currentTarget.dataset.issueId || e.currentTarget.dataset.level || e.currentTarget.dataset.wsId || e.currentTarget.dataset.hour;
            this.openModal(modal, data);
          });
        });
        
        document.querySelectorAll('[data-close-modal]').forEach(el => {
          el.addEventListener('click', (e) => {
            if (e.target === e.currentTarget || e.currentTarget.classList.contains('close-btn')) {
              this.closeModal();
            }
          });
        });
        
        document.querySelectorAll('[data-action="mark-safety"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const status = e.currentTarget.dataset.status;
            this.openModal('safety-status', { status: status });
          });
        });
        
        const issueForm = document.getElementById('issue-form');
        if (issueForm) {
          issueForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Extract date and time from datetime-local field
            const datetime = formData.get('datetime');
            let time = '';
            if (datetime) {
              const dt = new Date(datetime);
              time = String(dt.getHours()).padStart(2, '0') + ':' + String(dt.getMinutes()).padStart(2, '0');
            }
            
            this.addIssue({
              level: parseInt(formData.get('level')),
              title: formData.get('title'),
              category: formData.get('category'),
              subcategory: formData.get('subcategory'),
              area: formData.get('area'),
              time: time,
              datetime: datetime,
              shift: formData.get('shift'),
              priority: formData.get('priority'),
              description: formData.get('description'),
              contact: formData.get('contact')
            });
          });
        }
        
        const escalateForm = document.getElementById('escalate-form');
        if (escalateForm) {
          escalateForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            this.escalateIssue(
              parseInt(formData.get('issueId')),
              parseInt(formData.get('toLevel')),
              {
                reason: formData.get('reason'),
                actions: formData.get('actions'),
                support: formData.get('support')
              }
            );
          });
        }
        
        const resolveForm = document.getElementById('resolve-form');
        if (resolveForm) {
          resolveForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const resolution = 'ROOT CAUSE: ' + formData.get('rootCause') + 
              '\n\nCORRECTIVE ACTIONS: ' + formData.get('actions') +
              '\n\nPREVENTIVE MEASURES: ' + formData.get('preventive');
            this.resolveIssue(
              parseInt(formData.get('issueId')),
              {
                resolution: resolution,
                resolvedBy: formData.get('resolvedBy')
              }
            );
          });
        }
        
        const gembaIssueForm = document.getElementById('gemba-issue-form');
        if (gembaIssueForm) {
          gembaIssueForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            this.addGembaIssue({
              title: formData.get('title'),
              priority: formData.get('priority'),
              level: parseInt(formData.get('level')),
              area: formData.get('area'),
              description: formData.get('description'),
              time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
              shift: 'Day',
              contact: this.gembaWalkData.participants
            });
          });
        }
        
        const safetyStatusForm = document.getElementById('safety-status-form');
        if (safetyStatusForm) {
          safetyStatusForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const today = new Date().toISOString().split('T')[0];
            
            this.safetyCross.entries.push({
              date: today,
              shift: this.getCurrentShift(),
              status: formData.get('status'),
              team: 'Team A',
              area: 'Assembly Line 1',
              notes: formData.get('notes') || ''
            });
            
            this.closeModal();
          });
        }
        
        // Workstation management forms
        const workstationForm = document.getElementById('workstation-form');
        if (workstationForm) {
          workstationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            this.adminConfig.workstations.push({
              id: formData.get('id'),
              name: formData.get('name'),
              area: formData.get('area'),
              team: formData.get('team')
            });
            this.closeModal();
          });
        }
        
        const editWorkstationForm = document.getElementById('edit-workstation-form');
        if (editWorkstationForm) {
          editWorkstationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const originalId = formData.get('original-id');
            const index = this.adminConfig.workstations.findIndex(w => w.id === originalId);
            if (index !== -1) {
              this.adminConfig.workstations[index] = {
                id: formData.get('id'),
                name: formData.get('name'),
                area: formData.get('area'),
                team: formData.get('team')
              };
            }
            this.closeModal();
          });
        }
        
        // Save shift data handler
        const saveShiftBtn = document.getElementById('save-shift-data');
        if (saveShiftBtn) {
          saveShiftBtn.addEventListener('click', () => {
            const machineId = this.currentMachine;
            if (!machineId) return;
            
            // Collect all hourly data from inputs
            const targetInputs = document.querySelectorAll('.hour-target');
            const actualInputs = document.querySelectorAll('.hour-actual');
            const partsInputs = document.querySelectorAll('.hour-parts');
            const notesInputs = document.querySelectorAll('.hour-notes');
            
            if (!this.productionData[machineId]) {
              this.productionData[machineId] = [];
            }
            
            targetInputs.forEach((input, idx) => {
              const hour = parseInt(input.dataset.hour);
              const target = parseInt(input.value) || 0;
              const actual = parseInt(actualInputs[idx].value) || 0;
              const partsText = partsInputs[idx].value.trim();
              const partNumbers = partsText ? partsText.split(',').map(p => p.trim()).filter(p => p) : [];
              const notes = notesInputs[idx].value;
              
              let hourData = this.productionData[machineId].find(d => d.hour === hour);
              if (!hourData) {
                hourData = { hour, target: 100, actual: 0, partNumbers: [], notes: '' };
                this.productionData[machineId].push(hourData);
              }
              
              hourData.target = target;
              hourData.actual = actual;
              hourData.partNumbers = partNumbers;
              hourData.notes = notes;
            });
            
            alert('Shift data saved successfully!');
            this.render();
          });
        }
        
        // Issue history filter handlers
        const statusFilter = document.getElementById('history-filter-status');
        const sourceFilter = document.getElementById('history-filter-source');
        const categoryFilter = document.getElementById('history-filter-category');
        
        if (statusFilter && sourceFilter && categoryFilter) {
          const applyFilters = () => {
            const statusValue = statusFilter.value;
            const sourceValue = sourceFilter.value;
            const categoryValue = categoryFilter.value;
            
            const rows = document.querySelectorAll('[data-issue-status]');
            rows.forEach(row => {
              const matchStatus = !statusValue || row.dataset.issueStatus === statusValue;
              const matchSource = !sourceValue || row.dataset.issueSource === sourceValue;
              const matchCategory = !categoryValue || row.dataset.issueCategory === categoryValue;
              
              if (matchStatus && matchSource && matchCategory) {
                row.style.display = '';
              } else {
                row.style.display = 'none';
              }
            });
          };
          
          statusFilter.addEventListener('change', applyFilters);
          sourceFilter.addEventListener('change', applyFilters);
          categoryFilter.addEventListener('change', applyFilters);
        }
        
        // Gemba Walk navigation handlers - Use flag to prevent duplicate attachment
        if (!this._gembaHandlerAttached) {
          this._gembaHandlerAttached = true;
          console.log('Gemba handler attached for the first time');
          
          document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action^="gemba-"]');
            if (!btn) return;
            
            const action = btn.dataset.action;
            console.log('Gemba button clicked:', action, 'Current step:', this.gembaWalkStep);
            
            if (action === 'gemba-next') {
              // Validate current step before advancing
              let canProceed = false;
              
              console.log('Processing gemba-next for step:', this.gembaWalkStep);
              
              switch(this.gembaWalkStep) {
                case 1: // Initiation - require target areas
                  console.log('Validating step 1');
                  const targetAreas = document.getElementById('targetAreas')?.value;
                  const focus = document.getElementById('focus')?.value;
                  const participants = document.getElementById('participants')?.value;
                  
                  if (!targetAreas || !focus || !participants) {
                    alert('Please fill in all required fields:\n- Target Areas\n- Focus/Objectives\n- Participants');
                    return;
                  }
                  
                  // Save step 1 data
                  this.gembaWalkData.targetAreas = targetAreas;
                  this.gembaWalkData.focus = focus;
                  this.gembaWalkData.participants = participants;
                  canProceed = true;
                  console.log('Step 1 validated, canProceed:', canProceed);
                  break;
                
                case 2: // Observation - checklist completion not required but recommended
                  console.log('Validating step 2');
                  canProceed = true;
                  console.log('Step 2 validated, canProceed:', canProceed);
                  break;
                
                case 3: // Documentation - require findings
                  console.log('Validating step 3');
                  const findings = document.getElementById('findings')?.value;
                  
                  if (!findings || findings.trim().length < 10) {
                    alert('Please document your observations and findings (minimum 10 characters).');
                    return;
                  }
                  
                  // Save step 3 data
                  this.gembaWalkData.findings = findings;
                  const teamFeedback = document.getElementById('teamFeedback')?.value || '';
                  this.gembaWalkData.teamFeedback = teamFeedback;
                  canProceed = true;
                  console.log('Step 3 validated, canProceed:', canProceed);
                  break;
                
                case 4: // Issues - can proceed even without adding issues
                  console.log('Validating step 4');
                  canProceed = true;
                  console.log('Step 4 validated, canProceed:', canProceed);
                  break;
                
                case 5: // Report - final step
                  console.log('Step 5 - cannot proceed further');
                  canProceed = false; // No next from step 5
                  break;
              }
              
              console.log('Before increment - canProceed:', canProceed, 'currentStep:', this.gembaWalkStep);
              
              if (canProceed && this.gembaWalkStep < 5) {
                this.gembaWalkStep++;
                console.log('Incremented to step:', this.gembaWalkStep);
                this.render();
              } else {
                console.log('Did not increment - canProceed:', canProceed, 'step:', this.gembaWalkStep);
              }
            } else if (action === 'gemba-prev') {
              // Allow going back to any previous step
              console.log('Going back from step:', this.gembaWalkStep);
              if (this.gembaWalkStep > 1) {
                this.gembaWalkStep--;
                console.log('Decremented to step:', this.gembaWalkStep);
                this.render();
              }
            } else if (action === 'gemba-complete') {
              console.log('Completing Gemba Walk');
              // Complete the walk and save to completed array
              const now = new Date();
              const completedWalk = {
                id: (this.gembaWalkData.completed?.length || 0) + 1,
                date: now.toISOString().split('T')[0],
                leader: this.currentUser === 'level2' ? 'Area Leader' : 'Plant Manager',
                area: this.gembaWalkData.targetAreas,
                duration: 0, // Could be calculated if we track start time
                issuesFound: this.gembaWalkData.issues.length
              };
              
              if (!this.gembaWalkData.completed) {
                this.gembaWalkData.completed = [];
              }
              this.gembaWalkData.completed.push(completedWalk);
              
              // Reset for next walk
              this.gembaWalkStep = 1;
              this.gembaWalkData.targetAreas = '';
              this.gembaWalkData.focus = '';
              this.gembaWalkData.participants = '';
              this.gembaWalkData.findings = [];
              this.gembaWalkData.issues = [];
              this.gembaWalkData.teamFeedback = '';
              
              alert('Gemba Walk completed successfully!\n\nIssues found: ' + completedWalk.issuesFound);
              this.render();
            }
          });
        } else {
          console.log('Gemba handler already attached, skipping');
        }
      }
    };

    app.init();
    
    // Force reflow for mobile
    window.setTimeout(function() {
      if (!app.currentUser) {
        console.log('Retrying initialization...');
        app.init();
      }
    }, 100);
    
    // Handle page load errors
    window.addEventListener('error', function(e) {
      console.error('Error loading app:', e.message);
    });
    
    // Ensure app runs after DOM is fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        if (!app.currentUser) {
          app.init();
        }
      });
    }
  </script>
</body>
</html>
